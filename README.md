# å­¦ä¹  Solidity å®Œæˆä¸€ä¸ª CryptoZombie æ¸¸æˆé¡¹ç›®

> æœ¬æ•™ç¨‹åªæ˜¯æŠŠ https://cryptozombies.io/zh ç½‘ç«™ä¸­çš„æ•™ç¨‹æ‘˜å½•ä¸‹æ¥ï¼Œç”¨äºå­¦ä¹ å›é¡¾ï¼Œå…·ä½“å®æ“è¯·åœ¨ç½‘ç«™ä¸Šå­¦ä¹ å®è·µï¼Œé…Œæƒ…å‚è€ƒã€‚



## 1. å¼€å§‹ä¸€ä¸ªä¸­çº§çš„æ™ºèƒ½åˆçº¦

ä½ è®¤ä¸ºä½ å¯ä»¥å½“ä¸€ä¸ªåˆæ ¼çš„ **CryptoZombie**, å—¯ï¼Ÿ

è¿™ä¸ªæ•™ç¨‹ä¼šæ•™ä½ å¦‚ä½•æ­å»ºä¸€ä¸ª**ä»¥å¤ªç½‘çš„æ¸¸æˆ**ã€‚

æ­¤è¯¾ç¨‹ä¸º Solidity åˆå­¦è€…è®¾è®¡ï¼Œéœ€è¦ä½ å¯¹å…¶ä»–çš„ç¨‹åºè¯­è¨€æœ‰æ‰€äº†è§£ï¼ˆå¦‚ JavaScript)ã€‚

### 1.1 æ­å»ºåƒµå°¸å·¥å‚

#### ç¬¬1ç«  æ¦‚è¿°

ç¬¬ä¸€è¯¾ä½ å°†åˆ›é€ ä¸€ä¸ª"åƒµå°¸å·¥å‚"ï¼Œ ç”¨å®ƒå»ºç«‹ä¸€æ”¯åƒµå°¸éƒ¨é˜Ÿã€‚

- æˆ‘ä»¬çš„å·¥å‚ä¼šæŠŠæˆ‘ä»¬éƒ¨é˜Ÿä¸­æ‰€æœ‰çš„åƒµå°¸ä¿å­˜åˆ°æ•°æ®åº“ä¸­
- å·¥å‚ä¼šæœ‰ä¸€ä¸ªå‡½æ•°èƒ½äº§ç”Ÿæ–°çš„åƒµå°¸
- æ¯ä¸ªåƒµå°¸ä¼šæœ‰ä¸€ä¸ªéšæœºçš„ç‹¬ä¸€æ— äºŒçš„é¢å­”

åœ¨åé¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬ä¼šå¢åŠ åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œè®©åƒµå°¸èƒ½æ”»å‡»äººç±»æˆ–å…¶å®ƒåƒµå°¸! ä½†æ˜¯åœ¨å®ç°è¿™äº›å¥½ç©çš„åŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦å®ç°åˆ›å»ºåƒµå°¸è¿™æ ·çš„åŸºæœ¬åŠŸèƒ½ã€‚

##### åƒµå°¸ DNA å¦‚ä½•è¿ä½œ

åƒµå°¸çš„é¢å­”å–å†³äºå®ƒçš„DNAã€‚å®ƒçš„DNAå¾ˆç®€å•ï¼Œç”±ä¸€ä¸ª16ä½çš„æ•´æ•°ç»„æˆï¼š

``` bash
8356281049284737
```

å¦‚åŒçœŸæ­£çš„DNA, è¿™ä¸ªæ•°å­—çš„ä¸åŒéƒ¨åˆ†ä¼šå¯¹åº”ä¸åŒçš„ç‰¹ç‚¹ã€‚ å‰2ä½ä»£è¡¨å¤´å‹ï¼Œç´§æ¥ç€çš„2ä½ä»£è¡¨çœ¼ç›ï¼Œç­‰ç­‰ã€‚

> *æ³¨: æœ¬æ•™ç¨‹æˆ‘ä»¬å°½é‡ç®€åŒ–ã€‚æˆ‘ä»¬çš„åƒµå°¸åªæœ‰7ç§å¤´å‹(è™½ç„¶2ä½æ•°å­—å…è®¸100ç§å¯èƒ½æ€§)ã€‚ä»¥åæˆ‘ä»¬ä¼šåŠ å…¥æ›´å¤šçš„å¤´å‹, å¦‚æœæˆ‘ä»¬æƒ³è®©åƒµå°¸æœ‰æ›´å¤šé€ å‹ã€‚*

ä¾‹å¦‚ï¼Œå‰ä¸¤ä½æ•°å­—æ˜¯ `83`ï¼Œ è®¡ç®—åƒµå°¸çš„å¤´å‹ï¼Œæˆ‘ä»¬åš`83 % 7 + 1` = 7 è¿ç®—ï¼Œ æ­¤åƒµå°¸å°†è¢«èµ‹äºˆç¬¬ä¸ƒç±»å¤´å‹ã€‚

åœ¨å³è¾¹é¡µé¢ï¼Œç§»åŠ¨å¤´åŸºå› `head gene` æ»‘å—åˆ°ç¬¬ä¸ƒä½ç½®(åœ£è¯å¸½)å¯è§`83`æ‰€å¯¹åº”çš„ç‰¹ç‚¹ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. ç©ä¸€ä¸‹é¡µé¢å³ä¾§çš„æ»‘å—ã€‚æ£€éªŒä¸€ä¸‹ä¸åŒçš„æ•°å­—å¯¹åº”ä¸åŒçš„åƒµå°¸çš„é•¿ç›¸ã€‚

å¥½äº†ï¼Œè¿™å·²ç»è¶³å¤Ÿä½ ç©ä¸€ä¼šå„¿äº†ã€‚ å½“ä½ æƒ³ç»§ç»­çš„æ—¶å€™ï¼Œç‚¹å‡»ä¸‹é¢çš„"ä¸‹ä¸€ç« "ï¼Œè®©æˆ‘ä»¬æ¥é’»ç ” Solidity ï¼

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/04/28/20220428104132.png" align="center" style="width:500px" />



#### ç¬¬2ç«  åˆçº¦

ä»æœ€åŸºæœ¬çš„å¼€å§‹å…¥æ‰‹:

Solidity çš„ä»£ç éƒ½åŒ…è£¹åœ¨**åˆçº¦**é‡Œé¢. ä¸€ä»½`åˆçº¦`å°±æ˜¯ä»¥å¤ªåº”å¸åº”ç”¨çš„åŸºæœ¬æ¨¡å—ï¼Œ æ‰€æœ‰çš„å˜é‡å’Œå‡½æ•°éƒ½å±äºä¸€ä»½åˆçº¦, å®ƒæ˜¯ä½ æ‰€æœ‰åº”ç”¨çš„èµ·ç‚¹.

ä¸€ä»½åä¸º `HelloWorld` çš„ç©ºåˆçº¦å¦‚ä¸‹:

``` solidity
contract HelloWorld {

}
```

##### ç‰ˆæœ¬æŒ‡ä»¤

æ‰€æœ‰çš„ Solidity æºç éƒ½å¿…é¡»å† ä»¥ "version pragma" â€” æ ‡æ˜ Solidity ç¼–è¯‘å™¨çš„ç‰ˆæœ¬. ä»¥é¿å…å°†æ¥æ–°çš„ç¼–è¯‘å™¨å¯èƒ½ç ´åä½ çš„ä»£ç ã€‚

ä¾‹å¦‚: `pragma solidity ^0.4.19;` (å½“å‰ Solidity çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ 0.4.19).

ç»¼ä¸Šæ‰€è¿°ï¼Œ ä¸‹é¢å°±æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„åˆçº¦ â€” æ¯æ¬¡å»ºç«‹ä¸€ä¸ªæ–°çš„é¡¹ç›®æ—¶çš„ç¬¬ä¸€æ®µä»£ç :

``` solidity
pragma solidity ^0.4.19;

contract HelloWorld {

}
```

##### å®æˆ˜æ¼”ä¹ 

ä¸ºäº†å»ºç«‹æˆ‘ä»¬çš„åƒµå°¸éƒ¨é˜Ÿï¼Œ è®©æˆ‘ä»¬å…ˆå»ºç«‹ä¸€ä¸ªåŸºç¡€åˆçº¦ï¼Œç§°ä¸º `ZombieFactory`ã€‚

1. åœ¨å³è¾¹çš„è¾“å…¥æ¡†é‡Œè¾“å…¥ `0.4.19`ï¼Œæˆ‘ä»¬çš„åˆçº¦åŸºäºè¿™ä¸ªç‰ˆæœ¬çš„ç¼–è¯‘å™¨ã€‚
2. å»ºç«‹ä¸€ä¸ªç©ºåˆçº¦ `ZombieFactory`ã€‚

ä¸€åˆ‡å®Œæ¯•ï¼Œä¸‹é¢ "ç­”æ¡ˆ" ï¼š

``` solidity
pragma solidity ^0.4.19; //1. è¿™é‡Œå†™ç‰ˆæœ¬æŒ‡ä»¤

//2. è¿™é‡Œå»ºç«‹æ™ºèƒ½åˆçº¦
contract ZombieFactory {
}
```



#### ç¬¬3ç«  çŠ¶æ€å˜é‡å’Œæ•´æ•°

çœŸæ£’ï¼æˆ‘ä»¬å·²ç»ä¸ºæˆ‘ä»¬çš„åˆçº¦åšäº†ä¸€ä¸ªå¤–å£³ï¼Œ ä¸‹é¢å­¦ä¹  Solidity ä¸­å¦‚ä½•ä½¿ç”¨å˜é‡ã€‚

##### çŠ¶æ€å˜é‡

***çŠ¶æ€å˜é‡*** æ˜¯è¢«æ°¸ä¹…åœ°ä¿å­˜åœ¨åˆçº¦ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´å®ƒä»¬è¢«å†™å…¥ä»¥å¤ªå¸åŒºå—é“¾ä¸­. æƒ³è±¡æˆå†™å…¥ä¸€ä¸ªæ•°æ®åº“ã€‚

ä¾‹å­ï¼š

``` solidity
contract Example {
  // è¿™ä¸ªæ— ç¬¦å·æ•´æ•°å°†ä¼šæ°¸ä¹…çš„è¢«ä¿å­˜åœ¨åŒºå—é“¾ä¸­
  uint myUnsignedInteger = 100;
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®šä¹‰ `myUnsignedInteger` ä¸º `uint` ç±»å‹ï¼Œå¹¶èµ‹å€¼100ã€‚

##### æ— ç¬¦å·æ•´æ•° uint

`uint` æ— ç¬¦å·æ•°æ®ç±»å‹ï¼Œ æŒ‡**å…¶å€¼ä¸èƒ½æ˜¯è´Ÿæ•°**ï¼Œå¯¹äºæœ‰ç¬¦å·çš„æ•´æ•°å­˜åœ¨åä¸º `int` çš„æ•°æ®ç±»å‹ã€‚

> *æ³¨: Solidityä¸­ï¼Œ* `uint` *å®é™…ä¸Šæ˜¯* `uint256`*ä»£åè¯ï¼Œ ä¸€ä¸ª256ä½çš„æ— ç¬¦å·æ•´æ•°ã€‚ä½ ä¹Ÿå¯ä»¥å®šä¹‰ä½æ•°å°‘çš„uints â€”* `uint8`*ï¼Œ* `uint16`*ï¼Œ* `uint32`*ï¼Œ ç­‰â€¦â€¦ ä½†ä¸€èˆ¬æ¥è®²ä½ æ„¿æ„ä½¿ç”¨ç®€å•çš„* `uint`*ï¼Œ é™¤éåœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™æˆ‘ä»¬åé¢ä¼šè®²ã€‚*

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬çš„åƒµå°¸DNAå°†ç”±ä¸€ä¸ªåå…­ä½æ•°å­—ç»„æˆã€‚

å®šä¹‰ `dnaDigits` ä¸º `uint` æ•°æ®ç±»å‹, å¹¶èµ‹å€¼ `16`ã€‚

``` solidity
pragma solidity ^0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
}
```



#### ç¬¬4ç«  æ•°å­¦è¿ç®—

åœ¨ Solidity ä¸­ï¼Œæ•°å­¦è¿ç®—å¾ˆç›´è§‚æ˜äº†ï¼Œä¸å…¶å®ƒç¨‹åºè®¾è®¡è¯­è¨€ç›¸åŒ:

- åŠ æ³•: `x + y`
- å‡æ³•: `x - y`,
- ä¹˜æ³•: `x * y`
- é™¤æ³•: `x / y`
- å–æ¨¡ / æ±‚ä½™: `x % y` *(ä¾‹å¦‚, `13 % 5` ä½™ `3`, å› ä¸º13é™¤ä»¥5ï¼Œä½™3)*

Solidity è¿˜æ”¯æŒ ***ä¹˜æ–¹æ“ä½œ\*** (å¦‚ï¼šx çš„ yæ¬¡æ–¹ï¼‰ // ä¾‹å¦‚ï¼š 5 ** 2 = 25

```solidity
uint x = 5 ** 2; // equal to 5^2 = 25
```

##### å®æˆ˜æ¼”ä¹ 

ä¸ºäº†ä¿è¯æˆ‘ä»¬çš„åƒµå°¸çš„DNAåªå«æœ‰16ä¸ªå­—ç¬¦ï¼Œæˆ‘ä»¬å…ˆé€ ä¸€ä¸ª`uint`æ•°æ®ï¼Œè®©å®ƒç­‰äº10^16ã€‚è¿™æ ·ä¸€æ¥ä»¥åæˆ‘ä»¬å¯ä»¥ç”¨æ¨¡è¿ç®—ç¬¦ `%` æŠŠä¸€ä¸ªæ•´æ•°å˜æˆ16ä½ã€‚

1. å»ºç«‹ä¸€ä¸ª`uint`ç±»å‹çš„å˜é‡ï¼Œåå­—å«`dnaModulus`, ä»¤å…¶ç­‰äº **10 çš„ `dnaDigits` æ¬¡æ–¹**.

``` solidity
pragma solidity ^0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;
}
```



#### ç¬¬5ç«  ç»“æ„ä½“

æœ‰æ—¶ä½ éœ€è¦æ›´å¤æ‚çš„æ•°æ®ç±»å‹ï¼ŒSolidity æä¾›äº† **ç»“æ„ä½“**:

```solidity
struct Person {
  uint age;
  string name;
}
```

ç»“æ„ä½“å…è®¸ä½ ç”Ÿæˆä¸€ä¸ªæ›´å¤æ‚çš„æ•°æ®ç±»å‹ï¼Œå®ƒæœ‰å¤šä¸ªå±æ€§ã€‚

> æ³¨ï¼šæˆ‘ä»¬åˆšåˆšå¼•è¿›äº†ä¸€ä¸ªæ–°ç±»å‹, `string`ã€‚ å­—ç¬¦ä¸²ç”¨äºä¿å­˜ä»»æ„é•¿åº¦çš„ UTF-8 ç¼–ç æ•°æ®ã€‚ å¦‚ï¼š `string greeting = "Hello world!"`ã€‚

##### å®æˆ˜æ¼”ä¹ 

åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›åƒµå°¸ï¼æ¯ä¸ªåƒµå°¸å°†æ‹¥æœ‰å¤šä¸ªå±æ€§ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå±•ç¤ºç»“æ„ä½“çš„å®Œç¾ä¾‹å­ã€‚

1. å»ºç«‹ä¸€ä¸ª`struct` å‘½åä¸º `Zombie`.
2. æˆ‘ä»¬çš„ `Zombie` ç»“æ„ä½“æœ‰ä¸¤ä¸ªå±æ€§ï¼š `name` (ç±»å‹ä¸º `string`), å’Œ `dna` (ç±»å‹ä¸º `uint`)ã€‚

``` solidity
pragma solidity ^0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }
}
```



#### ç¬¬6ç«  æ•°ç»„

å¦‚æœä½ æƒ³å»ºç«‹ä¸€ä¸ªé›†åˆï¼Œå¯ä»¥ç”¨ **_æ•°ç»„_**è¿™æ ·çš„æ•°æ®ç±»å‹. Solidity æ”¯æŒä¸¤ç§æ•°ç»„: **_é™æ€_** æ•°ç»„å’Œ**_åŠ¨æ€_** æ•°ç»„:

```solidity
// å›ºå®šé•¿åº¦ä¸º2çš„é™æ€æ•°ç»„:
uint[2] fixedArray;
// å›ºå®šé•¿åº¦ä¸º5çš„stringç±»å‹çš„é™æ€æ•°ç»„:
string[5] stringArray;
// åŠ¨æ€æ•°ç»„ï¼Œé•¿åº¦ä¸å›ºå®šï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ å…ƒç´ :
uint[] dynamicArray;
```

ä½ ä¹Ÿå¯ä»¥å»ºç«‹ä¸€ä¸ª ***ç»“æ„ä½“*** ç±»å‹çš„æ•°ç»„ ä¾‹å¦‚ï¼Œä¸Šä¸€ç« æåˆ°çš„ `Person`:

```solidity
Person[] people; // è¿™æ˜¯åŠ¨æ€æ•°ç»„ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­æ·»åŠ å…ƒç´ 
```

è®°ä½ï¼šçŠ¶æ€å˜é‡è¢«æ°¸ä¹…ä¿å­˜åœ¨åŒºå—é“¾ä¸­ã€‚æ‰€ä»¥åœ¨ä½ çš„åˆçº¦ä¸­åˆ›å»ºåŠ¨æ€æ•°ç»„æ¥ä¿å­˜æˆç»“æ„çš„æ•°æ®æ˜¯éå¸¸æœ‰æ„ä¹‰çš„ã€‚

##### å…¬å…±æ•°ç»„

ä½ å¯ä»¥å®šä¹‰ `public` æ•°ç»„, Solidity ä¼šè‡ªåŠ¨åˆ›å»º ***getter*** æ–¹æ³•. è¯­æ³•å¦‚ä¸‹:

```solidity
Person[] public people;
```

å…¶å®ƒçš„åˆçº¦å¯ä»¥ä»è¿™ä¸ªæ•°ç»„è¯»å–æ•°æ®ï¼ˆä½†ä¸èƒ½å†™å…¥æ•°æ®ï¼‰ï¼Œæ‰€ä»¥è¿™åœ¨åˆçº¦ä¸­æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ä¿å­˜å…¬å…±æ•°æ®çš„æ¨¡å¼ã€‚

##### å®æˆ˜æ¼”ä¹ 

ä¸ºäº†æŠŠä¸€ä¸ªåƒµå°¸éƒ¨é˜Ÿä¿å­˜åœ¨æˆ‘ä»¬çš„APPé‡Œï¼Œå¹¶ä¸”èƒ½å¤Ÿè®©å…¶å®ƒAPPçœ‹åˆ°è¿™äº›åƒµå°¸ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¬å…±æ•°ç»„ã€‚

1. åˆ›å»ºä¸€ä¸ªæ•°æ®ç±»å‹ä¸º `Zombie` çš„ç»“æ„ä½“æ•°ç»„ï¼Œç”¨ `public` ä¿®é¥°ï¼Œå‘½åä¸ºï¼š`zombies`.

``` solidity
pragma solidity ^0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;
}
```



#### ç¬¬7ç«  å®šä¹‰å‡½æ•°

åœ¨ Solidity ä¸­å‡½æ•°å®šä¹‰çš„å¥æ³•å¦‚ä¸‹:

```solidity
function eatHamburgers(string _name, uint _amount) {
}
```

è¿™æ˜¯ä¸€ä¸ªåä¸º `eatHamburgers` çš„å‡½æ•°ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ª `string`ç±»å‹çš„ å’Œ ä¸€ä¸ª `uint`ç±»å‹çš„ã€‚ç°åœ¨å‡½æ•°å†…éƒ¨è¿˜æ˜¯ç©ºçš„ã€‚

> æ³¨ï¼š: ä¹ æƒ¯ä¸Šå‡½æ•°é‡Œçš„å˜é‡éƒ½æ˜¯ä»¥(`_`)å¼€å¤´ (ä½†ä¸æ˜¯ç¡¬æ€§è§„å®š) ä»¥åŒºåˆ«å…¨å±€å˜é‡ã€‚æˆ‘ä»¬æ•´ä¸ªæ•™ç¨‹éƒ½ä¼šæ²¿ç”¨è¿™ä¸ªä¹ æƒ¯ã€‚

æˆ‘ä»¬çš„å‡½æ•°å®šä¹‰å¦‚ä¸‹:

```solidity
eatHamburgers("vitalik", 100);
```

##### å®æˆ˜æ¼”ä¹ 

åœ¨æˆ‘ä»¬çš„åº”ç”¨é‡Œï¼Œæˆ‘ä»¬è¦èƒ½åˆ›å»ºä¸€äº›åƒµå°¸ï¼Œè®©æˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°åšè¿™ä»¶äº‹å§ï¼

1. å»ºç«‹ä¸€ä¸ªå‡½æ•° `createZombie`ã€‚ å®ƒæœ‰ä¸¤ä¸ªå‚æ•°: **_name** (ç±»å‹ä¸º`string`), å’Œ **_dna** (ç±»å‹ä¸º`uint`)ã€‚

æš‚æ—¶è®©å‡½æ•°ç©ºç€â€”â€”æˆ‘ä»¬åœ¨åé¢ä¼šå¢åŠ å†…å®¹ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function createZombie(string calldata _name, uint _dna) public {
    }
}
```



#### ç¬¬8ç«  ä½¿ç”¨ç»“æ„ä½“å’Œæ•°ç»„

##### åˆ›å»ºæ–°çš„ç»“æ„ä½“

è¿˜è®°å¾—ä¸Šä¸ªä¾‹å­ä¸­çš„ `Person` ç»“æ„å—ï¼Ÿ

```solidity
struct Person {
  uint age;
  string name;
}

Person[] public people;
```

ç°åœ¨æˆ‘ä»¬å­¦ä¹ åˆ›å»ºæ–°çš„ `Person` ç»“æ„ï¼Œç„¶åæŠŠå®ƒåŠ å…¥åˆ°åä¸º `people` çš„æ•°ç»„ä¸­.

```solidity
// åˆ›å»ºä¸€ä¸ªæ–°çš„Person:
Person satoshi = Person(172, "Satoshi");

// å°†æ–°åˆ›å»ºçš„satoshiæ·»åŠ è¿›peopleæ•°ç»„:
people.push(satoshi);
```

ä½ ä¹Ÿå¯ä»¥ä¸¤æ­¥å¹¶ä¸€æ­¥ï¼Œç”¨ä¸€è¡Œä»£ç æ›´ç®€æ´:

```solidity
people.push(Person(16, "Vitalik"));
```

> æ³¨ï¼š`array.push()` åœ¨æ•°ç»„çš„ **å°¾éƒ¨** åŠ å…¥æ–°å…ƒç´  ï¼Œæ‰€ä»¥å…ƒç´ åœ¨æ•°ç»„ä¸­çš„é¡ºåºå°±æ˜¯æˆ‘ä»¬æ·»åŠ çš„é¡ºåºï¼Œ å¦‚:

```solidity
uint[] numbers;
numbers.push(5);
numbers.push(10);
numbers.push(15);
// numbers is now equal to [5, 10, 15]
```

##### å®æˆ˜æ¼”ä¹ 

è®©æˆ‘ä»¬åˆ›å»ºåä¸ºcreateZombieçš„å‡½æ•°æ¥åšç‚¹å„¿ä»€ä¹ˆå§ã€‚

1. åœ¨å‡½æ•°ä½“é‡Œæ–°åˆ›å»ºä¸€ä¸ª `Zombie`ï¼Œ ç„¶åæŠŠå®ƒåŠ å…¥ `zombies` æ•°ç»„ä¸­ã€‚ æ–°åˆ›å»ºçš„åƒµå°¸çš„ `name` å’Œ `dna`ï¼Œæ¥è‡ªäºå‡½æ•°çš„å‚æ•°ã€‚
2. è®©æˆ‘ä»¬ç”¨ä¸€è¡Œä»£ç ç®€æ´åœ°å®Œæˆå®ƒã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {

    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function createZombie(string calldata _name, uint _dna) public {
        zombies.push(Zombie(_name, _dna));
    }
}
```



#### ç¬¬9ç«  ç§æœ‰ / å…¬å…±å‡½æ•°

Solidity å®šä¹‰çš„å‡½æ•°çš„å±æ€§é»˜è®¤ä¸º`å…¬å…±`ã€‚ è¿™å°±æ„å‘³ç€ä»»ä½•ä¸€æ–¹ (æˆ–å…¶å®ƒåˆçº¦) éƒ½å¯ä»¥è°ƒç”¨ä½ åˆçº¦é‡Œçš„å‡½æ•°ã€‚

æ˜¾ç„¶ï¼Œä¸æ˜¯ä»€ä¹ˆæ—¶å€™éƒ½éœ€è¦è¿™æ ·ï¼Œè€Œä¸”è¿™æ ·çš„åˆçº¦æ˜“äºå—åˆ°æ”»å‡»ã€‚ æ‰€ä»¥å°†è‡ªå·±çš„å‡½æ•°å®šä¹‰ä¸º`ç§æœ‰`æ˜¯ä¸€ä¸ªå¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œåªæœ‰å½“ä½ éœ€è¦å¤–éƒ¨ä¸–ç•Œè°ƒç”¨å®ƒæ—¶æ‰å°†å®ƒè®¾ç½®ä¸º`å…¬å…±`ã€‚

å¦‚ä½•å®šä¹‰ä¸€ä¸ªç§æœ‰çš„å‡½æ•°å‘¢ï¼Ÿ

```solidity
uint[] numbers;

function _addToArray(uint _number) private {
  numbers.push(_number);
}
```

è¿™æ„å‘³ç€åªæœ‰æˆ‘ä»¬åˆçº¦ä¸­çš„å…¶å®ƒå‡½æ•°æ‰èƒ½å¤Ÿè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œç»™ `numbers` æ•°ç»„æ·»åŠ æ–°æˆå‘˜ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å‡½æ•°åå­—åé¢ä½¿ç”¨å…³é”®å­— `private` å³å¯ã€‚å’Œå‡½æ•°çš„å‚æ•°ç±»ä¼¼ï¼Œç§æœ‰å‡½æ•°çš„åå­—ç”¨(`_`)èµ·å§‹ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬åˆçº¦çš„å‡½æ•° `createZombie` çš„é»˜è®¤å±æ€§æ˜¯å…¬å…±çš„ï¼Œè¿™æ„å‘³ç€ä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥è°ƒç”¨å®ƒå»åˆ›å»ºä¸€ä¸ªåƒµå°¸ã€‚ å’±ä»¬æ¥æŠŠå®ƒå˜æˆç§æœ‰å§ï¼

1. å˜ `createZombie` ä¸ºç§æœ‰å‡½æ•°ï¼Œä¸è¦å¿˜è®°éµå®ˆå‘½åçš„è§„çŸ©å“¦ï¼

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {

    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function _createZombie(string calldata _name, uint _dna) private {
        zombies.push(Zombie(_name, _dna));
    }
}
```



#### ç¬¬10ç«  å‡½æ•°çš„æ›´å¤šå±æ€§

æœ¬ç« ä¸­æˆ‘ä»¬å°†å­¦ä¹ å‡½æ•°çš„è¿”å›å€¼å’Œä¿®é¥°ç¬¦ã€‚

##### è¿”å›å€¼

è¦æƒ³å‡½æ•°è¿”å›ä¸€ä¸ªæ•°å€¼ï¼ŒæŒ‰å¦‚ä¸‹å®šä¹‰ï¼š

```solidity
string greeting = "What's up dog";

function sayHello() public returns (string) {
  return greeting;
}
```

Solidity é‡Œï¼Œå‡½æ•°çš„å®šä¹‰é‡Œå¯åŒ…å«è¿”å›å€¼çš„æ•°æ®ç±»å‹(å¦‚æœ¬ä¾‹ä¸­ `string`)ã€‚

##### å‡½æ•°çš„ä¿®é¥°ç¬¦

ä¸Šé¢çš„å‡½æ•°å®é™…ä¸Šæ²¡æœ‰æ”¹å˜ Solidity é‡Œçš„çŠ¶æ€ï¼Œå³ï¼Œå®ƒæ²¡æœ‰æ”¹å˜ä»»ä½•å€¼æˆ–è€…å†™ä»»ä½•ä¸œè¥¿ã€‚

è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥æŠŠå‡½æ•°å®šä¹‰ä¸º ***view***, æ„å‘³ç€å®ƒåªèƒ½è¯»å–æ•°æ®ä¸èƒ½æ›´æ”¹æ•°æ®:

```solidity
function sayHello() public view returns (string) {
```

Solidity è¿˜æ”¯æŒ ***pure*** å‡½æ•°, è¡¨æ˜è¿™ä¸ªå‡½æ•°ç”šè‡³éƒ½ä¸è®¿é—®åº”ç”¨é‡Œçš„æ•°æ®ï¼Œä¾‹å¦‚ï¼š

```solidity
function _multiply(uint a, uint b) private pure returns (uint) {
  return a * b;
}
```

è¿™ä¸ªå‡½æ•°ç”šè‡³éƒ½ä¸è¯»å–åº”ç”¨é‡Œçš„çŠ¶æ€ â€” å®ƒçš„è¿”å›å€¼å®Œå…¨å–å†³äºå®ƒçš„è¾“å…¥å‚æ•°ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æŠŠå‡½æ•°å®šä¹‰ä¸º ***pure***.

> æ³¨ï¼šå¯èƒ½å¾ˆéš¾è®°ä½ä½•æ—¶æŠŠå‡½æ•°æ ‡è®°ä¸º pure/viewã€‚ å¹¸è¿çš„æ˜¯ï¼Œ Solidity ç¼–è¾‘å™¨ä¼šç»™å‡ºæç¤ºï¼Œæé†’ä½ ä½¿ç”¨è¿™äº›ä¿®é¥°ç¬¦ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æƒ³å»ºç«‹ä¸€ä¸ªå¸®åŠ©å‡½æ•°ï¼Œå®ƒæ ¹æ®ä¸€ä¸ªå­—ç¬¦ä¸²éšæœºç”Ÿæˆä¸€ä¸ªDNAæ•°æ®ã€‚

1. åˆ›å»ºä¸€ä¸ª `private` å‡½æ•°ï¼Œå‘½åä¸º `_generateRandomDna`ã€‚å®ƒåªæ¥æ”¶ä¸€ä¸ªè¾“å…¥å˜é‡ `_str` (ç±»å‹ `string`), è¿”å›ä¸€ä¸ª `uint` ç±»å‹çš„æ•°å€¼ã€‚
2. æ­¤å‡½æ•°åªè¯»å–æˆ‘ä»¬åˆçº¦ä¸­çš„ä¸€äº›å˜é‡ï¼Œæ‰€ä»¥æ ‡è®°ä¸º`view`ã€‚
3. å‡½æ•°å†…éƒ¨æš‚æ—¶ç•™ç©ºï¼Œä»¥åæˆ‘ä»¬å†æ·»åŠ ä»£ç ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >=0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function _createZombie(string calldata _name, uint _dna) private {
        zombies.push(Zombie(_name, _dna));
    }

    function _generateRandomDna(string calldata _str) private view returns (uint) {

    }
}
```



#### ç¬¬11ç«  Keccak256 å’Œ ç±»å‹è½¬æ¢

å¦‚ä½•è®© `_generateRandomDna` å‡½æ•°è¿”å›ä¸€ä¸ªå…¨(åŠ) éšæœºçš„ `uint`?

Ethereum å†…éƒ¨æœ‰ä¸€ä¸ªæ•£åˆ—å‡½æ•°`keccak256`ï¼Œå®ƒç”¨äº†SHA3ç‰ˆæœ¬ã€‚ä¸€ä¸ªæ•£åˆ—å‡½æ•°åŸºæœ¬ä¸Šå°±æ˜¯æŠŠä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ª256ä½çš„16è¿›åˆ¶æ•°å­—ã€‚å­—ç¬¦ä¸²çš„ä¸€ä¸ªå¾®å°å˜åŒ–ä¼šå¼•èµ·æ•£åˆ—æ•°æ®æå¤§å˜åŒ–ã€‚

è¿™åœ¨ Ethereum ä¸­æœ‰å¾ˆå¤šåº”ç”¨ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬åªæ˜¯ç”¨å®ƒé€ ä¸€ä¸ªä¼ªéšæœºæ•°ã€‚

ä¾‹å­:

```bash
//6e91ec6b618bb462a4a6ee5aa2cb0e9cf30f7a052bb467b0ba58b8748c00d2e5
keccak256("aaaab");
//b1f078126895a1424524de5321b339ab00408010b7cf0e6ed451514981e58aa9
keccak256("aaaac");
```

æ˜¾è€Œæ˜“è§ï¼Œè¾“å…¥å­—ç¬¦ä¸²åªæ”¹å˜äº†ä¸€ä¸ªå­—æ¯ï¼Œè¾“å‡ºå°±å·²ç»å¤©å£¤ä¹‹åˆ«äº†ã€‚

> æ³¨: åœ¨åŒºå—é“¾ä¸­**å®‰å…¨åœ°**äº§ç”Ÿä¸€ä¸ªéšæœºæ•°æ˜¯ä¸€ä¸ªå¾ˆéš¾çš„é—®é¢˜ï¼Œ æœ¬ä¾‹çš„æ–¹æ³•ä¸å®‰å…¨ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬çš„Zombie DNAç®—æ³•é‡Œä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå·²ç»å¾ˆå¥½åœ°æ»¡è¶³æˆ‘ä»¬çš„éœ€è¦äº†ã€‚

##### ç±»å‹è½¬æ¢

æœ‰æ—¶ä½ éœ€è¦å˜æ¢æ•°æ®ç±»å‹ã€‚ä¾‹å¦‚:

```solidity
uint8 a = 5;
uint b = 6;
// å°†ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸º a * b è¿”å› uint, è€Œä¸æ˜¯ uint8:
uint8 c = a * b;
// æˆ‘ä»¬éœ€è¦å°† b è½¬æ¢ä¸º uint8:
uint8 c = a * uint8(b);
```

ä¸Šé¢, `a * b` è¿”å›ç±»å‹æ˜¯ `uint`, ä½†æ˜¯å½“æˆ‘ä»¬å°è¯•ç”¨ `uint8` ç±»å‹æ¥æ”¶æ—¶, å°±ä¼šé€ æˆæ½œåœ¨çš„é”™è¯¯ã€‚å¦‚æœæŠŠå®ƒçš„æ•°æ®ç±»å‹è½¬æ¢ä¸º `uint8`, å°±å¯ä»¥äº†ï¼Œç¼–è¯‘å™¨ä¹Ÿä¸ä¼šå‡ºé”™ã€‚

##### å®æˆ˜æ¼”ä¹ 

ç»™ `_generateRandomDna` å‡½æ•°æ·»åŠ ä»£ç ! å®ƒåº”è¯¥å®Œæˆå¦‚ä¸‹åŠŸèƒ½:

1. ç¬¬ä¸€è¡Œä»£ç å– `_str` çš„ `keccak256` æ•£åˆ—å€¼ç”Ÿæˆä¸€ä¸ªä¼ªéšæœºåå…­è¿›åˆ¶æ•°ï¼Œç±»å‹è½¬æ¢ä¸º `uint`, æœ€åä¿å­˜åœ¨ç±»å‹ä¸º `uint` åä¸º `rand` çš„å˜é‡ä¸­ã€‚
2. æˆ‘ä»¬åªæƒ³è®©æˆ‘ä»¬çš„DNAçš„é•¿åº¦ä¸º16ä½ (è¿˜è®°å¾— `dnaModulus`?)ã€‚æ‰€ä»¥ç¬¬äºŒè¡Œä»£ç åº”è¯¥ `return` ä¸Šé¢è®¡ç®—çš„æ•°å€¼å¯¹ `dnaModulus` æ±‚ä½™æ•°(`%`)ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function _createZombie(string calldata _name, uint _dna) private {
        zombies.push(Zombie(_name, _dna));
    }

    function _generateRandomDna(string calldata _str) private view returns (uint) {
        uint rand = uint(keccak256(abi.encode(_str)));
        return rand % dnaModulus;
    }
}
```



#### ç¬¬12ç«  æ”¾åœ¨ä¸€èµ·

æˆ‘ä»¬å°±å¿«å®Œæˆæˆ‘ä»¬çš„éšæœºåƒµå°¸åˆ¶é€ å™¨äº†ï¼Œæ¥å†™ä¸€ä¸ªå…¬å…±çš„å‡½æ•°æŠŠæ‰€æœ‰çš„éƒ¨ä»¶è¿æ¥èµ·æ¥ã€‚

å†™ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œå®ƒæœ‰ä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥æ¥æ”¶åƒµå°¸çš„åå­—ï¼Œä¹‹åç”¨å®ƒç”Ÿæˆåƒµå°¸çš„DNAã€‚

##### å®æˆ˜æ¼”ä¹ 

1. åˆ›å»ºä¸€ä¸ª `public` å‡½æ•°ï¼Œå‘½åä¸º `createRandomZombie`. å®ƒå°†è¢«ä¼ å…¥ä¸€ä¸ªå˜é‡ `_name` (æ•°æ®ç±»å‹æ˜¯ `string`)ã€‚ *(æ³¨: å®šä¹‰å…¬å…±å‡½æ•° `public` å’Œå®šä¹‰ä¸€ä¸ªç§æœ‰ `private` å‡½æ•°çš„åšæ³•ä¸€æ ·)*ã€‚
2. å‡½æ•°çš„ç¬¬ä¸€è¡Œåº”è¯¥è°ƒç”¨ `_generateRandomDna` å‡½æ•°ï¼Œä¼ å…¥ `_name` å‚æ•°, ç»“æœä¿å­˜åœ¨ä¸€ä¸ªç±»å‹ä¸º `uint` çš„å˜é‡é‡Œï¼Œå‘½åä¸º `randDna`ã€‚
3. ç¬¬äºŒè¡Œè°ƒç”¨ `_createZombie` å‡½æ•°ï¼Œ ä¼ å…¥å‚æ•°ï¼š `_name` å’Œ `randDna`ã€‚
4. æ•´ä¸ªå‡½æ•°åº”è¯¥æ˜¯4è¡Œä»£ç  (åŒ…æ‹¬å‡½æ•°çš„ç»“æŸç¬¦å· `}` )ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function _createZombie(string calldata _name, uint _dna) private {
        zombies.push(Zombie(_name, _dna));
    }

    function _generateRandomDna(string calldata _str) private view returns (uint) {
        uint rand = uint(keccak256(abi.encode(_str)));
        return rand % dnaModulus;
    }

    function createRandomZombie(string calldata _name) public {
        uint randDna = _generateRandomDna(_name);
        _createZombie(_name, randDna);
    }
}
```



#### ç¬¬13ç«  äº‹ä»¶

æˆ‘ä»¬çš„åˆçº¦å‡ ä¹å°±è¦å®Œæˆäº†ï¼è®©æˆ‘ä»¬åŠ ä¸Šä¸€ä¸ª**äº‹ä»¶**.

**äº‹ä»¶** æ˜¯åˆçº¦å’ŒåŒºå—é“¾é€šè®¯çš„ä¸€ç§æœºåˆ¶ã€‚ä½ çš„å‰ç«¯åº”ç”¨â€œç›‘å¬â€æŸäº›äº‹ä»¶ï¼Œå¹¶åšå‡ºååº”ã€‚

ä¾‹å­:

```solidity
// è¿™é‡Œå»ºç«‹äº‹ä»¶
event IntegersAdded(uint x, uint y, uint result);

function add(uint _x, uint _y) public {
  uint result = _x + _y;
  //è§¦å‘äº‹ä»¶ï¼Œé€šçŸ¥app
  IntegersAdded(_x, _y, result);
  return result;
}
```

ä½ çš„ app å‰ç«¯å¯ä»¥ç›‘å¬è¿™ä¸ªäº‹ä»¶ã€‚JavaScript å®ç°å¦‚ä¸‹:

```solidity
YourContract.IntegersAdded(function(error, result) {
  // å¹²äº›äº‹
})
```

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æƒ³æ¯å½“ä¸€ä¸ªåƒµå°¸åˆ›é€ å‡ºæ¥æ—¶ï¼Œæˆ‘ä»¬çš„å‰ç«¯éƒ½èƒ½ç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå¹¶å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ã€‚

1. å®šä¹‰ä¸€ä¸ª `äº‹ä»¶` å«åš `NewZombie`ã€‚ å®ƒæœ‰3ä¸ªå‚æ•°: `zombieId` (`uint`)ï¼Œ `name` (`string`)ï¼Œ å’Œ `dna` (`uint`)ã€‚

2. ä¿®æ”¹ `_createZombie` å‡½æ•°ä½¿å¾—å½“æ–°åƒµå°¸é€ å‡ºæ¥å¹¶åŠ å…¥ `zombies`æ•°ç»„åï¼Œç”Ÿæˆäº‹ä»¶`NewZombie`ã€‚

3. éœ€è¦å®šä¹‰åƒµå°¸`id`ã€‚ `array.push()` è¿”å›æ•°ç»„çš„é•¿åº¦ç±»å‹æ˜¯`uint` - å› ä¸ºæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•æ˜¯ 0ï¼Œ `array.push() - 1` å°†æ˜¯æˆ‘ä»¬åŠ å…¥çš„åƒµå°¸çš„ç´¢å¼•ã€‚ `zombies.push() - 1` å°±æ˜¯ `id`ï¼Œæ•°æ®ç±»å‹æ˜¯ `uint`ã€‚åœ¨ä¸‹ä¸€è¡Œä¸­ä½ å¯ä»¥æŠŠå®ƒç”¨åˆ° `NewZombie` äº‹ä»¶ä¸­ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

contract ZombieFactory {

    // è¿™é‡Œå»ºç«‹äº‹ä»¶
    event NewZombie(uint zombieId, string name, uint dna);
    uint dnaDigits = 16;
    uint dnaModulus = 10 ** dnaDigits;

    struct Zombie {
        string name;
        uint dna;
    }

    Zombie[] public zombies;

    function _createZombie(string memory _name, uint _dna) private {
        zombies.push(Zombie(_name, _dna));
        // è¿™é‡Œè§¦å‘äº‹ä»¶
        uint id = zombies.length -1;
        emit NewZombie(id, _name, _dna);
    }

    function _generateRandomDna(string memory _str) private view returns (uint) {
        uint rand = uint(keccak256(abi.encode(_str)));
        return rand % dnaModulus;
    }

    function createRandomZombie(string memory _name) public {
        uint randDna = _generateRandomDna(_name);
        _createZombie(_name, randDna);
    }
}
```



#### ç¬¬14ç«  Web3.js

æˆ‘ä»¬çš„ Solidity åˆçº¦å®Œå·¥äº†ï¼ ç°åœ¨æˆ‘ä»¬è¦å†™ä¸€æ®µ JavaScript å‰ç«¯ä»£ç æ¥è°ƒç”¨è¿™ä¸ªåˆçº¦ã€‚

ä»¥å¤ªåŠæœ‰ä¸€ä¸ª JavaScript åº“ï¼Œåä¸º ***Web3.js***ã€‚

åœ¨åé¢çš„è¯¾ç¨‹é‡Œï¼Œæˆ‘ä»¬ä¼šè¿›ä¸€æ­¥åœ°æ•™ä½ å¦‚ä½•å®‰è£…ä¸€ä¸ªåˆçº¦ï¼Œå¦‚ä½•è®¾ç½®Web3.jsã€‚ ä½†æ˜¯ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸€æ®µä»£ç æ¥äº†è§£ Web3.js æ˜¯å¦‚ä½•å’Œæˆ‘ä»¬å‘å¸ƒçš„åˆçº¦äº¤äº’çš„å§ã€‚

å¦‚æœä¸‹é¢çš„ä»£ç ä½ ä¸èƒ½å…¨éƒ½ç†è§£ï¼Œä¸ç”¨æ‹…å¿ƒã€‚

```javascript
// ä¸‹é¢æ˜¯è°ƒç”¨åˆçº¦çš„æ–¹å¼:
var abi = /* abiæ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ */
var ZombieFactoryContract = web3.eth.contract(abi)
var contractAddress = /* å‘å¸ƒä¹‹ååœ¨ä»¥å¤ªåŠä¸Šç”Ÿæˆçš„åˆçº¦åœ°å€ */
var ZombieFactory = ZombieFactoryContract.at(contractAddress)
// `ZombieFactory` èƒ½è®¿é—®å…¬å…±çš„å‡½æ•°ä»¥åŠäº‹ä»¶

// æŸä¸ªç›‘å¬æ–‡æœ¬è¾“å…¥çš„ç›‘å¬å™¨:
$("#ourButton").click(function(e) {
  var name = $("#nameInput").val()
  //è°ƒç”¨åˆçº¦çš„ `createRandomZombie` å‡½æ•°:
  ZombieFactory.createRandomZombie(name)
})

// ç›‘å¬ `NewZombie` äº‹ä»¶, å¹¶ä¸”æ›´æ–°UI
var event = ZombieFactory.NewZombie(function(error, result) {
  if (error) return
  generateZombie(result.zombieId, result.name, result.dna)
})

// è·å– Zombie çš„ dna, æ›´æ–°å›¾åƒ
function generateZombie(id, name, dna) {
  let dnaStr = String(dna)
  // å¦‚æœdnaå°‘äº16ä½,åœ¨å®ƒå‰é¢ç”¨0è¡¥ä¸Š
  while (dnaStr.length < 16)
    dnaStr = "0" + dnaStr

  let zombieDetails = {
    // å‰ä¸¤ä½æ•°æ„æˆå¤´éƒ¨.æˆ‘ä»¬å¯èƒ½æœ‰7ç§å¤´éƒ¨, æ‰€ä»¥ % 7
    // å¾—åˆ°çš„æ•°åœ¨0-6,å†åŠ ä¸Š1,æ•°çš„èŒƒå›´å˜æˆ1-7
    // é€šè¿‡è¿™æ ·è®¡ç®—ï¼š
    headChoice: dnaStr.substring(0, 2) % 7 + 1ï¼Œ
    // æˆ‘ä»¬å¾—åˆ°çš„å›¾ç‰‡åç§°ä»head1.png åˆ° head7.png

    // æ¥ä¸‹æ¥çš„ä¸¤ä½æ•°æ„æˆçœ¼ç›, çœ¼ç›å˜åŒ–å°±å¯¹11å–æ¨¡:
    eyeChoice: dnaStr.substring(2, 4) % 11 + 1,
    // å†æ¥ä¸‹æ¥çš„ä¸¤ä½æ•°æ„æˆè¡£æœï¼Œè¡£æœå˜åŒ–å°±å¯¹6å–æ¨¡:
    shirtChoice: dnaStr.substring(4, 6) % 6 + 1,
    //æœ€å6ä½æ§åˆ¶é¢œè‰². ç”¨cssé€‰æ‹©å™¨: hue-rotateæ¥æ›´æ–°
    // 360åº¦:
    skinColorChoice: parseInt(dnaStr.substring(6, 8) / 100 * 360),
    eyeColorChoice: parseInt(dnaStr.substring(8, 10) / 100 * 360),
    clothesColorChoice: parseInt(dnaStr.substring(10, 12) / 100 * 360),
    zombieName: name,
    zombieDescription: "A Level 1 CryptoZombie",
  }
  return zombieDetails
}
```

æˆ‘ä»¬çš„ JavaScript æ‰€åšçš„å°±æ˜¯è·å–ç”±`zombieDetails` äº§ç”Ÿçš„æ•°æ®, å¹¶ä¸”åˆ©ç”¨æµè§ˆå™¨é‡Œçš„ JavaScript ç¥å¥‡åŠŸèƒ½ (æˆ‘ä»¬ç”¨ Vue.js)ï¼Œç½®æ¢å‡ºå›¾åƒä»¥åŠä½¿ç”¨CSSè¿‡æ»¤å™¨ã€‚åœ¨åé¢çš„è¯¾ç¨‹ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å…¨éƒ¨çš„ä»£ç ã€‚

##### è¯•ä¸€ä¸‹å§!

åœ¨å³é¢çš„è¾“å…¥æ¡†é‡Œè¾“å…¥ä½ çš„åå­—ï¼Œçœ‹çœ‹ä½ èƒ½å¾—åˆ°å“ªç§åƒµå°¸ï¼

**ä¸€æ—¦ä½ å¾—åˆ°ä¸€ä¸ªæ»¡æ„çš„åƒµå°¸, ç‚¹å‡»ä¸‹é¢çš„ "ä¸‹ä¸€ç« " æŒ‰é’®ä¿å­˜ä½ çš„åƒµå°¸ï¼Œç»“æŸç¬¬ä¸€è¯¾!**

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/04/28/20220428145457.png" align="center" style="width:500px" />

##### å¤ªæ£’å•¦ï¼ä½ å®Œæˆäº† CryptoZombies çš„ç¬¬ä¸€ä¸ªè¯¾ç¨‹!

ä½ ç¦»è‡ªå·±ç¼–è¯‘åŒºå—é“¾æ¸¸æˆè·¨å‡ºäº†å¾ˆå¤§çš„ä¸€æ­¥ã€‚

##### è·Ÿä½ çš„æœ‹å‹ä»¬æ™’ä¸€æ™’ä½ æ–°çš„åƒµå°¸å§ï¼

è¿™æ˜¯ä½ çš„åƒµå°¸çš„æ°¸ä¹…åœ°å€:

https://share.cryptozombies.io/zh/lesson/1/share/GG?id=Y3p8MjEwMTY2

[åŠ å…¥æˆ‘ä»¬çš„Telegram](https://t.me/loomnetworkdev)



### 1.2 åƒµå°¸æ”»å‡»äººç±»

#### ç¬¬1ç«  ç¬¬äºŒè¯¾æ¦‚è§ˆ

åœ¨ç¬¬ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•°ç”¨æ¥ç”Ÿæˆåƒµå°¸ï¼Œå¹¶ä¸”å°†å®ƒæ”¾å…¥åŒºå—é“¾ä¸Šçš„åƒµå°¸æ•°æ®åº“ä¸­ã€‚ åœ¨ç¬¬äºŒè¯¾é‡Œï¼Œæˆ‘ä»¬ä¼šè®©æˆ‘ä»¬çš„ app çœ‹èµ·æ¥æ›´åƒä¸€ä¸ªæ¸¸æˆï¼š å®ƒå¾—æ”¯æŒå¤šç”¨æˆ·ï¼Œå¹¶ä¸”é‡‡ç”¨æ›´åŠ æœ‰è¶£,è€Œä¸ä»…ä»…ä½¿ç”¨éšæœºçš„æ–¹å¼ï¼Œæ¥ç”Ÿæˆæ–°çš„åƒµå°¸ã€‚

å¦‚ä½•ç”Ÿæˆæ–°çš„åƒµå°¸å‘¢ï¼Ÿé€šè¿‡è®©ç°æœ‰çš„åƒµå°¸çŒé£Ÿå…¶ä»–ç”Ÿç‰©ï¼

##### åƒµå°¸çŒé£Ÿ

åƒµå°¸çŒé£Ÿçš„æ—¶å€™ï¼Œåƒµå°¸ç—…æ¯’ä¾µå…¥çŒç‰©ï¼Œè¿™äº›ç—…æ¯’ä¼šå°†çŒç‰©å˜ä¸ºæ–°çš„åƒµå°¸ï¼ŒåŠ å…¥ä½ çš„åƒµå°¸å¤§å†›ã€‚ç³»ç»Ÿä¼šé€šè¿‡çŒç‰©å’ŒçŒé£Ÿè€…åƒµå°¸çš„DNAè®¡ç®—å‡ºæ–°åƒµå°¸çš„DNAã€‚

åƒµå°¸æœ€å–œæ¬¢çŒé£Ÿä»€ä¹ˆç‰©ç§å‘¢ï¼Ÿ ç­‰ä½ å­¦å®Œç¬¬äºŒè¯¾å°±çŸ¥é“äº†ï¼

##### å®æˆ˜æ¼”ä¹ 

å³è¾¹æ˜¯ä¸€ä¸ªç®€å•çš„çŒé£Ÿæ¼”ç¤ºã€‚ç‚¹å‡»ä¸€ä¸ªâ€œäººâ€ï¼Œçœ‹çœ‹åƒµå°¸çŒé£Ÿçš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆ? å¯è§ï¼Œæ–°åƒµå°¸çš„DNAæ˜¯é€šè¿‡ä»åŸæ¥çš„åƒµå°¸çš„DNA, åŠ ä¸ŠçŒç‰©çš„DNAè®¡ç®—å¾—æ¥çš„ã€‚

å­¦å®Œè¿™ä¸€ç« ï¼Œè¯·ç‚¹å‡»â€œä¸‹ä¸€ç« â€ï¼Œ æˆ‘ä»¬è¯¥è®©æ¸¸æˆæ”¯æŒå¤šç©å®¶æ¨¡å¼äº†ã€‚

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/04/28/20220428161055.png" align="center" style="width:500px" />

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/04/28/20220428150659.png" align="center" style="width:500px" />



#### ç¬¬2ç«  æ˜ å°„ï¼ˆMappingï¼‰å’Œåœ°å€ï¼ˆAddressï¼‰

æˆ‘ä»¬é€šè¿‡ç»™æ•°æ®åº“ä¸­çš„åƒµå°¸æŒ‡å®šâ€œä¸»äººâ€ï¼Œ æ¥æ”¯æŒâ€œå¤šç©å®¶â€æ¨¡å¼ã€‚

å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥2ä¸ªæ–°çš„æ•°æ®ç±»å‹ï¼š`mapping`ï¼ˆæ˜ å°„ï¼‰ å’Œ `address`ï¼ˆåœ°å€ï¼‰ã€‚

##### Addresses ï¼ˆåœ°å€ï¼‰

ä»¥å¤ªåŠåŒºå—é“¾ç”± **_ account _** (è´¦æˆ·)ç»„æˆï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆé“¶è¡Œè´¦æˆ·ã€‚ä¸€ä¸ªå¸æˆ·çš„ä½™é¢æ˜¯ **_ä»¥å¤ª_** ï¼ˆåœ¨ä»¥å¤ªåŠåŒºå—é“¾ä¸Šä½¿ç”¨çš„å¸ç§ï¼‰ï¼Œä½ å¯ä»¥å’Œå…¶ä»–å¸æˆ·ä¹‹é—´æ”¯ä»˜å’Œæ¥å—ä»¥å¤ªå¸ï¼Œå°±åƒä½ çš„é“¶è¡Œå¸æˆ·å¯ä»¥ç”µæ±‡èµ„é‡‘åˆ°å…¶ä»–é“¶è¡Œå¸æˆ·ä¸€æ ·ã€‚

æ¯ä¸ªå¸æˆ·éƒ½æœ‰ä¸€ä¸ªâ€œåœ°å€â€ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆé“¶è¡Œè´¦å·ã€‚è¿™æ˜¯è´¦æˆ·å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œå®ƒçœ‹èµ·æ¥é•¿è¿™æ ·ï¼š

```bash
0x0cE446255506E92DF41614C46F1d6df9Cc969183
```

ï¼ˆè¿™æ˜¯ CryptoZombies å›¢é˜Ÿçš„åœ°å€ï¼Œå¦‚æœä½ å–œæ¬¢ CryptoZombies çš„è¯ï¼Œè¯·æ‰“èµæˆ‘ä»¬ä¸€äº›ä»¥å¤ªå¸ï¼ğŸ˜‰ï¼‰

æˆ‘ä»¬å°†åœ¨åé¢çš„è¯¾ç¨‹ä¸­ä»‹ç»åœ°å€çš„ç»†èŠ‚ï¼Œç°åœ¨ä½ åªéœ€è¦äº†è§£**åœ°å€å±äºç‰¹å®šç”¨æˆ·ï¼ˆæˆ–æ™ºèƒ½åˆçº¦ï¼‰çš„**ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡å®šâ€œåœ°å€â€ä½œä¸ºåƒµå°¸ä¸»äººçš„ IDã€‚å½“ç”¨æˆ·é€šè¿‡ä¸æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºäº¤äº’æ¥åˆ›å»ºæ–°çš„åƒµå°¸æ—¶ï¼Œæ–°åƒµå°¸çš„æ‰€æœ‰æƒè¢«è®¾ç½®åˆ°è°ƒç”¨è€…çš„ä»¥å¤ªåŠåœ°å€ä¸‹ã€‚

##### Mappingï¼ˆæ˜ å°„ï¼‰

åœ¨ç¬¬1è¯¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† **_ ç»“æ„ä½“ _** å’Œ **_ æ•°ç»„ _** ã€‚ **_æ˜ å°„_** æ˜¯å¦ä¸€ç§åœ¨ Solidity ä¸­å­˜å‚¨æœ‰ç»„ç»‡æ•°æ®çš„æ–¹æ³•ã€‚

æ˜ å°„æ˜¯è¿™æ ·å®šä¹‰çš„ï¼š

```solidity
//å¯¹äºé‡‘èåº”ç”¨ç¨‹åºï¼Œå°†ç”¨æˆ·çš„ä½™é¢ä¿å­˜åœ¨ä¸€ä¸ª uintç±»å‹çš„å˜é‡ä¸­ï¼š
mapping (address => uint) public accountBalance;
//æˆ–è€…å¯ä»¥ç”¨æ¥é€šè¿‡userId å­˜å‚¨/æŸ¥æ‰¾çš„ç”¨æˆ·å
mapping (uint => string) userIdToName;
```

æ˜ å°„æœ¬è´¨ä¸Šæ˜¯å­˜å‚¨å’ŒæŸ¥æ‰¾æ•°æ®æ‰€ç”¨çš„é”®-å€¼å¯¹ã€‚åœ¨ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œé”®æ˜¯ä¸€ä¸ª `address`ï¼Œå€¼æ˜¯ä¸€ä¸ª `uint`ï¼Œåœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œé”®æ˜¯ä¸€ä¸ª`uint`ï¼Œå€¼æ˜¯ä¸€ä¸ª `string`ã€‚

##### å®æˆ˜æ¼”ä¹ 

ä¸ºäº†å­˜å‚¨åƒµå°¸çš„æ‰€æœ‰æƒï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨åˆ°ä¸¤ä¸ªæ˜ å°„ï¼šä¸€ä¸ªè®°å½•åƒµå°¸æ‹¥æœ‰è€…çš„åœ°å€ï¼Œå¦ä¸€ä¸ªè®°å½•æŸåœ°å€æ‰€æ‹¥æœ‰åƒµå°¸çš„æ•°é‡ã€‚

1.åˆ›å»ºä¸€ä¸ªå«åš `zombieToOwner` çš„æ˜ å°„ã€‚å…¶é”®æ˜¯ä¸€ä¸ª`uint`ï¼ˆæˆ‘ä»¬å°†æ ¹æ®å®ƒçš„ id å­˜å‚¨å’ŒæŸ¥æ‰¾åƒµå°¸ï¼‰ï¼Œå€¼ä¸º `address`ã€‚æ˜ å°„å±æ€§ä¸º`public`ã€‚

2.åˆ›å»ºä¸€ä¸ªåä¸º `ownerZombieCount` çš„æ˜ å°„ï¼Œå…¶ä¸­é”®æ˜¯ `address`ï¼Œå€¼æ˜¯ `uint`ã€‚

``` solidity
//... other code ...
Zombie[] public zombies;
// è®°å½•åƒµå°¸æ‹¥æœ‰è€…åœ°å€
mapping(uint => address) public zombieToOwner;
// è®°å½•æŸåœ°å€æ‰€æ‹¥æœ‰çš„åƒµå°¸çš„æ•°é‡
mapping(address => uint) ownerZombieCount;
//... other code ...
```



#### ç¬¬3ç«  Msg.sender

ç°åœ¨æœ‰äº†ä¸€å¥—æ˜ å°„æ¥è®°å½•åƒµå°¸çš„æ‰€æœ‰æƒäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ `_createZombie` æ–¹æ³•æ¥è¿ç”¨å®ƒä»¬ã€‚

ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¦ç”¨åˆ° `msg.sender`ã€‚

##### msg.sender

åœ¨ Solidity ä¸­ï¼Œæœ‰ä¸€äº›å…¨å±€å˜é‡å¯ä»¥è¢«æ‰€æœ‰å‡½æ•°è°ƒç”¨ã€‚ å…¶ä¸­ä¸€ä¸ªå°±æ˜¯ `msg.sender`ï¼Œå®ƒæŒ‡çš„æ˜¯å½“å‰è°ƒç”¨è€…ï¼ˆæˆ–æ™ºèƒ½åˆçº¦ï¼‰çš„ `address`ã€‚

> æ³¨æ„ï¼šåœ¨ Solidity ä¸­ï¼ŒåŠŸèƒ½æ‰§è¡Œå§‹ç»ˆéœ€è¦ä»å¤–éƒ¨è°ƒç”¨è€…å¼€å§‹ã€‚ ä¸€ä¸ªåˆçº¦åªä¼šåœ¨åŒºå—é“¾ä¸Šä»€ä¹ˆä¹Ÿä¸åšï¼Œé™¤éæœ‰äººè°ƒç”¨å…¶ä¸­çš„å‡½æ•°ã€‚æ‰€ä»¥ `msg.sender`æ€»æ˜¯å­˜åœ¨çš„ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `msg.sender` æ¥æ›´æ–° `mapping` çš„ä¾‹å­ï¼š

```solidity
mapping (address => uint) favoriteNumber;

function setMyNumber(uint _myNumber) public {
  // æ›´æ–°æˆ‘ä»¬çš„ `favoriteNumber` æ˜ å°„æ¥å°† `_myNumber`å­˜å‚¨åœ¨ `msg.sender`åä¸‹
  favoriteNumber[msg.sender] = _myNumber;
  // å­˜å‚¨æ•°æ®è‡³æ˜ å°„çš„æ–¹æ³•å’Œå°†æ•°æ®å­˜å‚¨åœ¨æ•°ç»„ç›¸ä¼¼
}

function whatIsMyNumber() public view returns (uint) {
  // æ‹¿åˆ°å­˜å‚¨åœ¨è°ƒç”¨è€…åœ°å€åä¸‹çš„å€¼
  // è‹¥è°ƒç”¨è€…è¿˜æ²¡è°ƒç”¨ setMyNumberï¼Œ åˆ™å€¼ä¸º `0`
  return favoriteNumber[msg.sender];
}
```

åœ¨è¿™ä¸ªå°å°çš„ä¾‹å­ä¸­ï¼Œä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ `setMyNumber` åœ¨æˆ‘ä»¬çš„åˆçº¦ä¸­å­˜ä¸‹ä¸€ä¸ª `uint` å¹¶ä¸”ä¸ä»–ä»¬çš„åœ°å€ç›¸ç»‘å®šã€‚ ç„¶åï¼Œä»–ä»¬è°ƒç”¨ `whatIsMyNumber` å°±ä¼šè¿”å›ä»–ä»¬å­˜å‚¨çš„ `uint`ã€‚

ä½¿ç”¨ `msg.sender` å¾ˆå®‰å…¨ï¼Œå› ä¸ºå®ƒå…·æœ‰ä»¥å¤ªåŠåŒºå—é“¾çš„å®‰å…¨ä¿éšœ â€”â€” é™¤éçªƒå–ä¸ä»¥å¤ªåŠåœ°å€ç›¸å…³è”çš„ç§é’¥ï¼Œå¦åˆ™æ˜¯æ²¡æœ‰åŠæ³•ä¿®æ”¹å…¶ä»–äººçš„æ•°æ®çš„ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥ä¿®æ”¹ç¬¬1è¯¾çš„ `_createZombie` æ–¹æ³•ï¼Œå°†åƒµå°¸åˆ†é…ç»™å‡½æ•°è°ƒç”¨è€…å§ã€‚

1. é¦–å…ˆï¼Œåœ¨å¾—åˆ°æ–°çš„åƒµå°¸ `id` åï¼Œæ›´æ–° `zombieToOwner` æ˜ å°„ï¼Œåœ¨ `id` ä¸‹é¢å­˜å…¥ `msg.sender`ã€‚
2. ç„¶åï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ª `msg.sender` åä¸‹çš„ `ownerZombieCount` åŠ  1ã€‚

è·Ÿåœ¨ JavaScript ä¸­ä¸€æ ·ï¼Œ åœ¨ Solidity ä¸­ä½ ä¹Ÿå¯ä»¥ç”¨ `++` ä½¿ `uint` é€’å¢ã€‚

```solidity
uint number = 0;
number++;
// `number` ç°åœ¨æ˜¯ `1`äº†
```

ä¿®æ”¹ä¸¤è¡Œä»£ç å³å¯ã€‚

``` solidity
//... other code ...
uint id = zombies.length -1;
zombieToOwner[id] = msg.sender;
ownerZombieCount[msg.sender]++;
emit NewZombie(id, _name, _dna);
//... other code ...
```



#### ç¬¬4ç«  Require

åœ¨ç¬¬ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸè®©ç”¨æˆ·é€šè¿‡è°ƒç”¨ `createRandomZombie`å‡½æ•° å¹¶è¾“å…¥ä¸€ä¸ªåå­—æ¥åˆ›å»ºæ–°çš„åƒµå°¸ã€‚ ä½†æ˜¯ï¼Œå¦‚æœç”¨æˆ·èƒ½æŒç»­è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ›å»ºå‡ºæ— é™å¤šä¸ªåƒµå°¸åŠ å…¥ä»–ä»¬çš„å†›å›¢ï¼Œè¿™æ¸¸æˆå°±å¤ªæ²¡æ„æ€äº†ï¼

äºæ˜¯ï¼Œæˆ‘ä»¬ä½œå‡ºé™å®šï¼šæ¯ä¸ªç©å®¶åªèƒ½è°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ã€‚ è¿™æ ·ä¸€æ¥ï¼Œæ–°ç©å®¶å¯ä»¥åœ¨åˆšå¼€å§‹ç©æ¸¸æˆæ—¶é€šè¿‡è°ƒç”¨å®ƒï¼Œä¸ºå…¶å†›å›¢åˆ›å»ºåˆå§‹åƒµå°¸ã€‚

æˆ‘ä»¬æ€æ ·æ‰èƒ½é™å®šæ¯ä¸ªç©å®¶åªè°ƒç”¨ä¸€æ¬¡è¿™ä¸ªå‡½æ•°å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨`require`ã€‚ `require`ä½¿å¾—å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“ä¸æ»¡è¶³æŸäº›æ¡ä»¶æ—¶æŠ›å‡ºé”™è¯¯ï¼Œå¹¶åœæ­¢æ‰§è¡Œï¼š

```solidity
function sayHiToVitalik(string _name) public returns (string) {
  // æ¯”è¾ƒ _name æ˜¯å¦ç­‰äº "Vitalik". å¦‚æœä¸æˆç«‹ï¼ŒæŠ›å‡ºå¼‚å¸¸å¹¶ç»ˆæ­¢ç¨‹åº
  // (æ•²é»‘æ¿: Solidity å¹¶ä¸æ”¯æŒåŸç”Ÿçš„å­—ç¬¦ä¸²æ¯”è¾ƒ, æˆ‘ä»¬åªèƒ½é€šè¿‡æ¯”è¾ƒ
  // ä¸¤å­—ç¬¦ä¸²çš„ keccak256 å“ˆå¸Œå€¼æ¥è¿›è¡Œåˆ¤æ–­)
  require(keccak256(_name) == keccak256("Vitalik"));
  // å¦‚æœè¿”å› true, è¿è¡Œå¦‚ä¸‹è¯­å¥
  return "Hi!";
}
```

å¦‚æœä½ è¿™æ ·è°ƒç”¨å‡½æ•° `sayHiToVitalikï¼ˆâ€œVitalikâ€ï¼‰` ,å®ƒä¼šè¿”å›â€œHiï¼â€ã€‚è€Œå¦‚æœè°ƒç”¨çš„æ—¶å€™ä½¿ç”¨äº†å…¶ä»–å‚æ•°ï¼Œå®ƒåˆ™ä¼šæŠ›å‡ºé”™è¯¯å¹¶åœæ­¢æ‰§è¡Œã€‚

å› æ­¤ï¼Œåœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¹‹å‰ï¼Œç”¨ `require` éªŒè¯å‰ç½®æ¡ä»¶æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚

##### å®æˆ˜æ¼”ä¹ 

åœ¨æˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆä¸­ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·é€šè¿‡åå¤è°ƒç”¨ `createRandomZombie` æ¥çµ¦ä»–ä»¬çš„å†›é˜Ÿåˆ›å»ºæ— é™å¤šä¸ªåƒµå°¸ â€”â€” è¿™å°†ä½¿å¾—æ¸¸æˆéå¸¸æ— èŠã€‚

æˆ‘ä»¬ä½¿ç”¨äº† `require` æ¥ç¡®ä¿è¿™ä¸ªå‡½æ•°åªæœ‰åœ¨æ¯ä¸ªç”¨æˆ·ç¬¬ä¸€æ¬¡è°ƒç”¨å®ƒçš„æ—¶å€™æ‰§è¡Œï¼Œç”¨ä»¥åˆ›å»ºåˆå§‹åƒµå°¸ã€‚

1. åœ¨ `createRandomZombie` çš„å‰é¢æ”¾ç½® `require` è¯­å¥ã€‚ ä½¿å¾—å‡½æ•°å…ˆæ£€æŸ¥ `ownerZombieCount [msg.sender]` çš„å€¼ä¸º `0` ï¼Œä¸ç„¶å°±æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

> æ³¨æ„ï¼šåœ¨ Solidity ä¸­ï¼Œå…³é”®è¯æ”¾ç½®çš„é¡ºåºå¹¶ä¸é‡è¦
>
> - è™½ç„¶å‚æ•°çš„ä¸¤ä¸ªä½ç½®æ˜¯ç­‰æ•ˆçš„ã€‚ ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬çš„ç­”æ¡ˆæ£€æŸ¥å™¨æ¯”è¾ƒå‘†æ¿ï¼Œå®ƒåªèƒ½è®¤å®šå…¶ä¸­ä¸€ä¸ªä¸ºæ­£ç¡®ç­”æ¡ˆ
> - äºæ˜¯åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°±çº¦å®šæŠŠ`ownerZombieCount [msg.sender]`æ”¾å‰é¢å§

``` solidity
function createRandomZombie(string _name) public {
    // start here
    require(ownerZombieCount[msg.sender] == 0);
    uint randDna = _generateRandomDna(_name);
    _createZombie(_name, randDna);
}
```



#### ç¬¬5ç«  ç»§æ‰¿ï¼ˆInheritanceï¼‰

æˆ‘ä»¬çš„æ¸¸æˆä»£ç è¶Šæ¥è¶Šé•¿ã€‚ å½“ä»£ç è¿‡äºå†—é•¿çš„æ—¶å€™ï¼Œæœ€å¥½å°†ä»£ç å’Œé€»è¾‘åˆ†æ‹†åˆ°å¤šä¸ªä¸åŒçš„åˆçº¦ä¸­ï¼Œä»¥ä¾¿äºç®¡ç†ã€‚

æœ‰ä¸ªè®© Solidity çš„ä»£ç æ˜“äºç®¡ç†çš„åŠŸèƒ½ï¼Œå°±æ˜¯åˆçº¦ ***inheritance*** (ç»§æ‰¿)ï¼š

```solidity
contract Doge {
  function catchphrase() public returns (string) {
    return "So Wow CryptoDoge";
  }
}

contract BabyDoge is Doge {
  function anotherCatchphrase() public returns (string) {
    return "Such Moon BabyDoge";
  }
}
```

ç”±äº `BabyDoge` æ˜¯ä» `Doge` é‚£é‡Œ ***inherits*** ï¼ˆç»§æ‰¿)è¿‡æ¥çš„ã€‚ è¿™æ„å‘³ç€å½“ä½ ç¼–è¯‘å’Œéƒ¨ç½²äº† `BabyDoge`ï¼Œå®ƒå°†å¯ä»¥è®¿é—® `catchphrase()` å’Œ `anotherCatchphrase()`å’Œå…¶ä»–æˆ‘ä»¬åœ¨ `Doge` ä¸­å®šä¹‰çš„å…¶ä»–å…¬å…±å‡½æ•°ã€‚

è¿™å¯ä»¥ç”¨äºé€»è¾‘ç»§æ‰¿ï¼ˆæ¯”å¦‚è¡¨è¾¾å­ç±»çš„æ—¶å€™ï¼Œ`Cat` æ˜¯ä¸€ç§ `Animal`ï¼‰ã€‚ ä½†ä¹Ÿå¯ä»¥ç®€å•åœ°å°†ç±»ä¼¼çš„é€»è¾‘ç»„åˆåˆ°ä¸åŒçš„åˆçº¦ä¸­ä»¥ç»„ç»‡ä»£ç ã€‚

##### å®æˆ˜æ¼”ä¹ 

åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¦ä¸ºåƒµå°¸å®ç°å„ç§åŠŸèƒ½ï¼Œè®©å®ƒå¯ä»¥â€œçŒé£Ÿâ€å’Œâ€œç¹æ®–â€ã€‚ é€šè¿‡å°†è¿™äº›è¿ç®—æ”¾åˆ°çˆ¶ç±» `ZombieFactory` ä¸­ï¼Œä½¿å¾—æ‰€æœ‰ `ZombieFactory` çš„ç»§æ‰¿è€…åˆçº¦éƒ½å¯ä»¥ä½¿ç”¨è¿™äº›æ–¹æ³•ã€‚

1. åœ¨ `ZombieFactory` ä¸‹åˆ›å»ºä¸€ä¸ªå« `ZombieFeeding` çš„åˆçº¦ï¼Œå®ƒæ˜¯ç»§æ‰¿è‡ª `ZombieFactory åˆçº¦çš„ã€‚

``` solidity
contract ZombieFactory {
	// other code
}
contract ZombieFeeding is ZombieFactory {
}
```



#### ç¬¬6ç«  å¼•å…¥ï¼ˆImportï¼‰

å“‡ï¼ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬åªæ˜¯æ¸…ç†äº†ä¸‹å³è¾¹çš„ä»£ç ï¼Œç°åœ¨ä½ çš„ç¼–è¾‘å™¨çš„é¡¶éƒ¨å°±å¤šäº†ä¸ªé€‰é¡¹å¡ã€‚ å°è¯•ç‚¹å‡»å®ƒçš„æ ‡ç­¾ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå§ï¼

ä»£ç å·²ç»å¤Ÿé•¿äº†ï¼Œæˆ‘ä»¬æŠŠå®ƒåˆ†æˆå¤šä¸ªæ–‡ä»¶ä»¥ä¾¿äºç®¡ç†ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ Solidity é¡¹ç›®ä¸­çš„ä»£ç å¤ªé•¿çš„æ—¶å€™æˆ‘ä»¬å°±æ˜¯è¿™ä¹ˆåšçš„ã€‚

åœ¨ Solidity ä¸­ï¼Œå½“ä½ æœ‰å¤šä¸ªæ–‡ä»¶å¹¶ä¸”æƒ³æŠŠä¸€ä¸ªæ–‡ä»¶å¯¼å…¥å¦ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `import` è¯­å¥ï¼š

```solidity
import "./someothercontract.sol";

contract newContract is SomeOtherContract {

}
```

è¿™æ ·å½“æˆ‘ä»¬åœ¨åˆçº¦ï¼ˆcontractï¼‰ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸º `someothercontract.sol` çš„æ–‡ä»¶ï¼ˆ `./` å°±æ˜¯åŒä¸€ç›®å½•çš„æ„æ€ï¼‰ï¼Œå®ƒå°±ä¼šè¢«ç¼–è¯‘å™¨å¯¼å…¥ã€‚

##### å®æˆ˜æ¼”ä¹ 

ç°åœ¨æˆ‘ä»¬å·²ç»å»ºç«‹äº†ä¸€ä¸ªå¤šæ–‡ä»¶æ¶æ„ï¼Œå¹¶ç”¨ `import` æ¥è¯»å–æ¥è‡ªå¦ä¸€ä¸ªæ–‡ä»¶ä¸­åˆçº¦çš„å†…å®¹ï¼š

1.å°† `zombiefactory.sol` å¯¼å…¥åˆ°æˆ‘ä»¬çš„æ–°æ–‡ä»¶ `zombiefeeding.sol` ä¸­ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >= 0.4.19;

import "./zombiefactory.sol";

contract ZombieFeeding is ZombieFactory {
}
```



#### ç¬¬7ç«  Storageä¸Memory

åœ¨ Solidity ä¸­ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥å­˜å‚¨å˜é‡ â€”â€” `storage` æˆ– `memory`ã€‚

***Storage*** å˜é‡æ˜¯æŒ‡æ°¸ä¹…å­˜å‚¨åœ¨åŒºå—é“¾ä¸­çš„å˜é‡ã€‚ ***Memory*** å˜é‡åˆ™æ˜¯ä¸´æ—¶çš„ï¼Œå½“å¤–éƒ¨å‡½æ•°å¯¹æŸåˆçº¦è°ƒç”¨å®Œæˆæ—¶ï¼Œå†…å­˜å‹å˜é‡å³è¢«ç§»é™¤ã€‚ ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆå­˜å‚¨åœ¨ä½ ç”µè„‘çš„ç¡¬ç›˜æˆ–æ˜¯RAMä¸­æ•°æ®çš„å…³ç³»ã€‚

å¤§å¤šæ•°æ—¶å€™ä½ éƒ½ç”¨ä¸åˆ°è¿™äº›å…³é”®å­—ï¼Œé»˜è®¤æƒ…å†µä¸‹ Solidity ä¼šè‡ªåŠ¨å¤„ç†å®ƒä»¬ã€‚ çŠ¶æ€å˜é‡ï¼ˆåœ¨å‡½æ•°ä¹‹å¤–å£°æ˜çš„å˜é‡ï¼‰é»˜è®¤ä¸ºâ€œå­˜å‚¨â€å½¢å¼ï¼Œå¹¶æ°¸ä¹…å†™å…¥åŒºå—é“¾ï¼›è€Œåœ¨å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡æ˜¯â€œå†…å­˜â€å‹çš„ï¼Œå®ƒä»¬å‡½æ•°è°ƒç”¨ç»“æŸåæ¶ˆå¤±ã€‚

ç„¶è€Œä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¸‹ï¼Œä½ éœ€è¦æ‰‹åŠ¨å£°æ˜å­˜å‚¨ç±»å‹ï¼Œä¸»è¦ç”¨äºå¤„ç†å‡½æ•°å†…çš„ **_ ç»“æ„ä½“ _** å’Œ **_ æ•°ç»„ _** æ—¶ï¼š

```solidity
contract SandwichFactory {
  struct Sandwich {
    string name;
    string status;
  }

  Sandwich[] sandwiches;

  function eatSandwich(uint _index) public {
    // Sandwich mySandwich = sandwiches[_index];

    // ^ çœ‹ä¸Šå»å¾ˆç›´æ¥ï¼Œä¸è¿‡ Solidity å°†ä¼šç»™å‡ºè­¦å‘Š
    // å‘Šè¯‰ä½ åº”è¯¥æ˜ç¡®åœ¨è¿™é‡Œå®šä¹‰ `storage` æˆ–è€… `memory`ã€‚

    // æ‰€ä»¥ä½ åº”è¯¥æ˜ç¡®å®šä¹‰ `storage`:
    Sandwich storage mySandwich = sandwiches[_index];
    // ...è¿™æ · `mySandwich` æ˜¯æŒ‡å‘ `sandwiches[_index]`çš„æŒ‡é’ˆ
    // åœ¨å­˜å‚¨é‡Œï¼Œå¦å¤–...
    mySandwich.status = "Eaten!";
    // ...è¿™å°†æ°¸ä¹…æŠŠ `sandwiches[_index]` å˜ä¸ºåŒºå—é“¾ä¸Šçš„å­˜å‚¨

    // å¦‚æœä½ åªæƒ³è¦ä¸€ä¸ªå‰¯æœ¬ï¼Œå¯ä»¥ä½¿ç”¨`memory`:
    Sandwich memory anotherSandwich = sandwiches[_index + 1];
    // ...è¿™æ · `anotherSandwich` å°±ä»…ä»…æ˜¯ä¸€ä¸ªå†…å­˜é‡Œçš„å‰¯æœ¬äº†
    // å¦å¤–
    anotherSandwich.status = "Eaten!";
    // ...å°†ä»…ä»…ä¿®æ”¹ä¸´æ—¶å˜é‡ï¼Œå¯¹ `sandwiches[_index + 1]` æ²¡æœ‰ä»»ä½•å½±å“
    // ä¸è¿‡ä½ å¯ä»¥è¿™æ ·åš:
    sandwiches[_index + 1] = anotherSandwich;
    // ...å¦‚æœä½ æƒ³æŠŠå‰¯æœ¬çš„æ”¹åŠ¨ä¿å­˜å›åŒºå—é“¾å­˜å‚¨
  }
}
```

å¦‚æœä½ è¿˜æ²¡æœ‰å®Œå…¨ç†è§£ç©¶ç«Ÿåº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ªï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒ â€”â€” åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å‘Šè¯‰ä½ ä½•æ—¶ä½¿ç”¨ `storage` æˆ–æ˜¯ `memory`ï¼Œå¹¶ä¸”å½“ä½ ä¸å¾—ä¸ä½¿ç”¨åˆ°è¿™äº›å…³é”®å­—çš„æ—¶å€™ï¼ŒSolidity ç¼–è¯‘å™¨ä¹Ÿå‘è­¦ç¤ºæé†’ä½ çš„ã€‚

ç°åœ¨ï¼Œåªè¦çŸ¥é“åœ¨æŸäº›åœºåˆä¸‹ä¹Ÿéœ€è¦ä½ æ˜¾å¼åœ°å£°æ˜ `storage` æˆ– `memory`å°±å¤Ÿäº†ï¼

##### å®æˆ˜æ¼”ä¹ 

æ˜¯æ—¶å€™ç»™æˆ‘ä»¬çš„åƒµå°¸å¢åŠ â€œçŒé£Ÿâ€å’Œâ€œç¹æ®–â€åŠŸèƒ½äº†ï¼

å½“ä¸€ä¸ªåƒµå°¸çŒé£Ÿå…¶ä»–ç”Ÿç‰©ä½“æ—¶ï¼Œå®ƒè‡ªèº«çš„DNAå°†ä¸çŒç‰©ç”Ÿç‰©çš„DNAç»“åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„åƒµå°¸DNAã€‚

1. åˆ›å»ºä¸€ä¸ªåä¸º `feedAndMultiply` çš„å‡½æ•°ã€‚ ä½¿ç”¨ä¸¤ä¸ªå‚æ•°ï¼š`_zombieId`ï¼ˆ `uint`ç±»å‹ ï¼‰å’Œ`_targetDna` ï¼ˆä¹Ÿæ˜¯ `uint` ç±»å‹ï¼‰ã€‚ è®¾ç½®å±æ€§ä¸º `public` çš„ã€‚
2. æˆ‘ä»¬ä¸å¸Œæœ›åˆ«äººç”¨æˆ‘ä»¬çš„åƒµå°¸å»æ•çŒã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ç¡®ä¿å¯¹è‡ªå·±åƒµå°¸çš„æ‰€æœ‰æƒã€‚ é€šè¿‡æ·»åŠ ä¸€ä¸ª`require` è¯­å¥æ¥ç¡®ä¿ `msg.sender` åªèƒ½æ˜¯è¿™ä¸ªåƒµå°¸çš„ä¸»äººï¼ˆç±»ä¼¼äºæˆ‘ä»¬åœ¨ `createRandomZombie` å‡½æ•°ä¸­åšè¿‡çš„é‚£æ ·ï¼‰ã€‚

> æ³¨æ„ï¼šåŒæ ·ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç­”æ¡ˆæ£€æŸ¥å™¨æ¯”è¾ƒå‘†èŒï¼Œåªè®¤è¯†æŠŠ `msg.sender` æ”¾åœ¨å‰é¢çš„ç­”æ¡ˆï¼Œå¦‚æœä½ åˆ‡æ¢äº†å‚æ•°çš„é¡ºåºï¼Œå®ƒå°±ä¸è®¤å¾—äº†ã€‚ ä½†ä½ æ­£å¸¸ç¼–ç æ—¶ï¼Œå¦‚ä½•å®‰æ’å‚æ•°é¡ºåºéƒ½æ˜¯æ­£ç¡®çš„ã€‚

1. ä¸ºäº†è·å–è¿™ä¸ªåƒµå°¸çš„DNAï¼Œæˆ‘ä»¬çš„å‡½æ•°éœ€è¦å£°æ˜ä¸€ä¸ªåä¸º `myZombie` æ•°æ®ç±»å‹ä¸º`Zombie`çš„æœ¬åœ°å˜é‡ï¼ˆè¿™æ˜¯ä¸€ä¸ª `storage` å‹çš„æŒ‡é’ˆï¼‰ã€‚ å°†å…¶å€¼è®¾å®šä¸ºåœ¨ `zombies` æ•°ç»„ä¸­ç´¢å¼•ä¸º`_zombieId`æ‰€æŒ‡å‘çš„å€¼ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒåŒ…æ‹¬å‡½æ•°ç»“æŸç¬¦ `}` çš„é‚£ä¸€è¡Œï¼Œ æ€»å…±4è¡Œä»£ç ã€‚

ä¸‹ä¸€ç« é‡Œï¼Œæˆ‘ä»¬ä¼šç»§ç»­ä¸°å¯Œè¿™ä¸ªåŠŸèƒ½ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >=0.4.19;

import "./zombiefactory.sol";

contract ZombieFeeding is ZombieFactory {
    function feedAndMultiply(uint256 _zombieId, uint256 _targetDna) public {
        require(msg.sender == zombieToOwner[_zombieId]);
        Zombie storage myZombie = zombies[_zombieId];
    }
}
```



#### ç¬¬8ç«  åƒµå°¸çš„DNA

æˆ‘ä»¬æ¥æŠŠ `feedAndMultiply` å‡½æ•°å†™å®Œå§ã€‚

è·å–æ–°çš„åƒµå°¸DNAçš„å…¬å¼å¾ˆç®€å•ï¼šè®¡ç®—çŒé£Ÿåƒµå°¸DNAå’Œè¢«çŒåƒµå°¸DNAä¹‹é—´çš„å¹³å‡å€¼ã€‚

ä¾‹å¦‚ï¼š

```solidity
function testDnaSplicing() public {
  uint zombieDna = 2222222222222222;
  uint targetDna = 4444444444444444;
  uint newZombieDna = (zombieDna + targetDna) / 2;
  // newZombieDna å°†ç­‰äº 3333333333333333
}
```

ä»¥åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®©å‡½æ•°å˜å¾—æ›´å¤æ‚äº›ï¼Œæ¯”æ–¹ç»™æ–°çš„åƒµå°¸çš„ DNA å¢åŠ ä¸€äº›éšæœºæ€§ä¹‹ç±»çš„ã€‚ä½†ç°åœ¨å…ˆä»æœ€ç®€å•çš„å¼€å§‹ â€”â€” ä»¥åè¿˜å¯ä»¥å›æ¥å®Œå–„å®ƒå˜›ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. é¦–å…ˆæˆ‘ä»¬ç¡®ä¿ `_targetDna` ä¸é•¿äº16ä½ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½® `_targetDna` ä¸º `_targetDna ï¼… dnaModulus` ï¼Œå¹¶ä¸”åªå–å…¶æœ€å16ä½æ•°å­—ã€‚
2. æ¥ä¸‹æ¥ä¸ºæˆ‘ä»¬çš„å‡½æ•°å£°æ˜ä¸€ä¸ªåå« `newDna` çš„ `uint`ç±»å‹çš„å˜é‡ï¼Œå¹¶å°†å…¶å€¼è®¾ç½®ä¸º `myZombie`çš„ DNA å’Œ `_targetDna` çš„å¹³å‡å€¼ï¼ˆå¦‚ä¸Šä¾‹æ‰€ç¤ºï¼‰ã€‚

> æ³¨æ„ï¼šæ‚¨å¯ä»¥ç”¨ `myZombie.name` æˆ– `myZombie.dna` è®¿é—® `myZombie` çš„å±æ€§ã€‚

1. ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºæ–°çš„DNAï¼Œå†è°ƒç”¨ `_createZombie` å°±å¯ä»¥ç”Ÿæˆæ–°çš„åƒµå°¸äº†ã€‚å¦‚æœä½ å¿˜äº†è°ƒç”¨è¿™ä¸ªå‡½æ•°æ‰€éœ€è¦çš„å‚æ•°ï¼Œå¯ä»¥æŸ¥çœ‹ `zombiefactory.sol` é€‰é¡¹å¡ã€‚è¯·æ³¨æ„ï¼Œéœ€è¦å…ˆç»™å®ƒå‘½åï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬æŠŠæ–°çš„åƒµå°¸çš„åå­—è®¾ä¸º`NoName` - æˆ‘ä»¬å›å¤´å¯ä»¥ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥æ›´æ”¹åƒµå°¸çš„åå­—ã€‚

> æ³¨æ„ï¼šå¯¹äº Solidity é«˜æ‰‹ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°æˆ‘ä»¬çš„ä»£ç å­˜åœ¨ä¸€ä¸ªé—®é¢˜ã€‚åˆ«æ‹…å¿ƒï¼Œä¸‹ä¸€ç« ä¼šè§£å†³è¿™ä¸ªé—®é¢˜çš„ ;ï¼‰

``` solidity
function feedAndMultiply(uint256 _zombieId, uint256 _targetDna) public {
    require(msg.sender == zombieToOwner[_zombieId]);
    Zombie storage myZombie = zombies[_zombieId];

    _targetDna = _targetDna % dnaModulus;
    uint256 newDna = (myZombie.dna + _targetDna) / 2;
    _createZombie("NoName", newDna);
}
```



#### ç¬¬9ç« : æ›´å¤šå…³äºå‡½æ•°å¯è§æ€§

**æˆ‘ä»¬ä¸Šä¸€è¯¾çš„ä»£ç æœ‰é—®é¢˜ï¼**

ç¼–è¯‘çš„æ—¶å€™ç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚

é”™è¯¯åœ¨äºï¼Œæˆ‘ä»¬å°è¯•ä» `ZombieFeeding` ä¸­è°ƒç”¨ `_createZombie` å‡½æ•°ï¼Œä½† `_createZombie` å´æ˜¯ `ZombieFactory` çš„ `private` ï¼ˆç§æœ‰ï¼‰å‡½æ•°ã€‚è¿™æ„å‘³ç€ä»»ä½•ç»§æ‰¿è‡ª `ZombieFactory` çš„å­åˆçº¦éƒ½ä¸èƒ½è®¿é—®å®ƒã€‚

##### internal å’Œ external

é™¤ `public` å’Œ `private` å±æ€§ä¹‹å¤–ï¼ŒSolidity è¿˜ä½¿ç”¨äº†å¦å¤–ä¸¤ä¸ªæè¿°å‡½æ•°å¯è§æ€§çš„ä¿®é¥°è¯ï¼š`internal`ï¼ˆå†…éƒ¨ï¼‰ å’Œ `external`ï¼ˆå¤–éƒ¨ï¼‰ã€‚

`internal` å’Œ `private` ç±»ä¼¼ï¼Œä¸è¿‡ï¼Œ å¦‚æœæŸä¸ªåˆçº¦ç»§æ‰¿è‡ªå…¶çˆ¶åˆçº¦ï¼Œè¿™ä¸ªåˆçº¦å³å¯ä»¥è®¿é—®çˆ¶åˆçº¦ä¸­å®šä¹‰çš„â€œå†…éƒ¨â€å‡½æ•°ã€‚ï¼ˆå˜¿ï¼Œè¿™å¬èµ·æ¥æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„é‚£æ ·ï¼ï¼‰ã€‚

`external` ä¸`public` ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™äº›å‡½æ•°åªèƒ½åœ¨åˆçº¦ä¹‹å¤–è°ƒç”¨ - å®ƒä»¬ä¸èƒ½è¢«åˆçº¦å†…çš„å…¶ä»–å‡½æ•°è°ƒç”¨ã€‚ç¨åæˆ‘ä»¬å°†è®¨è®ºä»€ä¹ˆæ—¶å€™ä½¿ç”¨ `external` å’Œ `public`ã€‚

å£°æ˜å‡½æ•° `internal` æˆ– `external` ç±»å‹çš„è¯­æ³•ï¼Œä¸å£°æ˜ `private` å’Œ `public`ç±» å‹ç›¸åŒï¼š

```solidity
contract Sandwich {
  uint private sandwichesEaten = 0;

  function eat() internal {
    sandwichesEaten++;
  }
}

contract BLT is Sandwich {
  uint private baconSandwichesEaten = 0;

  function eatWithBacon() public returns (string) {
    baconSandwichesEaten++;
    // å› ä¸ºeat() æ˜¯internal çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½åœ¨è¿™é‡Œè°ƒç”¨
    eat();
  }
}
```

##### å®æˆ˜æ¼”ä¹ 

1. å°† `_createZombie()` å‡½æ•°çš„å±æ€§ä» `private` æ”¹ä¸º `internal` ï¼Œ ä½¿å¾—å…¶ä»–çš„åˆçº¦ä¹Ÿèƒ½è®¿é—®åˆ°å®ƒã€‚

   æˆ‘ä»¬å·²ç»æˆåŠŸæŠŠä½ çš„æ³¨æ„åŠ›é›†ä¸­åœ¨åˆ°`zombiefactory.sol`è¿™ä¸ªé€‰é¡¹å¡ä¸Šå•¦ã€‚

``` solidity
function _createZombie(string memory _name, uint _dna) internal {
    zombies.push(Zombie(_name, _dna));
    // è¿™é‡Œè§¦å‘äº‹ä»¶
    uint id = zombies.length -1;
    zombieToOwner[id] = msg.sender;
    ownerZombieCount[msg.sender]++;
    emit NewZombie(id, _name, _dna);
}
```



#### ç¬¬10ç« : åƒµå°¸åƒä»€ä¹ˆ?

æ˜¯æ—¶å€™è®©æˆ‘ä»¬çš„åƒµå°¸å»æ•çŒï¼ é‚£åƒµå°¸æœ€å–œæ¬¢çš„é£Ÿç‰©æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

Crypto åƒµå°¸å–œæ¬¢åƒçš„æ˜¯...

**CryptoKittiesï¼** ğŸ˜±ğŸ˜±ğŸ˜±

ï¼ˆæ­£ç»ç‚¹ï¼Œæˆ‘å¯ä¸æ˜¯å¼€ç©ç¬‘ğŸ˜†ï¼‰

ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬è¦è¯»å‡º CryptoKitties æ™ºèƒ½åˆçº¦ä¸­çš„ kittyDnaã€‚è¿™äº›æ•°æ®æ˜¯å…¬å¼€å­˜å‚¨åœ¨åŒºå—é“¾ä¸Šçš„ã€‚åŒºå—é“¾æ˜¯ä¸æ˜¯å¾ˆé…·ï¼Ÿ

åˆ«æ‹…å¿ƒ â€”â€” æˆ‘ä»¬çš„æ¸¸æˆå¹¶ä¸ä¼šä¼¤å®³åˆ°ä»»ä½•çœŸæ­£çš„CryptoKittyã€‚ æˆ‘ä»¬åª *è¯»å–* CryptoKitties æ•°æ®ï¼Œä½†å´æ— æ³•åœ¨ç‰©ç†ä¸Šåˆ é™¤å®ƒã€‚

##### ä¸å…¶ä»–åˆçº¦çš„äº¤äº’

å¦‚æœæˆ‘ä»¬çš„åˆçº¦éœ€è¦å’ŒåŒºå—é“¾ä¸Šçš„å…¶ä»–çš„åˆçº¦ä¼šè¯ï¼Œåˆ™éœ€å…ˆå®šä¹‰ä¸€ä¸ª ***interface*** (æ¥å£)ã€‚

å…ˆä¸¾ä¸€ä¸ªç®€å•çš„æ —å­ã€‚ å‡è®¾åœ¨åŒºå—é“¾ä¸Šæœ‰è¿™ä¹ˆä¸€ä¸ªåˆçº¦ï¼š

```solidity
contract LuckyNumber {
  mapping(address => uint) numbers;

  function setNum(uint _num) public {
    numbers[msg.sender] = _num;
  }

  function getNum(address _myAddress) public view returns (uint) {
    return numbers[_myAddress];
  }
}
```

è¿™æ˜¯ä¸ªå¾ˆç®€å•çš„åˆçº¦ï¼Œæ‚¨å¯ä»¥ç”¨å®ƒå­˜å‚¨è‡ªå·±çš„å¹¸è¿å·ç ï¼Œå¹¶å°†å…¶ä¸æ‚¨çš„ä»¥å¤ªåŠåœ°å€å…³è”ã€‚ è¿™æ ·å…¶ä»–äººå°±å¯ä»¥é€šè¿‡æ‚¨çš„åœ°å€æŸ¥æ‰¾æ‚¨çš„å¹¸è¿å·ç äº†ã€‚

ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨åˆçº¦ï¼Œä½¿ç”¨ `getNum` å‡½æ•°å¯è¯»å–å…¶ä¸­çš„æ•°æ®ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ `LuckyNumber` åˆçº¦çš„ ***interface*** ï¼š

```solidity
interface NumberInterface {
  function getNum(address _myAddress) public view returns (uint);
}
```

è¯·æ³¨æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹è™½ç„¶çœ‹èµ·æ¥åƒåœ¨å®šä¹‰ä¸€ä¸ªåˆçº¦ï¼Œä½†å…¶å®å†…é‡Œä¸åŒï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬åªå£°æ˜äº†è¦ä¸ä¹‹äº¤äº’çš„å‡½æ•° â€”â€” åœ¨æœ¬ä¾‹ä¸­ä¸º `getNum` â€”â€” åœ¨å…¶ä¸­æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨åˆ°ä»»ä½•å…¶ä»–çš„å‡½æ•°æˆ–çŠ¶æ€å˜é‡ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨å¤§æ‹¬å·ï¼ˆ`{` å’Œ `}`ï¼‰å®šä¹‰å‡½æ•°ä½“ï¼Œæˆ‘ä»¬å•å•ç”¨åˆ†å·ï¼ˆ`;`ï¼‰ç»“æŸäº†å‡½æ•°å£°æ˜ã€‚è¿™ä½¿å®ƒçœ‹èµ·æ¥åƒä¸€ä¸ªåˆçº¦æ¡†æ¶ã€‚

ç¼–è¯‘å™¨å°±æ˜¯é è¿™äº›ç‰¹å¾è®¤å‡ºå®ƒæ˜¯ä¸€ä¸ªæ¥å£çš„ã€‚

åœ¨æˆ‘ä»¬çš„ app ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œåˆçº¦å°±çŸ¥é“å…¶ä»–åˆçº¦çš„å‡½æ•°æ˜¯æ€æ ·çš„ï¼Œåº”è¯¥å¦‚ä½•è°ƒç”¨ï¼Œä»¥åŠå¯æœŸå¾…ä»€ä¹ˆç±»å‹çš„è¿”å›å€¼ã€‚

åœ¨ä¸‹ä¸€è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†çœŸæ­£è°ƒç”¨å…¶ä»–åˆçº¦çš„å‡½æ•°ã€‚ç›®å‰æˆ‘ä»¬åªè¦å£°æ˜ä¸€ä¸ªæ¥å£ï¼Œç”¨äºè°ƒç”¨ CryptoKitties åˆçº¦å°±è¡Œäº†ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å·²ç»ä¸ºä½ æŸ¥çœ‹è¿‡äº† CryptoKitties çš„æºä»£ç ï¼Œå¹¶ä¸”æ‰¾åˆ°äº†ä¸€ä¸ªåä¸º `getKitty`çš„å‡½æ•°ï¼Œå®ƒè¿”å›æ‰€æœ‰çš„åŠ å¯†çŒ«çš„æ•°æ®ï¼ŒåŒ…æ‹¬å®ƒçš„â€œåŸºå› â€ï¼ˆæˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆè¦ç”¨å®ƒç”Ÿæˆæ–°çš„åƒµå°¸ï¼‰ã€‚

è¯¥å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```solidity
function getKitty(uint256 _id) external view returns (
    bool isGestating,
    bool isReady,
    uint256 cooldownIndex,
    uint256 nextActionAt,
    uint256 siringWithId,
    uint256 birthTime,
    uint256 matronId,
    uint256 sireId,
    uint256 generation,
    uint256 genes
) {
    Kitty storage kit = kitties[_id];

    // if this variable is 0 then it's not gestating
    isGestating = (kit.siringWithId != 0);
    isReady = (kit.cooldownEndBlock <= block.number);
    cooldownIndex = uint256(kit.cooldownIndex);
    nextActionAt = uint256(kit.cooldownEndBlock);
    siringWithId = uint256(kit.siringWithId);
    birthTime = uint256(kit.birthTime);
    matronId = uint256(kit.matronId);
    sireId = uint256(kit.sireId);
    generation = uint256(kit.generation);
    genes = kit.genes;
}
```

è¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥è·Ÿæˆ‘ä»¬ä¹ æƒ¯çš„å‡½æ•°ä¸å¤ªä¸€æ ·ã€‚ å®ƒç«Ÿç„¶è¿”å›äº†...ä¸€å †ä¸åŒçš„å€¼ï¼ å¦‚æœæ‚¨ç”¨è¿‡ JavaScript ä¹‹ç±»çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¸€å®šä¼šæ„Ÿåˆ°å¥‡æ€ª â€”â€” åœ¨ Solidityä¸­ï¼Œæ‚¨å¯ä»¥è®©ä¸€ä¸ªå‡½æ•°è¿”å›å¤šä¸ªå€¼ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“è¿™ä¸ªå‡½æ•°é•¿ä»€ä¹ˆæ ·çš„äº†ï¼Œå°±å¯ä»¥ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªæ¥å£ï¼š

1.å®šä¹‰ä¸€ä¸ªåä¸º `KittyInterface` çš„æ¥å£ã€‚ è¯·æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† `contract` å…³é”®å­—ï¼Œ è¿™è¿‡ç¨‹çœ‹èµ·æ¥å°±åƒåˆ›å»ºä¸€ä¸ªæ–°çš„åˆçº¦ä¸€æ ·ã€‚

2.åœ¨interfaceé‡Œå®šä¹‰äº† `getKitty` å‡½æ•°ï¼ˆä¸è¿‡æ˜¯å¤åˆ¶/ç²˜è´´ä¸Šé¢çš„å‡½æ•°ï¼Œä½†åœ¨ `returns` è¯­å¥ä¹‹åç”¨åˆ†å·ï¼Œè€Œä¸æ˜¯å¤§æ‹¬å·å†…çš„æ‰€æœ‰å†…å®¹ã€‚

``` solidity
interface KittyInterface {
    function getKitty(uint256 _id)
        external
        view
        returns (
            bool isGestating,
            bool isReady,
            uint256 cooldownIndex,
            uint256 nextActionAt,
            uint256 siringWithId,
            uint256 birthTime,
            uint256 matronId,
            uint256 sireId,
            uint256 generation,
            uint256 genes
        );
}
```



#### ç¬¬11ç«  ä½¿ç”¨æ¥å£

ç»§ç»­å‰é¢ `NumberInterface` çš„ä¾‹å­ï¼Œæˆ‘ä»¬æ—¢ç„¶å°†æ¥å£å®šä¹‰ä¸ºï¼š

```solidity
interface NumberInterface {
  function getNum(address _myAddress) public view returns (uint);
}
```

æˆ‘ä»¬å¯ä»¥åœ¨åˆçº¦ä¸­è¿™æ ·ä½¿ç”¨ï¼š

```solidity
contract MyContract {
  address NumberInterfaceAddress = 0xab38...;
  // ^ è¿™æ˜¯FavoriteNumberåˆçº¦åœ¨ä»¥å¤ªåŠä¸Šçš„åœ°å€
  NumberInterface numberContract = NumberInterface(NumberInterfaceAddress);
  // ç°åœ¨å˜é‡ `numberContract` æŒ‡å‘å¦ä¸€ä¸ªåˆçº¦å¯¹è±¡

  function someFunction() public {
    // ç°åœ¨æˆ‘ä»¬å¯ä»¥è°ƒç”¨åœ¨é‚£ä¸ªåˆçº¦ä¸­å£°æ˜çš„ `getNum`å‡½æ•°:
    uint num = numberContract.getNum(msg.sender);
    // ...åœ¨è¿™å„¿ä½¿ç”¨ `num`å˜é‡åšäº›ä»€ä¹ˆ
  }
}
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåªè¦å°†æ‚¨åˆçº¦çš„å¯è§æ€§è®¾ç½®ä¸º`public`(å…¬å…±)æˆ–`external`(å¤–éƒ¨)ï¼Œå®ƒä»¬å°±å¯ä»¥ä¸ä»¥å¤ªåŠåŒºå—é“¾ä¸Šçš„ä»»ä½•å…¶ä»–åˆçº¦è¿›è¡Œäº¤äº’ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥å»ºä¸ªè‡ªå·±çš„åˆçº¦å»è¯»å–å¦ä¸€ä¸ªæ™ºèƒ½åˆçº¦-- CryptoKitties çš„å†…å®¹å§ï¼

1. æˆ‘å·²ç»å°†ä»£ç ä¸­ CryptoKitties åˆçº¦çš„åœ°å€ä¿å­˜åœ¨ä¸€ä¸ªåä¸º `ckAddress` çš„å˜é‡ä¸­ã€‚åœ¨ä¸‹ä¸€è¡Œä¸­ï¼Œè¯·åˆ›å»ºä¸€ä¸ªåä¸º `kittyContract` çš„ KittyInterfaceï¼Œå¹¶ç”¨ `ckAddress` ä¸ºå®ƒåˆå§‹åŒ– â€”â€” å°±åƒæˆ‘ä»¬ä¸º `numberContract`æ‰€åšçš„ä¸€æ ·ã€‚



#### ç¬¬12ç«  å¤„ç†å¤šè¿”å›å€¼

`getKitty` æ˜¯æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ç¬¬ä¸€ä¸ªè¿”å›å¤šä¸ªå€¼çš„å‡½æ•°ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š

```solidity
function multipleReturns() internal returns(uint a, uint b, uint c) {
  return (1, 2, 3);
}

function processMultipleReturns() external {
  uint a;
  uint b;
  uint c;
  // è¿™æ ·æ¥åšæ‰¹é‡èµ‹å€¼:
  (a, b, c) = multipleReturns();
}

// æˆ–è€…å¦‚æœæˆ‘ä»¬åªæƒ³è¿”å›å…¶ä¸­ä¸€ä¸ªå˜é‡:
function getLastReturnValue() external {
  uint c;
  // å¯ä»¥å¯¹å…¶ä»–å­—æ®µç•™ç©º:
  (,,c) = multipleReturns();
}
```

##### å®æˆ˜æ¼”ä¹ 

æ˜¯æ—¶å€™ä¸ CryptoKitties åˆçº¦äº¤äº’èµ·æ¥äº†ï¼

æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œä» kitty åˆçº¦ä¸­è·å–å®ƒçš„åŸºå› ï¼š

1. åˆ›å»ºä¸€ä¸ªåä¸º `feedOnKitty` çš„å‡½æ•°ã€‚å®ƒéœ€è¦2ä¸ª `uint` ç±»å‹çš„å‚æ•°ï¼Œ`_zombieId` å’Œ`_kittyId` ï¼Œè¿™æ˜¯ä¸€ä¸ª `public` ç±»å‹çš„å‡½æ•°ã€‚

2. å‡½æ•°é¦–å…ˆè¦å£°æ˜ä¸€ä¸ªåä¸º `kittyDna` çš„ `uint`ã€‚

   > æ³¨æ„ï¼šåœ¨æˆ‘ä»¬çš„ `KittyInterface` ä¸­ï¼Œ`genes` æ˜¯ä¸€ä¸ª `uint256` ç±»å‹çš„å˜é‡ï¼Œä½†æ˜¯å¦‚æœä½ è®°å¾—ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€è¯¾ä¸­æåˆ°è¿‡ï¼Œ`uint` æ˜¯ `uint256` çš„åˆ«åï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬æ˜¯ä¸€å›äº‹ã€‚

3. è¿™ä¸ªå‡½æ•°æ¥ä¸‹æ¥è°ƒç”¨ `kittyContract.getKitty`å‡½æ•°, ä¼ å…¥ `_kittyId` ï¼Œå°†è¿”å›çš„ `genes` å­˜å‚¨åœ¨ `kittyDna` ä¸­ã€‚è®°ä½ â€”â€” `getKitty` ä¼šè¿”å›ä¸€å¤§å †å˜é‡ã€‚ ï¼ˆç¡®åˆ‡åœ°è¯´10ä¸ª - æˆ‘å·²ç»ä¸ºä½ æ•°è¿‡äº†ï¼Œä¸é”™å§ï¼ï¼‰ã€‚ä½†æ˜¯æˆ‘ä»¬åªå…³å¿ƒæœ€åä¸€ä¸ª-- `genes`ã€‚æ•°é€—å·çš„æ—¶å€™å°å¿ƒç‚¹å“¦ï¼

4. æœ€åï¼Œå‡½æ•°è°ƒç”¨äº† `feedAndMultiply` ï¼Œå¹¶ä¼ å…¥äº† `_zombieId` å’Œ `kittyDna` ä¸¤ä¸ªå‚æ•°ã€‚

``` solidity
function feedOnKitty(uint _zombieId, uint _kittyId) public {
    uint kittyDna;
    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);
    feedAndMultiply(_zombieId, kittyDna);
}
```



#### ç¬¬13ç«  å¥–åŠ±: Kitty åŸºå› 

æˆ‘ä»¬çš„åŠŸèƒ½é€»è¾‘ä¸»ä½“å·²ç»å®Œæˆäº†...ç°åœ¨è®©æˆ‘ä»¬æ¥æ·»ä¸€ä¸ªå¥–åŠ±åŠŸèƒ½å§ã€‚

è¿™æ ·å§ï¼Œç»™ä»å°çŒ«åˆ¶é€ å‡ºçš„åƒµå°¸æ·»åŠ äº›ç‰¹å¾ï¼Œä»¥æ˜¾ç¤ºä»–ä»¬æ˜¯çŒ«åƒµå°¸ã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå’±ä»¬åœ¨æ–°åƒµå°¸çš„DNAä¸­æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„å°çŒ«ä»£ç ã€‚

è¿˜è®°å¾—å—ï¼Œç¬¬ä¸€è¯¾ä¸­æˆ‘ä»¬æåˆ°ï¼Œæˆ‘ä»¬ç›®å‰åªä½¿ç”¨16ä½DNAçš„å‰12ä½æ•°æ¥æŒ‡å®šåƒµå°¸çš„å¤–è§‚ã€‚æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æœ€å2ä¸ªæ•°å­—æ¥å¤„ç†â€œç‰¹æ®Šâ€çš„ç‰¹å¾ã€‚

è¿™æ ·å§ï¼ŒæŠŠçŒ«åƒµå°¸DNAçš„æœ€åä¸¤ä¸ªæ•°å­—è®¾å®šä¸º`99`ï¼ˆå› ä¸ºçŒ«æœ‰9æ¡å‘½ï¼‰ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬è¿™ä¹ˆæ¥å†™ä»£ç ï¼š`å¦‚æœ`è¿™ä¸ªåƒµå°¸æ˜¯ä¸€åªçŒ«å˜æ¥çš„ï¼Œå°±å°†å®ƒDNAçš„æœ€åä¸¤ä½æ•°å­—è®¾ç½®ä¸º`99`ã€‚

##### if è¯­å¥

ifè¯­å¥çš„è¯­æ³•åœ¨ Solidity ä¸­ï¼Œä¸åœ¨ JavaScript ä¸­å·®ä¸å¤šï¼š

```solidity
function eatBLT(string sandwich) public {
  // çœ‹æ¸…æ¥šäº†ï¼Œå½“æˆ‘ä»¬æ¯”è¾ƒå­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œéœ€è¦æ¯”è¾ƒä»–ä»¬çš„ keccak256 å“ˆå¸Œç 
  if (keccak256(sandwich) == keccak256("BLT")) {
    eat();
  }
}
```

##### å®æˆ˜æ¼”ä¹ 

è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„åƒµå°¸ä»£ç ä¸­å®ç°å°çŒ«çš„åŸºå› ã€‚

1. é¦–å…ˆï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸‹ `feedAndMultiply` å‡½æ•°çš„å®šä¹‰ï¼Œç»™å®ƒä¼ å…¥ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šä¸€æ¡åä¸º `_species` çš„å­—ç¬¦ä¸²ã€‚

2. æ¥ä¸‹æ¥ï¼Œåœ¨æˆ‘ä»¬è®¡ç®—å‡ºæ–°çš„åƒµå°¸çš„DNAä¹‹åï¼Œæ·»åŠ ä¸€ä¸ª `if` è¯­å¥æ¥æ¯”è¾ƒ `_species` å’Œå­—ç¬¦ä¸² `"kitty"` çš„ `keccak256` å“ˆå¸Œå€¼ã€‚

3. åœ¨ `if` è¯­å¥ä¸­ï¼Œæˆ‘ä»¬ç”¨ `99` æ›¿æ¢äº†æ–°åƒµå°¸DNAçš„æœ€åä¸¤ä½æ•°å­—ã€‚å¯ä»¥è¿™ä¹ˆåšï¼š`newDna = newDna - newDna % 100 + 99;`ã€‚

   > è§£é‡Šï¼šå‡è®¾ `newDna` æ˜¯ `334455`ã€‚é‚£ä¹ˆ `newDna % 100` æ˜¯ `55`ï¼Œæ‰€ä»¥ `newDna - newDna % 100` å¾—åˆ° `334400`ã€‚æœ€ååŠ ä¸Š `99` å¯å¾—åˆ° `334499`ã€‚

4. æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹äº† `feedOnKitty` ä¸­çš„å‡½æ•°è°ƒç”¨ã€‚å½“å®ƒè°ƒç”¨ `feedAndMultiply` æ—¶ï¼Œå¢åŠ  `â€œkittyâ€` ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ã€‚

``` solidity
contract ZombieFeeding is ZombieFactory {

    address ckAddress = 0x06012c8cf97BEaD5deAe237070F9587f8E7A266d;
    KittyInterface kittyContract = KittyInterface(ckAddress);
    
    function feedAndMultiply(uint256 _zombieId, uint256 _targetDna, string memory _species) public {
        require(msg.sender == zombieToOwner[_zombieId]);
        Zombie storage myZombie = zombies[_zombieId];

        _targetDna = _targetDna % dnaModulus;
        uint256 newDna = (myZombie.dna + _targetDna) / 2;
        // è¿™é‡Œå¢åŠ ä¸€ä¸ª if è¯­å¥
        if(keccak256(abi.encode(_species)) == keccak256(abi.encode("kitty"))){
            newDna = newDna - newDna % 100 + 99;
        }
        _createZombie("NoName", newDna);
    }

    function feedOnKitty(uint _zombieId, uint _kittyId) public {
        uint kittyDna;
        (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);
        feedAndMultiply(_zombieId, kittyDna, "kitty");
    }
}
```



#### ç¬¬14ç«  æ”¾åœ¨ä¸€èµ·

è‡³æ­¤ï¼Œä½ å·²ç»å­¦å®Œç¬¬äºŒè¯¾äº†ï¼

æŸ¥çœ‹ä¸‹â†’_â†’çš„æ¼”ç¤ºï¼Œçœ‹çœ‹ä»–ä»¬æ€ä¹ˆè¿è¡Œèµ·æ¥å¾—å§ã€‚ç»§ç»­ï¼Œä½ è‚¯å®šç­‰ä¸åŠçœ‹å®Œè¿™ä¸€é¡µğŸ˜‰ã€‚ç‚¹å‡»å°çŒ«ï¼Œæ”»å‡»ï¼çœ‹åˆ°ä½ æ–©è·ä¸€ä¸ªæ–°çš„å°çŒ«åƒµå°¸äº†å§ï¼

##### JavaScript å®ç°

æˆ‘ä»¬åªç”¨ç¼–è¯‘å’Œéƒ¨ç½² `ZombieFeeding`ï¼Œå°±å¯ä»¥å°†è¿™ä¸ªåˆçº¦éƒ¨ç½²åˆ°ä»¥å¤ªåŠäº†ã€‚æˆ‘ä»¬æœ€ç»ˆå®Œæˆçš„è¿™ä¸ªåˆçº¦ç»§æ‰¿è‡ª `ZombieFactory`ï¼Œå› æ­¤å®ƒå¯ä»¥è®¿é—®è‡ªå·±å’Œçˆ¶è¾ˆåˆçº¦ä¸­çš„æ‰€æœ‰ public æ–¹æ³•ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¸æˆ‘ä»¬çš„åˆšéƒ¨ç½²çš„åˆçº¦è¿›è¡Œäº¤äº’çš„ä¾‹å­ï¼Œ è¿™ä¸ªä¾‹å­ä½¿ç”¨äº† JavaScript å’Œ web3.jsï¼š

```javascript
var abi = /* abi generated by the compiler */
var ZombieFeedingContract = web3.eth.contract(abi)
var contractAddress = /* our contract address on Ethereum after deploying */
var ZombieFeeding = ZombieFeedingContract.at(contractAddress)

// å‡è®¾æˆ‘ä»¬æœ‰æˆ‘ä»¬çš„åƒµå°¸IDå’Œè¦æ”»å‡»çš„çŒ«å’ªID
let zombieId = 1;
let kittyId = 1;

// è¦æ‹¿åˆ°çŒ«å’ªçš„DNAï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨å®ƒçš„APIã€‚è¿™äº›æ•°æ®ä¿å­˜åœ¨å®ƒä»¬çš„æœåŠ¡å™¨ä¸Šè€Œä¸æ˜¯åŒºå—é“¾ä¸Šã€‚
// å¦‚æœä¸€åˆ‡éƒ½åœ¨åŒºå—é“¾ä¸Šï¼Œæˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒå®ƒä»¬çš„æœåŠ¡å™¨æŒ‚äº†ï¼Œæˆ–è€…å®ƒä»¬ä¿®æ”¹äº†APIï¼Œ
// æˆ–è€…å› ä¸ºä¸å–œæ¬¢æˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆè€Œå°æ€äº†æˆ‘ä»¬
let apiUrl = "https://api.cryptokitties.co/kitties/" + kittyId
$.get(apiUrl, function(data) {
  let imgUrl = data.image_url
  // ä¸€äº›æ˜¾ç¤ºå›¾ç‰‡çš„ä»£ç 
})

// å½“ç”¨æˆ·ç‚¹å‡»ä¸€åªçŒ«å’ªçš„æ—¶å€™:
$(".kittyImage").click(function(e) {
  // è°ƒç”¨æˆ‘ä»¬åˆçº¦çš„ `feedOnKitty` å‡½æ•°
  ZombieFeeding.feedOnKitty(zombieId, kittyId)
})

// ä¾¦å¬æ¥è‡ªæˆ‘ä»¬åˆçº¦çš„æ–°åƒµå°¸äº‹ä»¶å¥½æ¥å¤„ç†
ZombieFactory.NewZombie(function(error, result) {
  if (error) return
  // è¿™ä¸ªå‡½æ•°ç”¨æ¥æ˜¾ç¤ºåƒµå°¸:
  generateZombie(result.zombieId, result.name, result.dna)
})
```

##### å®æˆ˜æ¼”ä¹ 

é€‰æ‹©ä¸€åªä½ æƒ³çŒé£Ÿçš„å°çŒ«ã€‚ä½ è‡ªå®¶åƒµå°¸çš„ DNA ä¼šå’Œå°çŒ«çš„ DNA ç»“åˆï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„å°çŒ«åƒµå°¸ï¼ŒåŠ å…¥ä½ çš„å†›å›¢ï¼

çœ‹åˆ°æ–°åƒµå°¸ä¸Šé‚£å¯çˆ±çš„çŒ«å’ªè…¿äº†ä¹ˆï¼Ÿè¿™æ˜¯æ–°åƒµå°¸æœ€åDNAä¸­æœ€åä¸¤ä½æ•°å­— `99` çš„åŠŸåŠ³ï¼

ä½ æƒ³è¦çš„è¯éšæ—¶å¯ä»¥é‡æ–°å¼€å§‹ã€‚æ•è·äº†ä¸€åªçŒ«å’ªåƒµå°¸ï¼Œä½ ä¸€å®šå¾ˆé«˜å…´å§ï¼ï¼ˆä¸è¿‡ä½ åªèƒ½æŒæœ‰ä¸€åªï¼‰ï¼Œç»§ç»­å‰è¿›åˆ°ä¸‹ä¸€ç« ï¼Œå®Œæˆç¬¬äºŒè¯¾å§ï¼

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/05/05/20220505101833.png" align="center" style="width:500px" />

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/05/05/20220505101937.png" align="center" style="width:500px" />

##### ä½ å¥½æ£’ï¼å¤ªæ£’å•¦ï¼ä½ å®Œæˆäº† CryptoZombies çš„ç¬¬äºŒè¯¾!

**æˆåŠŸè§£é”äº†:**

- GGè¢«å‡çº§åˆ°äºŒçº§!
- æ— åï½ åƒµå°¸å·²åŠ å…¥ä½ çš„éƒ¨é˜Ÿ! (åˆ«æ‹…å¿ƒï¼Œç¬¬ä¸‰èŠ‚è¯¾é‡Œä½ ä¼šæœ‰æœºä¼šæ”¹å®ƒçš„åå­—)

##### æ™’ä¸€æ™’ä½ çš„ CryptoKitty-çŒæ€è€…ï¼å’Œä½ çš„æœ‹å‹ä»¬åˆ†äº«ï¼

è¿™æ˜¯ä½ çš„åƒµå°¸çš„æ°¸ä¹…åœ°å€ï¼Œè®©ä½ çš„æœ‹å‹è·Ÿä½ ä¸€èµ·çŒæ€ CryptoKitties:

https://share.cryptozombies.io/zh/lesson/2/share/GG?id=Y3p8MjEwMTY2



### 1.3 é«˜çº§ Solidity ç†è®º

#### ç¬¬1ç«  æ™ºèƒ½åè®®çš„æ°¸å›ºæ€§

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬è®²çš„ Solidity å’Œå…¶ä»–è¯­è¨€æ²¡æœ‰è´¨çš„åŒºåˆ«ï¼Œå®ƒé•¿å¾—ä¹Ÿå¾ˆåƒ JavaScriptã€‚

ä½†æ˜¯ï¼Œåœ¨æœ‰å‡ ç‚¹ä»¥å¤ªåŠä¸Šçš„ DApp è·Ÿæ™®é€šçš„åº”ç”¨ç¨‹åºæœ‰ç€å¤©å£¤ä¹‹åˆ«ã€‚

ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä½ æŠŠæ™ºèƒ½åè®®ä¼ ä¸Šä»¥å¤ªåŠä¹‹åï¼Œå®ƒå°±å˜å¾—***ä¸å¯æ›´æ”¹\***, è¿™ç§æ°¸å›ºæ€§æ„å‘³ç€ä½ çš„ä»£ç æ°¸è¿œä¸èƒ½è¢«è°ƒæ•´æˆ–æ›´æ–°ã€‚

ä½ ç¼–è¯‘çš„ç¨‹åºä¼šä¸€ç›´ï¼Œæ°¸ä¹…çš„ï¼Œä¸å¯æ›´æ”¹çš„ï¼Œå­˜åœ¨ä»¥å¤ªåŠä¸Šã€‚è¿™å°±æ˜¯ Solidity ä»£ç çš„å®‰å…¨æ€§å¦‚æ­¤é‡è¦çš„ä¸€ä¸ªåŸå› ã€‚å¦‚æœä½ çš„æ™ºèƒ½åè®®æœ‰ä»»ä½•æ¼æ´ï¼Œå³ä½¿ä½ å‘ç°äº†ä¹Ÿæ— æ³•è¡¥æ•‘ã€‚ä½ åªèƒ½è®©ä½ çš„ç”¨æˆ·ä»¬æ”¾å¼ƒè¿™ä¸ªæ™ºèƒ½åè®®ï¼Œç„¶åè½¬ç§»åˆ°ä¸€ä¸ªæ–°çš„ä¿®å¤åçš„åˆçº¦ä¸Šã€‚

ä½†è¿™æ°å¥½ä¹Ÿæ˜¯æ™ºèƒ½åˆçº¦çš„ä¸€å¤§ä¼˜åŠ¿ã€‚ä»£ç è¯´æ˜ä¸€åˆ‡ã€‚å¦‚æœä½ å»è¯»æ™ºèƒ½åˆçº¦çš„ä»£ç ï¼Œå¹¶éªŒè¯å®ƒï¼Œä½ ä¼šå‘ç°ï¼Œä¸€æ—¦å‡½æ•°è¢«å®šä¹‰ä¸‹æ¥ï¼Œæ¯ä¸€æ¬¡çš„è¿è¡Œï¼Œç¨‹åºéƒ½ä¼šä¸¥æ ¼éµç…§å‡½æ•°ä¸­åŸæœ‰çš„ä»£ç é€»è¾‘ä¸€ä¸ä¸è‹Ÿåœ°æ‰§è¡Œï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒå‡½æ•°è¢«äººç¯¡æ”¹è€Œå¾—åˆ°æ„å¤–çš„ç»“æœã€‚

##### å¤–éƒ¨ä¾èµ–å…³ç³»

åœ¨ç¬¬2è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†åŠ å¯†å°çŒ«ï¼ˆCryptoKittiesï¼‰åˆçº¦çš„åœ°å€ç¡¬ç¼–ç åˆ° DApp ä¸­å»äº†ã€‚æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå¦‚æœåŠ å¯†å°çŒ«å‡ºäº†ç‚¹é—®é¢˜ï¼Œæ¯”æ–¹è¯´ï¼Œé›†ä½“æ¶ˆå¤±äº†ä¼šæ€ä¹ˆæ ·ï¼Ÿ è™½ç„¶è¿™ç§äº‹æƒ…å‡ ä¹ä¸å¯èƒ½å‘ç”Ÿï¼Œä½†æ˜¯ï¼Œå¦‚æœå°çŒ«æ²¡äº†ï¼Œæˆ‘ä»¬çš„ DApp ä¹Ÿä¼šéšä¹‹å¤±æ•ˆ -- å› ä¸ºæˆ‘ä»¬åœ¨ DApp çš„ä»£ç ä¸­ç”¨â€œç¡¬ç¼–ç â€çš„æ–¹å¼æŒ‡å®šäº†åŠ å¯†å°çŒ«çš„åœ°å€ï¼Œå¦‚æœè¿™ä¸ªæ ¹æ®åœ°å€æ‰¾ä¸åˆ°å°çŒ«ï¼Œæˆ‘ä»¬çš„åƒµå°¸ä¹Ÿå°±åƒä¸åˆ°å°çŒ«äº†ï¼Œè€ŒæŒ‰ç…§å‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬å´æ²¡æ³•ä¿®æ”¹åˆçº¦å»åº”ä»˜è¿™ä¸ªå˜åŒ–ï¼

å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ç¡¬ç¼–ç ï¼Œè€Œè¦é‡‡ç”¨â€œå‡½æ•°â€ï¼Œä»¥ä¾¿äº DApp çš„å…³é”®éƒ¨åˆ†å¯ä»¥ä»¥å‚æ•°å½¢å¼ä¿®æ”¹ã€‚

æ¯”æ–¹è¯´ï¼Œæˆ‘ä»¬ä¸å†ä¸€å¼€å§‹å°±æŠŠçŒç‰©åœ°å€ç»™å†™å…¥ä»£ç ï¼Œè€Œæ˜¯å†™ä¸ªå‡½æ•° `setKittyContractAddress`, è¿è¡Œæ—¶å†è®¾å®šçŒç‰©çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éšæ—¶å»é”å®šæ–°çš„çŒç‰©ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒåŠ å¯†å°çŒ«é›†ä½“æ¶ˆå¤±äº†ã€‚

##### å®æˆ˜æ¼”ä¹ 

è¯·ä¿®æ”¹ç¬¬2è¯¾çš„ä»£ç ï¼Œä½¿å¾—å¯ä»¥é€šè¿‡ç¨‹åºæ›´æ”¹ CryptoKitties åˆçº¦åœ°å€ã€‚

1. åˆ é™¤é‡‡ç”¨ç¡¬ç¼–ç  æ–¹å¼çš„ `ckAddress` ä»£ç è¡Œã€‚
2. ä¹‹å‰åˆ›å»º `kittyContract` å˜é‡çš„é‚£è¡Œä»£ç ï¼Œä¿®æ”¹ä¸ºå¯¹ `kittyContract` å˜é‡çš„å£°æ˜ -- æš‚æ—¶ä¸ç»™å®ƒæŒ‡å®šå…·ä½“çš„å®ä¾‹ã€‚
3. åˆ›å»ºåä¸º `setKittyContractAddress` çš„å‡½æ•°ï¼Œ å®ƒå¸¦ä¸€ä¸ªå‚æ•° `_address`ï¼ˆ`address`ç±»å‹ï¼‰ï¼Œ å¯è§æ€§è®¾ä¸º`external`ã€‚
4. åœ¨å‡½æ•°å†…éƒ¨ï¼Œæ·»åŠ ä¸€è¡Œä»£ç ï¼Œå°† `kittyContract` å˜é‡è®¾ç½®ä¸ºè¿”å›å€¼ï¼š`KittyInterfaceï¼ˆ_addressï¼‰`ã€‚

> æ³¨æ„ï¼šä½ å¯èƒ½ä¼šæ³¨æ„åˆ°è¿™ä¸ªåŠŸèƒ½æœ‰ä¸ªå®‰å…¨æ¼æ´ï¼Œåˆ«æ‹…å¿ƒ - å’±ä»¬åˆ°ä¸‹ä¸€ç« é‡Œè§£å†³å®ƒ;ï¼‰

``` solidity
contract ZombieFeeding is ZombieFactory {

    KittyInterface kittyContract;

    function setKittyContractAddress(address _address) external {
        kittyContract = KittyInterface(_address);
    }
    // ... other code ...
}
```



#### ç¬¬2ç«  Ownable Contracts

ä¸Šä¸€ç« ä¸­ï¼Œæ‚¨æœ‰æ²¡æœ‰å‘ç°ä»»ä½•å®‰å…¨æ¼æ´å‘¢ï¼Ÿ

å‘€ï¼`setKittyContractAddress` å¯è§æ€§å±…ç„¶ç”³æ˜ä¸ºâ€œå¤–éƒ¨çš„â€ï¼ˆ`external`ï¼‰ï¼Œå²‚ä¸æ˜¯ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨å®ƒï¼ ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•è°ƒç”¨è¯¥å‡½æ•°çš„äººéƒ½å¯ä»¥æ›´æ”¹ CryptoKitties åˆçº¦çš„åœ°å€ï¼Œä½¿å¾—å…¶ä»–äººéƒ½æ²¡æ³•å†è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºäº†ã€‚

æˆ‘ä»¬ç¡®å®æ˜¯å¸Œæœ›è¿™ä¸ªåœ°å€èƒ½å¤Ÿåœ¨åˆçº¦ä¸­ä¿®æ”¹ï¼Œä½†æˆ‘å¯æ²¡è¯´è®©æ¯ä¸ªäººå»æ”¹å®ƒå‘€ã€‚

è¦å¯¹ä»˜è¿™æ ·çš„æƒ…å†µï¼Œé€šå¸¸çš„åšæ³•æ˜¯æŒ‡å®šåˆçº¦çš„â€œæ‰€æœ‰æƒâ€ - å°±æ˜¯è¯´ï¼Œç»™å®ƒæŒ‡å®šä¸€ä¸ªä¸»äººï¼ˆæ²¡é”™ï¼Œå°±æ˜¯æ‚¨ï¼‰ï¼Œåªæœ‰ä¸»äººå¯¹å®ƒäº«æœ‰ç‰¹æƒã€‚

##### OpenZeppelinåº“çš„`Ownable` åˆçº¦

ä¸‹é¢æ˜¯ä¸€ä¸ª `Ownable` åˆçº¦çš„ä¾‹å­ï¼š æ¥è‡ª **_ OpenZeppelin _** Solidity åº“çš„ `Ownable` åˆçº¦ã€‚ OpenZeppelin æ˜¯ä¸»æ‰“å®‰ä¿å’Œç¤¾åŒºå®¡æŸ¥çš„æ™ºèƒ½åˆçº¦åº“ï¼Œæ‚¨å¯ä»¥åœ¨è‡ªå·±çš„ DAppsä¸­å¼•ç”¨ã€‚ç­‰æŠŠè¿™ä¸€è¯¾å­¦å®Œï¼Œæ‚¨ä¸è¦å‚¬æˆ‘ä»¬å‘å¸ƒä¸‹ä¸€è¯¾ï¼Œæœ€å¥½åˆ©ç”¨è¿™ä¸ªæ—¶é—´æŠŠ OpenZeppelin çš„ç½‘ç«™çœ‹çœ‹ï¼Œä¿ç®¡æ‚¨ä¼šå­¦åˆ°å¾ˆå¤šä¸œè¥¿ï¼

æŠŠæ¥¼ä¸‹è¿™ä¸ªåˆçº¦è¯»è¯»é€šï¼Œæ˜¯ä¸æ˜¯è¿˜æœ‰äº›æ²¡è§è¿‡ä»£ç ï¼Ÿåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬éšåä¼šè§£é‡Šã€‚

```solidity
/**
 * @title Ownable
 * @dev The Ownable contract has an owner address, and provides basic authorization control
 * functions, this simplifies the implementation of "user permissions".
 */
contract Ownable {
  address public owner;
  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);

  /**
   * @dev The Ownable constructor sets the original `owner` of the contract to the sender
   * account.
   */
  function Ownable() public {
    owner = msg.sender;
  }

  /**
   * @dev Throws if called by any account other than the owner.
   */
  modifier onlyOwner() {
    require(msg.sender == owner);
    _;
  }

  /**
   * @dev Allows the current owner to transfer control of the contract to a newOwner.
   * @param newOwner The address to transfer ownership to.
   */
  function transferOwnership(address newOwner) public onlyOwner {
    require(newOwner != address(0));
    OwnershipTransferred(owner, newOwner);
    owner = newOwner;
  }
}
```

ä¸‹é¢æœ‰æ²¡æœ‰æ‚¨æ²¡å­¦è¿‡çš„ä¸œä¸œï¼Ÿ

- æ„é€ å‡½æ•°ï¼š`function Ownable()`æ˜¯ä¸€ä¸ª **_ constructor_** (æ„é€ å‡½æ•°)ï¼Œæ„é€ å‡½æ•°ä¸æ˜¯å¿…é¡»çš„ï¼Œå®ƒä¸åˆçº¦åŒåï¼Œæ„é€ å‡½æ•°ä¸€ç”Ÿä¸­å”¯ä¸€çš„ä¸€æ¬¡æ‰§è¡Œï¼Œå°±æ˜¯åœ¨åˆçº¦æœ€åˆè¢«åˆ›å»ºçš„æ—¶å€™ã€‚
- å‡½æ•°ä¿®é¥°ç¬¦ï¼š`modifier onlyOwner()`ã€‚ ä¿®é¥°ç¬¦è·Ÿå‡½æ•°å¾ˆç±»ä¼¼ï¼Œä¸è¿‡æ˜¯ç”¨æ¥ä¿®é¥°å…¶ä»–å·²æœ‰å‡½æ•°ç”¨çš„ï¼Œ åœ¨å…¶ä»–è¯­å¥æ‰§è¡Œå‰ï¼Œä¸ºå®ƒæ£€æŸ¥ä¸‹å…ˆéªŒæ¡ä»¶ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™ä¸ªä¿®é¥°ç¬¦ `onlyOwner` æ£€æŸ¥ä¸‹è°ƒç”¨è€…ï¼Œç¡®ä¿åªæœ‰åˆçº¦çš„ä¸»äººæ‰èƒ½è¿è¡Œæœ¬å‡½æ•°ã€‚æˆ‘ä»¬ä¸‹ä¸€ç« ä¸­ä¼šè¯¦ç»†è®²è¿°ä¿®é¥°ç¬¦ï¼Œä»¥åŠé‚£ä¸ªå¥‡æ€ªçš„`_;`ã€‚
- `indexed` å…³é”®å­—ï¼šåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬è¿˜ç”¨ä¸åˆ°å®ƒã€‚

æ‰€ä»¥`Ownable` åˆçº¦åŸºæœ¬éƒ½ä¼šè¿™ä¹ˆå¹²ï¼š

1. åˆçº¦åˆ›å»ºï¼Œæ„é€ å‡½æ•°å…ˆè¡Œï¼Œå°†å…¶ `owner` è®¾ç½®ä¸º`msg.sender`ï¼ˆå…¶éƒ¨ç½²è€…ï¼‰
2. ä¸ºå®ƒåŠ ä¸Šä¸€ä¸ªä¿®é¥°ç¬¦ `onlyOwner`ï¼Œå®ƒä¼šé™åˆ¶é™Œç”Ÿäººçš„è®¿é—®ï¼Œå°†è®¿é—®æŸäº›å‡½æ•°çš„æƒé™é”å®šåœ¨ `owner` ä¸Šã€‚
3. å…è®¸å°†åˆçº¦æ‰€æœ‰æƒè½¬è®©ç»™ä»–äººã€‚

`onlyOwner` ç®€ç›´äººè§äººçˆ±ï¼Œå¤§å¤šæ•°äººå¼€å‘è‡ªå·±çš„ Solidity DAppsï¼Œéƒ½æ˜¯ä»å¤åˆ¶/ç²˜è´´ `Ownable` å¼€å§‹çš„ï¼Œä»å®ƒå†ç»§æ‰¿å‡ºçš„å­ç±»ï¼Œå¹¶åœ¨ä¹‹ä¸Šè¿›è¡ŒåŠŸèƒ½å¼€å‘ã€‚

æ—¢ç„¶æˆ‘ä»¬æƒ³æŠŠ `setKittyContractAddress` é™åˆ¶ä¸º `onlyOwner` ï¼Œæˆ‘ä»¬ä¹Ÿè¦åšåŒæ ·çš„äº‹æƒ…ã€‚

##### å®æˆ˜æ¼”ä¹ 

é¦–å…ˆï¼Œå°† `Ownable` åˆçº¦çš„ä»£ç å¤åˆ¶ä¸€ä»½åˆ°æ–°æ–‡ä»¶ `ownable.sol` ä¸­ã€‚ æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ª `ZombieFactory`ï¼Œç»§æ‰¿ `Ownable`ã€‚

1.åœ¨ç¨‹åºä¸­å¯¼å…¥ `ownable.sol` çš„å†…å®¹ã€‚ å¦‚æœæ‚¨ä¸è®°å¾—æ€ä¹ˆåšäº†ï¼Œå‚è€ƒä¸‹ `zombiefeeding.sol`ã€‚

2.ä¿®æ”¹ `ZombieFactory` åˆçº¦ï¼Œ è®©å®ƒç»§æ‰¿è‡ª `Ownable`ã€‚ å¦‚æœæ‚¨ä¸è®°å¾—æ€ä¹ˆåšäº†ï¼Œçœ‹çœ‹ `zombiefeeding.sol`ã€‚

``` solidity
// 1. åœ¨è¿™é‡Œå¯¼å…¥
import "./ownable.sol";
// 2. åœ¨è¿™é‡Œç»§æ‰¿:
contract ZombieFactory is Ownable {
	// ... other code ...
}
```



#### ç¬¬3ç«  onlyOwner å‡½æ•°ä¿®é¥°ç¬¦

ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸ªåŸºæœ¬ç‰ˆçš„åˆçº¦ `ZombieFactory` äº†ï¼Œå®ƒç»§æ‰¿è‡ª `Ownable` æ¥å£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™ `ZombieFeeding` åŠ ä¸Š `onlyOwner` å‡½æ•°ä¿®é¥°ç¬¦ã€‚

è¿™å°±æ˜¯åˆçº¦ç»§æ‰¿çš„å·¥ä½œåŸç†ã€‚è®°å¾—ï¼š

```
ZombieFeeding æ˜¯ä¸ª ZombieFactory
ZombieFactory æ˜¯ä¸ª Ownable
```

å› æ­¤ `ZombieFeeding` ä¹Ÿæ˜¯ä¸ª `Ownable`, å¹¶å¯ä»¥é€šè¿‡ `Ownable` æ¥å£è®¿é—®çˆ¶ç±»ä¸­çš„å‡½æ•°/äº‹ä»¶/ä¿®é¥°ç¬¦ã€‚å¾€åï¼Œ`ZombieFeeding` çš„ç»§æ‰¿è€…åˆçº¦ä»¬åŒæ ·ä¹Ÿå¯ä»¥è¿™ä¹ˆå»¶ç»­ä¸‹å»ã€‚

##### å‡½æ•°ä¿®é¥°ç¬¦

å‡½æ•°ä¿®é¥°ç¬¦çœ‹èµ·æ¥è·Ÿå‡½æ•°æ²¡ä»€ä¹ˆä¸åŒï¼Œä¸è¿‡å…³é”®å­—`modifier` å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™æ˜¯ä¸ª`modifier(ä¿®é¥°ç¬¦)`ï¼Œè€Œä¸æ˜¯ä¸ª`function(å‡½æ•°)`ã€‚å®ƒä¸èƒ½åƒå‡½æ•°é‚£æ ·è¢«ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½è¢«æ·»åŠ åˆ°å‡½æ•°å®šä¹‰çš„æœ«å°¾ï¼Œç”¨ä»¥æ”¹å˜å‡½æ•°çš„è¡Œä¸ºã€‚

å’±ä»¬ä»”ç»†è¯»è¯» `onlyOwner`:

```solidity
/**
 * @dev è°ƒç”¨è€…ä¸æ˜¯â€˜ä¸»äººâ€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸
 */
modifier onlyOwner() {
  require(msg.sender == owner);
  _;
}
```

`onlyOwner` å‡½æ•°ä¿®é¥°ç¬¦æ˜¯è¿™ä¹ˆç”¨çš„ï¼š

```solidity
contract MyContract is Ownable {
  event LaughManiacally(string laughter);

  //æ³¨æ„ï¼ `onlyOwner`ä¸Šåœº :
  function likeABoss() external onlyOwner {
    LaughManiacally("Muahahahaha");
  }
}
```

æ³¨æ„ `likeABoss` å‡½æ•°ä¸Šçš„ `onlyOwner` ä¿®é¥°ç¬¦ã€‚ å½“ä½ è°ƒç”¨ `likeABoss` æ—¶ï¼Œ**é¦–å…ˆæ‰§è¡Œ** `onlyOwner` ä¸­çš„ä»£ç ï¼Œ æ‰§è¡Œåˆ° `onlyOwner` ä¸­çš„ `_;` è¯­å¥æ—¶ï¼Œç¨‹åºå†è¿”å›å¹¶æ‰§è¡Œ `likeABoss` ä¸­çš„ä»£ç ã€‚

å¯è§ï¼Œå°½ç®¡å‡½æ•°ä¿®é¥°ç¬¦ä¹Ÿå¯ä»¥åº”ç”¨åˆ°å„ç§åœºåˆï¼Œä½†æœ€å¸¸è§çš„è¿˜æ˜¯æ”¾åœ¨å‡½æ•°æ‰§è¡Œä¹‹å‰æ·»åŠ å¿«é€Ÿçš„ `require`æ£€æŸ¥ã€‚

å› ä¸ºç»™å‡½æ•°æ·»åŠ äº†ä¿®é¥°ç¬¦ `onlyOwner`ï¼Œä½¿å¾—**å”¯æœ‰åˆçº¦çš„ä¸»äºº**ï¼ˆä¹Ÿå°±æ˜¯éƒ¨ç½²è€…ï¼‰æ‰èƒ½è°ƒç”¨å®ƒã€‚

> æ³¨æ„ï¼šä¸»äººå¯¹åˆçº¦äº«æœ‰çš„ç‰¹æƒå½“ç„¶æ˜¯æ­£å½“çš„ï¼Œä¸è¿‡ä¹Ÿå¯èƒ½è¢«æ¶æ„ä½¿ç”¨ã€‚æ¯”å¦‚ï¼Œä¸‡ä¸€ï¼Œä¸»äººæ·»åŠ äº†ä¸ªåé—¨ï¼Œå…è®¸ä»–å·èµ°åˆ«äººçš„åƒµå°¸å‘¢ï¼Ÿ

> æ‰€ä»¥éå¸¸é‡è¦çš„æ˜¯ï¼Œéƒ¨ç½²åœ¨ä»¥å¤ªåŠä¸Šçš„ DAppï¼Œå¹¶ä¸èƒ½ä¿è¯å®ƒçœŸæ­£åšåˆ°å»ä¸­å¿ƒï¼Œä½ éœ€è¦é˜…è¯»å¹¶ç†è§£å®ƒçš„æºä»£ç ï¼Œæ‰èƒ½é˜²æ­¢å…¶ä¸­æ²¡æœ‰è¢«éƒ¨ç½²è€…æ¶æ„æ¤å…¥åé—¨ï¼›ä½œä¸ºå¼€å‘äººå‘˜ï¼Œå¦‚ä½•åšåˆ°æ—¢è¦ç»™è‡ªå·±ç•™ä¸‹ä¿®å¤ bug çš„ä½™åœ°ï¼Œåˆè¦å°½é‡åœ°æ”¾æƒç»™ä½¿ç”¨è€…ï¼Œä»¥ä¾¿è®©ä»–ä»¬æ”¾å¿ƒä½ ï¼Œä»è€Œæ„¿æ„æŠŠæ•°æ®æ”¾åœ¨ä½ çš„ DApp ä¸­ï¼Œè¿™ç¡®å®éœ€è¦ä¸ªå¾®å¦™çš„å¹³è¡¡ã€‚

##### å®æˆ˜æ¼”ä¹ 

ç°åœ¨æˆ‘ä»¬å¯ä»¥é™åˆ¶ç¬¬ä¸‰æ–¹å¯¹ `setKittyContractAddress`çš„è®¿é—®ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±ï¼Œè°éƒ½æ— æ³•å»ä¿®æ”¹å®ƒã€‚

1. å°† `onlyOwner` å‡½æ•°ä¿®é¥°ç¬¦æ·»åŠ åˆ° `setKittyContractAddress` ä¸­ã€‚

``` solidity
function setKittyContractAddress(address _address) external onlyOwner {
    kittyContract = KittyInterface(_address);
}
```



#### ç¬¬4ç«  Gas

å‰å®³ï¼ç°åœ¨æˆ‘ä»¬æ‡‚äº†å¦‚ä½•åœ¨ç¦æ­¢ç¬¬ä¸‰æ–¹ä¿®æ”¹æˆ‘ä»¬çš„åˆçº¦çš„åŒæ—¶ï¼Œç•™ä¸ªåé—¨ç»™å’±ä»¬è‡ªå·±å»ä¿®æ”¹ã€‚

è®©æˆ‘ä»¬æ¥çœ‹å¦ä¸€ç§ä½¿å¾— Solidity ç¼–ç¨‹è¯­è¨€ä¸ä¼—ä¸åŒçš„ç‰¹å¾ï¼š

##### Gas - é©±åŠ¨ä»¥å¤ªåŠDAppsçš„èƒ½æº

åœ¨ Solidity ä¸­ï¼Œä½ çš„ç”¨æˆ·æƒ³è¦æ¯æ¬¡æ‰§è¡Œä½ çš„ DApp éƒ½éœ€è¦æ”¯ä»˜ä¸€å®šçš„ ***gas***ï¼Œgas å¯ä»¥ç”¨ä»¥å¤ªå¸è´­ä¹°ï¼Œå› æ­¤ï¼Œç”¨æˆ·æ¯æ¬¡è·‘ DApp éƒ½å¾—èŠ±è´¹ä»¥å¤ªå¸ã€‚

ä¸€ä¸ª DApp æ”¶å–å¤šå°‘ gas å–å†³äºåŠŸèƒ½é€»è¾‘çš„å¤æ‚ç¨‹åº¦ã€‚æ¯ä¸ªæ“ä½œèƒŒåï¼Œéƒ½åœ¨è®¡ç®—å®Œæˆè¿™ä¸ªæ“ä½œæ‰€éœ€è¦çš„è®¡ç®—èµ„æºï¼Œï¼ˆæ¯”å¦‚ï¼Œå­˜å‚¨æ•°æ®å°±æ¯”åšä¸ªåŠ æ³•è¿ç®—è´µå¾—å¤šï¼‰ï¼Œ ä¸€æ¬¡æ“ä½œæ‰€éœ€è¦èŠ±è´¹çš„ ***gas*** ç­‰äºè¿™ä¸ªæ“ä½œèƒŒåçš„æ‰€æœ‰è¿ç®—èŠ±é”€çš„æ€»å’Œã€‚

ç”±äºè¿è¡Œä½ çš„ç¨‹åºéœ€è¦èŠ±è´¹ç”¨æˆ·çš„çœŸé‡‘ç™½é“¶ï¼Œåœ¨ä»¥å¤ªåŠä¸­ä»£ç çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ¯”å…¶ä»–ä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½æ›´å¼ºè°ƒä¼˜åŒ–ã€‚åŒæ ·çš„åŠŸèƒ½ï¼Œä½¿ç”¨ç¬¨æ‹™çš„ä»£ç å¼€å‘çš„ç¨‹åºï¼Œæ¯”èµ·ç»è¿‡ç²¾å·§ä¼˜åŒ–çš„ä»£ç æ¥ï¼Œè¿è¡ŒèŠ±è´¹æ›´é«˜ï¼Œè¿™æ˜¾ç„¶ä¼šç»™æˆåƒä¸Šä¸‡çš„ç”¨æˆ·å¸¦æ¥å¤§é‡ä¸å¿…è¦çš„å¼€é”€ã€‚

##### ä¸ºä»€ä¹ˆè¦ç”¨ ***gas*** æ¥é©±åŠ¨ï¼Ÿ

ä»¥å¤ªåŠå°±åƒä¸€ä¸ªå·¨å¤§ã€ç¼“æ…¢ã€ä½†éå¸¸å®‰å…¨çš„ç”µè„‘ã€‚å½“ä½ è¿è¡Œä¸€ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œç½‘ç»œä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åœ¨è¿›è¡Œç›¸åŒçš„è¿ç®—ï¼Œä»¥éªŒè¯å®ƒçš„è¾“å‡º â€”â€” è¿™å°±æ˜¯æ‰€è°“çš„â€œå»ä¸­å¿ƒåŒ–â€ ç”±äºæ•°ä»¥åƒè®¡çš„èŠ‚ç‚¹åŒæ—¶åœ¨éªŒè¯ç€æ¯ä¸ªåŠŸèƒ½çš„è¿è¡Œï¼Œè¿™å¯ä»¥ç¡®ä¿å®ƒçš„æ•°æ®ä¸ä¼šè¢«è¢«ç›‘æ§ï¼Œæˆ–è€…è¢«åˆ»æ„ä¿®æ”¹ã€‚

å¯èƒ½ä¼šæœ‰ç”¨æˆ·ç”¨æ— é™å¾ªç¯å µå¡ç½‘ç»œï¼ŒæŠ‘æˆ–ç”¨å¯†é›†è¿ç®—æ¥å ç”¨å¤§é‡çš„ç½‘ç»œèµ„æºï¼Œä¸ºäº†é˜²æ­¢è¿™ç§äº‹æƒ…çš„å‘ç”Ÿï¼Œä»¥å¤ªåŠçš„åˆ›å»ºè€…ä¸ºä»¥å¤ªåŠä¸Šçš„èµ„æºåˆ¶å®šäº†ä»·æ ¼ï¼Œæƒ³è¦åœ¨ä»¥å¤ªåŠä¸Šè¿ç®—æˆ–è€…å­˜å‚¨ï¼Œä½ éœ€è¦å…ˆä»˜è´¹ã€‚

> æ³¨æ„ï¼šå¦‚æœä½ ä½¿ç”¨ä¾§é“¾ï¼Œå€’æ˜¯ä¸ä¸€å®šéœ€è¦ä»˜è´¹ï¼Œæ¯”å¦‚å’±ä»¬åœ¨ Loom Network ä¸Šæ„å»ºçš„ CryptoZombies å°±å…è´¹ã€‚ä½ ä¸ä¼šæƒ³è¦åœ¨ä»¥å¤ªåŠä¸»ç½‘ä¸Šç©å„¿â€œé­”å…½ä¸–ç•Œâ€å§ï¼Ÿ - æ‰€éœ€è¦çš„ gas å¯èƒ½ä¼šä¹°åˆ°ä½ ç ´äº§ã€‚ä½†æ˜¯ä½ å¯ä»¥æ‰¾ä¸ªç®—æ³•ç†å¿µä¸åŒçš„ä¾§é“¾æ¥ç©å®ƒã€‚æˆ‘ä»¬å°†åœ¨ä»¥åçš„è¯¾ç¨‹ä¸­å’±ä»¬ä¼šè®¨è®ºåˆ°ï¼Œä»€ä¹ˆæ ·çš„ DApp åº”è¯¥éƒ¨ç½²åœ¨å¤ªåŠä¸»é“¾ä¸Šï¼Œä»€ä¹ˆåˆæœ€å¥½æ”¾åœ¨ä¾§é“¾ã€‚

##### çœ gas çš„æ‹›æ•°ï¼šç»“æ„å°è£… ï¼ˆStruct packingï¼‰

åœ¨ç¬¬1è¯¾ä¸­ï¼Œæˆ‘ä»¬æåˆ°é™¤äº†åŸºæœ¬ç‰ˆçš„ `uint` å¤–ï¼Œè¿˜æœ‰å…¶ä»–å˜ç§ `uint`ï¼š`uint8`ï¼Œ`uint16`ï¼Œ`uint32`ç­‰ã€‚

é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè€ƒè™‘ä½¿ç”¨ `uint` å˜ç§ï¼Œå› ä¸ºæ— è®ºå¦‚ä½•å®šä¹‰ `uint`çš„å¤§å°ï¼ŒSolidity ä¸ºå®ƒä¿ç•™256ä½çš„å­˜å‚¨ç©ºé—´ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `uint8` è€Œä¸æ˜¯`uint`ï¼ˆ`uint256`ï¼‰ä¸ä¼šä¸ºä½ èŠ‚çœä»»ä½• gasã€‚

é™¤éï¼ŒæŠŠ `uint` ç»‘å®šåˆ° `struct` é‡Œé¢ã€‚

å¦‚æœä¸€ä¸ª `struct` ä¸­æœ‰å¤šä¸ª `uint`ï¼Œåˆ™å°½å¯èƒ½ä½¿ç”¨è¾ƒå°çš„ `uint`, Solidity ä¼šå°†è¿™äº› `uint` æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä»è€Œå ç”¨è¾ƒå°‘çš„å­˜å‚¨ç©ºé—´ã€‚ä¾‹å¦‚ï¼š

```
struct NormalStruct {
  uint a;
  uint b;
  uint c;
}

struct MiniMe {
  uint32 a;
  uint32 b;
  uint c;
}

// å› ä¸ºä½¿ç”¨äº†ç»“æ„æ‰“åŒ…ï¼Œ`mini` æ¯” `normal` å ç”¨çš„ç©ºé—´æ›´å°‘
NormalStruct normal = NormalStruct(10, 20, 30);
MiniMe mini = MiniMe(10, 20, 30); 
```

æ‰€ä»¥ï¼Œå½“ `uint` å®šä¹‰åœ¨ä¸€ä¸ª `struct` ä¸­çš„æ—¶å€™ï¼Œå°½é‡ä½¿ç”¨æœ€å°çš„æ•´æ•°å­ç±»å‹ä»¥èŠ‚çº¦ç©ºé—´ã€‚ å¹¶ä¸”æŠŠåŒæ ·ç±»å‹çš„å˜é‡æ”¾ä¸€èµ·ï¼ˆå³åœ¨ struct ä¸­å°†æŠŠå˜é‡æŒ‰ç…§ç±»å‹ä¾æ¬¡æ”¾ç½®ï¼‰ï¼Œè¿™æ · Solidity å¯ä»¥å°†å­˜å‚¨ç©ºé—´æœ€å°åŒ–ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸¤ä¸ª `struct`ï¼š

```
uint c; uint32 a; uint32 b;` å’Œ `uint32 a; uint c; uint32 b;
```

å‰è€…æ¯”åè€…éœ€è¦çš„gasæ›´å°‘ï¼Œå› ä¸ºå‰è€…æŠŠ`uint32`æ”¾ä¸€èµ·äº†ã€‚

##### å®æˆ˜æ¼”ä¹ 

åœ¨æœ¬è¯¾ä¸­ï¼Œå’±ä»¬ç»™åƒµå°¸æ·»2ä¸ªæ–°åŠŸèƒ½ï¼š`level` å’Œ `readyTime` - åè€…æ˜¯ç”¨æ¥å®ç°ä¸€ä¸ªâ€œå†·å´å®šæ—¶å™¨â€ï¼Œä»¥é™åˆ¶åƒµå°¸çŒé£Ÿçš„é¢‘ç‡ã€‚

è®©æˆ‘ä»¬å›åˆ° `zombiefactory.sol`ã€‚

1. ä¸º `Zombie` ç»“æ„ä½“ æ·»åŠ ä¸¤ä¸ªå±æ€§ï¼š`level`ï¼ˆ`uint32`ï¼‰å’Œ`readyTime`ï¼ˆ`uint32`ï¼‰ã€‚å› ä¸ºå¸Œæœ›åŒç±»å‹æ•°æ®æ‰“æˆä¸€ä¸ªåŒ…ï¼Œæ‰€ä»¥æŠŠå®ƒä»¬æ”¾åœ¨ç»“æ„ä½“çš„æœ«å°¾ã€‚

32ä½è¶³ä»¥ä¿å­˜åƒµå°¸çš„çº§åˆ«å’Œæ—¶é—´æˆ³äº†ï¼Œè¿™æ ·æ¯”èµ·ä½¿ç”¨æ™®é€šçš„`uint`ï¼ˆ256ä½ï¼‰ï¼Œå¯ä»¥æ›´ç´§å¯†åœ°å°è£…æ•°æ®ï¼Œä»è€Œä¸ºæˆ‘ä»¬çœç‚¹ gasã€‚

``` solidity
struct Zombie {
    string name;
    uint dna;
    uint32 level;
    uint32 readyTime;
}
```



#### ç¬¬5ç«  æ—¶é—´å•ä½

`level` å±æ€§è¡¨ç¤ºåƒµå°¸çš„çº§åˆ«ã€‚ä»¥åï¼Œåœ¨æˆ‘ä»¬åˆ›å»ºçš„æˆ˜æ–—ç³»ç»Ÿä¸­ï¼Œæ‰“èƒœä»—çš„åƒµå°¸ä¼šé€æ¸å‡çº§å¹¶è·å¾—æ›´å¤šçš„èƒ½åŠ›ã€‚

`readyTime` ç¨å¾®å¤æ‚ç‚¹ã€‚æˆ‘ä»¬å¸Œæœ›å¢åŠ ä¸€ä¸ªâ€œå†·å´å‘¨æœŸâ€ï¼Œè¡¨ç¤ºåƒµå°¸åœ¨ä¸¤æ¬¡çŒé£Ÿæˆ–æ”»å‡»ä¹‹ä¹‹é—´å¿…é¡»ç­‰å¾…çš„æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œåƒµå°¸æ¯å¤©å¯èƒ½ä¼šæ”»å‡»å’Œç¹æ®–1,000æ¬¡ï¼Œè¿™æ ·æ¸¸æˆå°±å¤ªç®€å•äº†ã€‚

ä¸ºäº†è®°å½•åƒµå°¸åœ¨ä¸‹ä¸€æ¬¡è¿›å‡»å‰éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Solidity çš„æ—¶é—´å•ä½ã€‚

##### æ—¶é—´å•ä½

Solidity ä½¿ç”¨è‡ªå·±çš„æœ¬åœ°æ—¶é—´å•ä½ã€‚

å˜é‡ `now` å°†è¿”å›å½“å‰çš„unixæ—¶é—´æˆ³ï¼ˆè‡ª1970å¹´1æœˆ1æ—¥ä»¥æ¥ç»è¿‡çš„ç§’æ•°ï¼‰ã€‚æˆ‘å†™è¿™å¥è¯æ—¶ unix æ—¶é—´æ˜¯ `1515527488`ã€‚

> æ³¨æ„ï¼šUnixæ—¶é—´ä¼ ç»Ÿç”¨ä¸€ä¸ª32ä½çš„æ•´æ•°è¿›è¡Œå­˜å‚¨ã€‚è¿™ä¼šå¯¼è‡´â€œ2038å¹´â€é—®é¢˜ï¼Œå½“è¿™ä¸ª32ä½çš„unixæ—¶é—´æˆ³ä¸å¤Ÿç”¨ï¼Œäº§ç”Ÿæº¢å‡ºï¼Œä½¿ç”¨è¿™ä¸ªæ—¶é—´çš„é—ç•™ç³»ç»Ÿå°±éº»çƒ¦äº†ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®©æˆ‘ä»¬çš„ DApp è·‘å¤Ÿ20å¹´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨64ä½æ•´æ•°è¡¨ç¤ºæ—¶é—´ï¼Œä½†ä¸ºæ­¤æˆ‘ä»¬çš„ç”¨æˆ·åˆå¾—æ”¯ä»˜æ›´å¤šçš„ gasã€‚çœŸæ˜¯ä¸ªä¸¤éš¾çš„è®¾è®¡å•Šï¼

Solidity è¿˜åŒ…å«`ç§’(seconds)`ï¼Œ`åˆ†é’Ÿ(minutes)`ï¼Œ`å°æ—¶(hours)`ï¼Œ`å¤©(days)`ï¼Œ`å‘¨(weeks)` å’Œ `å¹´(years)` ç­‰æ—¶é—´å•ä½ã€‚å®ƒä»¬éƒ½ä¼šè½¬æ¢æˆå¯¹åº”çš„ç§’æ•°æ”¾å…¥ `uint` ä¸­ã€‚æ‰€ä»¥ `1åˆ†é’Ÿ` å°±æ˜¯ `60`ï¼Œ`1å°æ—¶`æ˜¯ `3600`ï¼ˆ60ç§’Ã—60åˆ†é’Ÿï¼‰ï¼Œ`1å¤©`æ˜¯`86400`ï¼ˆ24å°æ—¶Ã—60åˆ†é’ŸÃ—60ç§’ï¼‰ï¼Œä»¥æ­¤ç±»æ¨ã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨æ—¶é—´å•ä½çš„å®ç”¨æ¡ˆä¾‹ï¼š

```solidity
uint lastUpdated;

// å°†â€˜ä¸Šæ¬¡æ›´æ–°æ—¶é—´â€™ è®¾ç½®ä¸º â€˜ç°åœ¨â€™
function updateTimestamp() public {
  lastUpdated = now;
}

// å¦‚æœåˆ°ä¸Šæ¬¡`updateTimestamp` è¶…è¿‡5åˆ†é’Ÿï¼Œè¿”å› 'true'
// ä¸åˆ°5åˆ†é’Ÿè¿”å› 'false'
function fiveMinutesHavePassed() public view returns (bool) {
  return (now >= (lastUpdated + 5 minutes));
}
```

æœ‰äº†è¿™äº›å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºåƒµå°¸è®¾å®šâ€œå†·é™æ—¶é—´â€åŠŸèƒ½ã€‚

##### å®æˆ˜æ¼”ä¹ 

ç°åœ¨å’±ä»¬ç»™DAppæ·»åŠ ä¸€ä¸ªâ€œå†·å´å‘¨æœŸâ€çš„è®¾å®šï¼Œè®©åƒµå°¸ä¸¤æ¬¡æ”»å‡»æˆ–æ•çŒä¹‹é—´å¿…é¡»ç­‰å¾… **1å¤©**ã€‚

1. å£°æ˜ä¸€ä¸ªåä¸º `cooldownTime` çš„`uint`ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º `1 days`ã€‚ï¼ˆæ²¡é”™ï¼Œâ€1 daysâ€œä½¿ç”¨äº†å¤æ•°ï¼Œ å¦åˆ™é€šä¸è¿‡ç¼–è¯‘å™¨ï¼‰

2. å› ä¸ºåœ¨ä¸Šä¸€ç« ä¸­æˆ‘ä»¬ç»™ `Zombie` ç»“æ„ä½“ä¸­æ·»åŠ  `level` å’Œ `readyTime` ä¸¤ä¸ªå‚æ•°ï¼Œæ‰€ä»¥ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ `Zombie` ç»“æ„ä½“æ—¶ï¼Œéœ€è¦ä¿®æ”¹ `_createZombie()`ï¼Œåœ¨å…¶ä¸­æŠŠæ–°æ—§å‚æ•°éƒ½åˆå§‹åŒ–ä¸€ä¸‹ã€‚

   ä¿®æ”¹ `zombies.push` é‚£ä¸€è¡Œï¼Œ æ·»åŠ åŠ 2ä¸ªå‚æ•°ï¼š`1`ï¼ˆè¡¨ç¤ºå½“å‰çš„ `level` ï¼‰å’Œ`uint32ï¼ˆnow + cooldownTimeï¼‰`ï¼ˆç°åœ¨+å†·å´æ—¶é—´ï¼Œè¡¨ç¤ºä¸‹æ¬¡å…è®¸æ”»å‡»çš„æ—¶é—´ `readyTime`ï¼‰ã€‚

> æ³¨æ„ï¼šå¿…é¡»ä½¿ç”¨ `uint32ï¼ˆ...ï¼‰` è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå› ä¸º `now` è¿”å›ç±»å‹ `uint256`ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ˜ç¡®å°†å®ƒè½¬æ¢æˆä¸€ä¸ª `uint32` ç±»å‹çš„å˜é‡ã€‚

`now + cooldownTime` å°†ç­‰äºå½“å‰çš„unixæ—¶é—´æˆ³ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰åŠ ä¸Šâ€1å¤©â€œé‡Œçš„ç§’æ•° - è¿™å°†ç­‰äºä»ç°åœ¨èµ·1å¤©åçš„unixæ—¶é—´æˆ³ã€‚ç„¶åæˆ‘ä»¬å°±æ¯”è¾ƒï¼Œçœ‹çœ‹è¿™ä¸ªåƒµå°¸çš„ `readyTime`æ˜¯å¦å¤§äº `now`ï¼Œä»¥å†³å®šå†æ¬¡å¯ç”¨åƒµå°¸çš„æ—¶æœºæœ‰æ²¡æœ‰åˆ°æ¥ã€‚

ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•é€šè¿‡ `readyTime` æ¥è§„èŒƒåƒµå°¸çš„è¡Œä¸ºã€‚

``` solidity
contract ZombieFactory is Ownable {
		// ... other code ...
    uint cooldownTime = 1 days;
    // ... other code ...
    function _createZombie(string memory _name, uint _dna) internal {
    	zombies.push(Zombie(_name, _dna, 1, uint32(block.timestamp + cooldownTime)));
    	// ... other code ...
    }
}
```



#### ç¬¬6ç«  åƒµå°¸å†·å´

ç°åœ¨ï¼Œ`Zombie` ç»“æ„ä½“ä¸­å®šä¹‰å¥½äº†ä¸€ä¸ª `readyTime` å±æ€§ï¼Œè®©æˆ‘ä»¬è·³åˆ° `zombiefeeding.sol`ï¼Œ å»å®ç°ä¸€ä¸ªâ€å†·å´å‘¨æœŸå®šæ—¶å™¨â€œã€‚

æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹ `feedAndMultiply`ï¼š

1. â€æ•çŒâ€œè¡Œä¸ºä¼šè§¦å‘åƒµå°¸çš„â€å†·å´å‘¨æœŸâ€œ
2. åƒµå°¸åœ¨è¿™æ®µâ€å†·å´å‘¨æœŸâ€œç»“æŸå‰ä¸å¯å†æ•çŒå°çŒ«

è¿™å°†é™åˆ¶åƒµå°¸ï¼Œé˜²æ­¢å…¶æ— é™åˆ¶åœ°æ•çŒå°çŒ«æˆ–è€…æ•´å¤©ä¸åœåœ°ç¹æ®–ã€‚å°†æ¥ï¼Œå½“æˆ‘ä»¬å¢åŠ æˆ˜æ–—åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬åŒæ ·ç”¨â€å†·å´å‘¨æœŸâ€œé™åˆ¶åƒµå°¸ä¹‹é—´æ‰“æ–—çš„é¢‘ç‡ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®¾ç½®å¹¶æ£€æŸ¥åƒµå°¸çš„ `readyTime`ã€‚

##### å°†ç»“æ„ä½“ä½œä¸ºå‚æ•°ä¼ å…¥

ç”±äºç»“æ„ä½“çš„å­˜å‚¨æŒ‡é’ˆå¯ä»¥ä»¥å‚æ•°çš„æ–¹å¼ä¼ é€’ç»™ä¸€ä¸ª `private` æˆ– `internal` çš„å‡½æ•°ï¼Œå› æ­¤ç»“æ„ä½“å¯ä»¥åœ¨å¤šä¸ªå‡½æ•°ä¹‹é—´ç›¸äº’ä¼ é€’ã€‚

éµå¾ªè¿™æ ·çš„è¯­æ³•ï¼š

```solidity
function _doStuff(Zombie storage _zombie) internal {
  // do stuff with _zombie
}
```

è¿™æ ·æˆ‘ä»¬å¯ä»¥å°†æŸåƒµå°¸çš„å¼•ç”¨ç›´æ¥ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸ç”¨æ˜¯é€šè¿‡å‚æ•°ä¼ å…¥åƒµå°¸IDåï¼Œå‡½æ•°å†ä¾æ®IDå»æŸ¥æ‰¾ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. å…ˆå®šä¹‰ä¸€ä¸ª `_triggerCooldown` å‡½æ•°ã€‚å®ƒè¦æ±‚ä¸€ä¸ªå‚æ•°ï¼Œ`_zombie`ï¼Œè¡¨ç¤ºä¸€æŸä¸ªåƒµå°¸çš„å­˜å‚¨æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°å¯è§æ€§è®¾ç½®ä¸º `internal`ã€‚
2. åœ¨å‡½æ•°ä¸­ï¼ŒæŠŠ `_zombie.readyTime` è®¾ç½®ä¸º `uint32ï¼ˆnow + cooldownTimeï¼‰`ã€‚
3. æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º `_isReady` çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯åä¸º `_zombie` çš„ `Zombie storage`ã€‚è¿™ä¸ªåŠŸèƒ½åªå…·æœ‰ `internal` å¯è§æ€§ï¼Œå¹¶è¿”å›ä¸€ä¸ª `bool` å€¼ã€‚
4. å‡½æ•°è®¡ç®—è¿”å›`(_zombie.readyTime <= now)`ï¼Œå€¼ä¸º `true` æˆ– `false`ã€‚è¿™ä¸ªåŠŸèƒ½çš„ç›®çš„æ˜¯åˆ¤æ–­ä¸‹æ¬¡å…è®¸çŒé£Ÿçš„æ—¶é—´æ˜¯å¦å·²ç»åˆ°äº†ã€‚

``` solidity
contract ZombieFeeding is ZombieFactory {

    KittyInterface kittyContract;

    function setKittyContractAddress(address _address) external onlyOwner {
        kittyContract = KittyInterface(_address);
    }

    function _triggerCooldown(Zombie storage _zombie) internal {
        _zombie.readyTime = uint32(block.timestamp + cooldownTime);
    }

    function _isReady(Zombie storage _zombie) internal view returns (bool) {
        return (_zombie.readyTime <= block.timestamp);
    }
    // ... other code ...
}
```



#### ç¬¬7ç«  å…¬æœ‰å‡½æ•°å’Œå®‰å…¨æ€§

ç°åœ¨æ¥ä¿®æ”¹ `feedAndMultiply` ï¼Œå®ç°å†·å´å‘¨æœŸã€‚

å›é¡¾ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‰ä¸€è¯¾ä¸Šæˆ‘ä»¬å°†å…¶å¯è§æ€§è®¾ç½®ä¸º`public`ã€‚ä½ å¿…é¡»ä»”ç»†åœ°æ£€æŸ¥æ‰€æœ‰å£°æ˜ä¸º `public` å’Œ `external`çš„å‡½æ•°ï¼Œä¸€ä¸ªä¸ªæ’é™¤ç”¨æˆ·æ»¥ç”¨å®ƒä»¬çš„å¯èƒ½ï¼Œè°¨é˜²å®‰å…¨æ¼æ´ã€‚è¯·è®°ä½ï¼Œå¦‚æœè¿™äº›å‡½æ•°æ²¡æœ‰ç±»ä¼¼ `onlyOwner` è¿™æ ·çš„å‡½æ•°ä¿®é¥°ç¬¦ï¼Œç”¨æˆ·èƒ½åˆ©ç”¨å„ç§å¯èƒ½çš„å‚æ•°å»è°ƒç”¨å®ƒä»¬ã€‚

æ£€æŸ¥å®Œè¿™ä¸ªå‡½æ•°ï¼Œç”¨æˆ·å°±å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå®ƒï¼Œå¹¶ä¼ å…¥ä»–ä»¬æ‰€å¸Œæœ›çš„ `_targetDna` æˆ– `species` ã€‚æ‰“ä¸ªæ¸¸æˆè¿˜å¾—éµå¾ªè¿™ä¹ˆå¤šçš„è§„åˆ™ï¼Œè¿˜èƒ½ä¸èƒ½æ„‰å¿«åœ°ç©è€å•Šï¼

ä»”ç»†è§‚å¯Ÿï¼Œè¿™ä¸ªå‡½æ•°åªéœ€è¢« `feedOnKitty()` è°ƒç”¨ï¼Œå› æ­¤ï¼Œæƒ³è¦é˜²æ­¢æ¼æ´ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯è®¾å…¶å¯è§æ€§ä¸º `internal`ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. ç›®å‰å‡½æ•° `feedAndMultiply` å¯è§æ€§ä¸º `public`ã€‚æˆ‘ä»¬å°†å…¶æ”¹ä¸º `internal` ä»¥ä¿éšœåˆçº¦å®‰å…¨ã€‚å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·è°ƒç”¨å®ƒçš„æ—¶å€™å¡è¿›ä¸€å †ä¹±ä¸ƒå…«ç³Ÿçš„ DNAã€‚
2. `feedAndMultiply` è¿‡ç¨‹éœ€è¦å‚è€ƒ `cooldownTime`ã€‚é¦–å…ˆï¼Œåœ¨æ‰¾åˆ° `myZombie` ä¹‹åï¼Œæ·»åŠ ä¸€ä¸ª `require` è¯­å¥æ¥æ£€æŸ¥ `_isReady()` å¹¶å°† `myZombie` ä¼ é€’ç»™å®ƒã€‚è¿™æ ·ç”¨æˆ·å¿…é¡»ç­‰åˆ°åƒµå°¸çš„ `å†·å´å‘¨æœŸ` ç»“æŸåæ‰èƒ½æ‰§è¡Œ `feedAndMultiply` åŠŸèƒ½ã€‚
3. åœ¨å‡½æ•°ç»“æŸæ—¶ï¼Œè°ƒç”¨ `_triggerCooldown(myZombie)`ï¼Œæ ‡æ˜æ•çŒè¡Œä¸ºè§¦å‘äº†åƒµå°¸æ–°çš„å†·å´å‘¨æœŸã€‚

``` solidity
function feedAndMultiply(uint256 _zombieId, uint256 _targetDna, string memory _species) internal {
    require(msg.sender == zombieToOwner[_zombieId]);
    Zombie storage myZombie = zombies[_zombieId];
    require(_isReady(myZombie));
    _targetDna = _targetDna % dnaModulus;
    uint256 newDna = (myZombie.dna + _targetDna) / 2;
    // è¿™é‡Œå¢åŠ ä¸€ä¸ª if è¯­å¥
    if(keccak256(abi.encode(_species)) == keccak256(abi.encode("kitty"))){
        newDna = newDna - newDna % 100 + 99;
    }
    _createZombie("NoName", newDna);
    _triggerCooldown(myZombie);
}
```



#### ç¬¬8ç«  è¿›ä¸€æ­¥äº†è§£å‡½æ•°ä¿®é¥°ç¬¦

ç›¸å½“ä¸é”™ï¼æˆ‘ä»¬çš„åƒµå°¸ç°åœ¨æœ‰äº†â€œå†·å´å®šæ—¶å™¨â€åŠŸèƒ½ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·»åŠ ä¸€äº›è¾…åŠ©æ–¹æ³•ã€‚æˆ‘ä»¬ä¸ºæ‚¨åˆ›å»ºäº†ä¸€ä¸ªåä¸º `zombiehelper.sol` çš„æ–°æ–‡ä»¶ï¼Œå¹¶ä¸”å°† `zombiefeeding.sol` å¯¼å…¥å…¶ä¸­ï¼Œè¿™è®©æˆ‘ä»¬çš„ä»£ç æ›´æ•´æ´ã€‚

æˆ‘ä»¬æ‰“ç®—è®©åƒµå°¸åœ¨è¾¾åˆ°ä¸€å®šæ°´å¹³åï¼Œè·å¾—ç‰¹æ®Šèƒ½åŠ›ã€‚ä½†æ˜¯è¾¾åˆ°è¿™ä¸ªå°ç›®æ ‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å­¦ä¸€å­¦ä»€ä¹ˆæ˜¯â€œå‡½æ•°ä¿®é¥°ç¬¦â€ã€‚

##### å¸¦å‚æ•°çš„å‡½æ•°ä¿®é¥°ç¬¦

ä¹‹å‰æˆ‘ä»¬å·²ç»è¯»è¿‡ä¸€ä¸ªç®€å•çš„å‡½æ•°ä¿®é¥°ç¬¦äº†ï¼š`onlyOwner`ã€‚å‡½æ•°ä¿®é¥°ç¬¦ä¹Ÿå¯ä»¥å¸¦å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```solidity
// å­˜å‚¨ç”¨æˆ·å¹´é¾„çš„æ˜ å°„
mapping (uint => uint) public age;

// é™å®šç”¨æˆ·å¹´é¾„çš„ä¿®é¥°ç¬¦
modifier olderThan(uint _age, uint _userId) {
  require(age[_userId] >= _age);
  _;
}

// å¿…é¡»å¹´æ»¡16å‘¨å²æ‰å…è®¸å¼€è½¦ (è‡³å°‘åœ¨ç¾å›½æ˜¯è¿™æ ·çš„).
// æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‚æ•°è°ƒç”¨`olderThan` ä¿®é¥°ç¬¦:
function driveCar(uint _userId) public olderThan(16, _userId) {
  // å…¶ä½™çš„ç¨‹åºé€»è¾‘
}
```

çœ‹åˆ°äº†å§ï¼Œ `olderThan` ä¿®é¥°ç¬¦å¯ä»¥åƒå‡½æ•°ä¸€æ ·æ¥æ”¶å‚æ•°ï¼Œæ˜¯â€œå®¿ä¸»â€å‡½æ•° `driveCar` æŠŠå‚æ•°ä¼ é€’ç»™å®ƒçš„ä¿®é¥°ç¬¦çš„ã€‚

æ¥ï¼Œæˆ‘ä»¬è‡ªå·±ç”Ÿäº§ä¸€ä¸ªä¿®é¥°ç¬¦ï¼Œé€šè¿‡ä¼ å…¥çš„`level`å‚æ•°æ¥é™åˆ¶åƒµå°¸ä½¿ç”¨æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. åœ¨`ZombieHelper` ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º `aboveLevel` çš„`modifier`ï¼Œå®ƒæ¥æ”¶2ä¸ªå‚æ•°ï¼Œ `_level` (`uint`ç±»å‹) ä»¥åŠ `_zombieId` (`uint`ç±»å‹)ã€‚
2. è¿ç”¨å‡½æ•°é€»è¾‘ç¡®ä¿åƒµå°¸ `zombies[_zombieId].level` å¤§äºæˆ–ç­‰äº `_level`ã€‚
3. è®°ä½ï¼Œä¿®é¥°ç¬¦çš„æœ€åä¸€è¡Œä¸º `_;`ï¼Œè¡¨ç¤ºä¿®é¥°ç¬¦è°ƒç”¨ç»“æŸåè¿”å›ï¼Œå¹¶æ‰§è¡Œè°ƒç”¨å‡½æ•°ä½™ä¸‹çš„éƒ¨åˆ†ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >=0.4.19;

import "./zombiefeeding.sol";

contract ZombieHelper is ZombieFeeding {

    modifier aboveLevel(uint _level, uint _zombieId) {
        require(zombies[_zombieId].level >= _level);
        _;
    }
}
```



#### ç¬¬9ç«  åƒµå°¸ä¿®é¥°ç¬¦

ç°åœ¨è®©æˆ‘ä»¬è®¾è®¡ä¸€äº›ä½¿ç”¨ `aboveLevel` ä¿®é¥°ç¬¦çš„å‡½æ•°ã€‚

ä½œä¸ºæ¸¸æˆï¼Œæ‚¨å¾—æœ‰ä¸€äº›æªæ–½æ¿€åŠ±ç©å®¶ä»¬å»å‡çº§ä»–ä»¬çš„åƒµå°¸ï¼š

- 2çº§ä»¥ä¸Šçš„åƒµå°¸ï¼Œç©å®¶å¯ç»™ä»–ä»¬æ”¹åã€‚
- 20çº§ä»¥ä¸Šçš„åƒµå°¸ï¼Œç©å®¶èƒ½ç»™ä»–ä»¬å®šåˆ¶çš„ DNAã€‚

æ˜¯å®ç°è¿™äº›åŠŸèƒ½çš„æ—¶å€™äº†ã€‚ä»¥ä¸‹æ˜¯ä¸Šä¸€è¯¾çš„ç¤ºä¾‹ä»£ç ï¼Œä¾›å‚è€ƒï¼š

```solidity
// å­˜å‚¨ç”¨æˆ·å¹´é¾„çš„æ˜ å°„
mapping (uint => uint) public age;

// é™å®šç”¨æˆ·å¹´é¾„çš„ä¿®é¥°ç¬¦
modifier olderThan(uint _age, uint _userId) {
  require (age[_userId] >= _age);
  _;
}

// å¿…é¡»å¹´æ»¡16å‘¨å²æ‰å…è®¸å¼€è½¦ (è‡³å°‘åœ¨ç¾å›½æ˜¯è¿™æ ·çš„).
// æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‚æ•°è°ƒç”¨`olderThan` ä¿®é¥°ç¬¦:
function driveCar(uint _userId) public olderThan(16, _userId) {
  // å…¶ä½™çš„ç¨‹åºé€»è¾‘
}
```

##### å®æˆ˜æ¼”ä¹ 

1. åˆ›å»ºä¸€ä¸ªåä¸º `changeName` çš„å‡½æ•°ã€‚å®ƒæ¥æ”¶2ä¸ªå‚æ•°ï¼š`_zombieId`ï¼ˆ`uint`ç±»å‹ï¼‰ä»¥åŠ `_newName`ï¼ˆ`string`ç±»å‹ï¼‰ï¼Œå¯è§æ€§ä¸º `external`ã€‚å®ƒå¸¦æœ‰ä¸€ä¸ª `aboveLevel` ä¿®é¥°ç¬¦ï¼Œè°ƒç”¨çš„æ—¶å€™é€šè¿‡ `_level` å‚æ•°ä¼ å…¥`2`ï¼Œ å½“ç„¶ï¼Œåˆ«å¿˜äº†åŒæ—¶ä¼  `_zombieId` å‚æ•°ã€‚
2. åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬ç”¨ `require` è¯­å¥ï¼ŒéªŒè¯ `msg.sender` æ˜¯å¦å°±æ˜¯ `zombieToOwner [_zombieId]`ã€‚
3. ç„¶åå‡½æ•°å°† `zombies[_zombieId] .name` è®¾ç½®ä¸º `_newName`ã€‚
4. åœ¨ `changeName` ä¸‹åˆ›å»ºå¦ä¸€ä¸ªåä¸º `changeDna` çš„å‡½æ•°ã€‚å®ƒçš„å®šä¹‰å’Œå†…å®¹å‡ ä¹å’Œ `changeName` ç›¸åŒï¼Œä¸è¿‡å®ƒç¬¬äºŒä¸ªå‚æ•°æ˜¯ `_newDna`ï¼ˆ`uint`ç±»å‹ï¼‰ï¼Œåœ¨ä¿®é¥°ç¬¦ `aboveLevel` çš„ `_level` å‚æ•°ä¸­ä¼ é€’ `20` ã€‚ç°åœ¨ï¼Œä»–å¯ä»¥æŠŠåƒµå°¸çš„ `dna` è®¾ç½®ä¸º `_newDna` äº†ã€‚

``` solidity
// ä¿®æ”¹åƒµå°¸åå­—
function changeName(uint _zombieId, string calldata _newName) external aboveLevel(2, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].name = _newName;
}

// å®šåˆ¶ DNA
function changeDna(uint _zombieId, uint _newDna) external aboveLevel(20, _zombieId) {
    require(msg.sender == zombieToOwner[_zombieId]);
    zombies[_zombieId].dna = _newDna;
}
```



#### ç¬¬10ç«  åˆ©ç”¨ 'View' å‡½æ•°èŠ‚çœ Gas

é…·ç‚«ï¼ç°åœ¨é«˜çº§åˆ«åƒµå°¸å¯ä»¥æ‹¥æœ‰ç‰¹æ®ŠæŠ€èƒ½äº†ï¼Œè¿™ä¸€å®šä¼šé¼“åŠ¨æˆ‘ä»¬çš„ç©å®¶å»æ‰“æ€ªå‡çº§çš„ã€‚ä½ å–œæ¬¢çš„è¯ï¼Œå›å¤´æˆ‘ä»¬è¿˜èƒ½æ·»åŠ æ›´å¤šçš„ç‰¹æ®ŠæŠ€èƒ½ã€‚

ç°åœ¨éœ€è¦æ·»åŠ çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯ï¼šæˆ‘ä»¬çš„ DApp éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥æŸ¥çœ‹æŸç©å®¶çš„æ•´ä¸ªåƒµå°¸å†›å›¢ - æˆ‘ä»¬ç§°ä¹‹ä¸º `getZombiesByOwner`ã€‚

å®ç°è¿™ä¸ªåŠŸèƒ½åªéœ€ä»åŒºå—é“¾ä¸­è¯»å–æ•°æ®ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ˜¯ä¸€ä¸ª `view` å‡½æ•°ã€‚è¿™è®©æˆ‘ä»¬ä¸å¾—ä¸å›é¡¾ä¸€ä¸‹â€œgasä¼˜åŒ–â€è¿™ä¸ªé‡è¦è¯é¢˜ã€‚

##### â€œviewâ€ å‡½æ•°ä¸èŠ± â€œgasâ€

å½“ç©å®¶ä»å¤–éƒ¨è°ƒç”¨ä¸€ä¸ª`view`å‡½æ•°ï¼Œæ˜¯ä¸éœ€è¦æ”¯ä»˜ä¸€åˆ† gas çš„ã€‚

è¿™æ˜¯å› ä¸º `view` å‡½æ•°ä¸ä¼šçœŸæ­£æ”¹å˜åŒºå—é“¾ä¸Šçš„ä»»ä½•æ•°æ® - å®ƒä»¬åªæ˜¯è¯»å–ã€‚å› æ­¤ç”¨ `view` æ ‡è®°ä¸€ä¸ªå‡½æ•°ï¼Œæ„å‘³ç€å‘Šè¯‰ `web3.js`ï¼Œè¿è¡Œè¿™ä¸ªå‡½æ•°åªéœ€è¦æŸ¥è¯¢ä½ çš„æœ¬åœ°ä»¥å¤ªåŠèŠ‚ç‚¹ï¼Œè€Œä¸éœ€è¦åœ¨åŒºå—é“¾ä¸Šåˆ›å»ºä¸€ä¸ªäº‹åŠ¡ï¼ˆäº‹åŠ¡éœ€è¦è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤èŠ±è´¹ gasï¼‰ã€‚

ç¨åæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•åœ¨è‡ªå·±çš„èŠ‚ç‚¹ä¸Šè®¾ç½® web3.jsã€‚ä½†ç°åœ¨ï¼Œä½ å…³é”®æ˜¯è¦è®°ä½ï¼Œåœ¨æ‰€èƒ½åªè¯»çš„å‡½æ•°ä¸Šæ ‡è®°ä¸Šè¡¨ç¤ºâ€œåªè¯»â€çš„â€œ`external view` å£°æ˜ï¼Œå°±èƒ½ä¸ºä½ çš„ç©å®¶å‡å°‘åœ¨ DApp ä¸­ gas ç”¨é‡ã€‚

> æ³¨æ„ï¼šå¦‚æœä¸€ä¸ª `view` å‡½æ•°åœ¨å¦ä¸€ä¸ªå‡½æ•°çš„å†…éƒ¨è¢«è°ƒç”¨ï¼Œè€Œè°ƒç”¨å‡½æ•°ä¸ `view` å‡½æ•°çš„ä¸å±äºåŒä¸€ä¸ªåˆçº¦ï¼Œä¹Ÿä¼šäº§ç”Ÿè°ƒç”¨æˆæœ¬ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœä¸»è°ƒå‡½æ•°åœ¨ä»¥å¤ªåŠåˆ›å»ºäº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä»ç„¶éœ€è¦é€ä¸ªèŠ‚ç‚¹å»éªŒè¯ã€‚æ‰€ä»¥æ ‡è®°ä¸º `view` çš„å‡½æ•°åªæœ‰åœ¨å¤–éƒ¨è°ƒç”¨æ—¶æ‰æ˜¯å…è´¹çš„ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥å†™ä¸€ä¸ªâ€è¿”å›æŸç©å®¶çš„æ•´ä¸ªåƒµå°¸å†›å›¢â€œçš„å‡½æ•°ã€‚å½“æˆ‘ä»¬ä» `web3.js` ä¸­è°ƒç”¨å®ƒï¼Œå³å¯æ˜¾ç¤ºæŸä¸€ç©å®¶çš„ä¸ªäººèµ„æ–™é¡µã€‚

è¿™ä¸ªå‡½æ•°çš„é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬éœ€è¦å¥½å‡ ä¸ªç« èŠ‚æ¥æè¿°å®ƒçš„å®ç°ã€‚

1. åˆ›å»ºä¸€ä¸ªåä¸º `getZombiesByOwner` çš„æ–°å‡½æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªåä¸º `_owner` çš„ `address` ç±»å‹çš„å‚æ•°ã€‚
2. å°†å…¶ç”³æ˜ä¸º `external view` å‡½æ•°ï¼Œè¿™æ ·å½“ç©å®¶ä» `web3.js` ä¸­è°ƒç”¨å®ƒæ—¶ï¼Œä¸éœ€è¦èŠ±è´¹ä»»ä½• gasã€‚
3. å‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ª`uint []`ï¼ˆ`uint`æ•°ç»„ï¼‰ã€‚

å…ˆè¿™ä¹ˆå£°æ˜ç€ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« ä¸­å¡«å……å‡½æ•°ä½“ã€‚

``` solidity
function getZombiesByOwner(address _owner) external view returns (uint []) {
    // ... other return code ...
}
```



#### ç¬¬11ç«  å­˜å‚¨éå¸¸æ˜‚è´µ

Solidity ä½¿ç”¨`storage`(å­˜å‚¨)æ˜¯ç›¸å½“æ˜‚è´µçš„ï¼Œâ€å†™å…¥â€œæ“ä½œå°¤å…¶è´µã€‚

è¿™æ˜¯å› ä¸ºï¼Œæ— è®ºæ˜¯å†™å…¥è¿˜æ˜¯æ›´æ”¹ä¸€æ®µæ•°æ®ï¼Œ è¿™éƒ½å°†æ°¸ä¹…æ€§åœ°å†™å…¥åŒºå—é“¾ã€‚â€æ°¸ä¹…æ€§â€œå•Šï¼éœ€è¦åœ¨å…¨çƒæ•°åƒä¸ªèŠ‚ç‚¹çš„ç¡¬ç›˜ä¸Šå­˜å…¥è¿™äº›æ•°æ®ï¼Œéšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ‹·è´ä»½æ•°æ›´å¤šï¼Œå­˜å‚¨é‡ä¹Ÿå°±è¶Šå¤§ã€‚è¿™æ˜¯éœ€è¦æˆæœ¬çš„ï¼

ä¸ºäº†é™ä½æˆæœ¬ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ï¼Œé¿å…å°†æ•°æ®å†™å…¥å­˜å‚¨ã€‚è¿™ä¹Ÿä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹çš„ç¼–ç¨‹é€»è¾‘ - æ¯”å¦‚æ¯æ¬¡è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œéƒ½éœ€è¦åœ¨ `memory`(å†…å­˜) ä¸­é‡å»ºä¸€ä¸ªæ•°ç»„ï¼Œè€Œä¸æ˜¯ç®€å•åœ°å°†ä¸Šæ¬¡è®¡ç®—çš„æ•°ç»„ç»™å­˜å‚¨ä¸‹æ¥ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚

åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œéå†å¤§æ•°æ®é›†åˆéƒ½æ˜¯æ˜‚è´µçš„ã€‚ä½†æ˜¯åœ¨ Solidity ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ ‡è®°äº†`external view`çš„å‡½æ•°ï¼Œéå†æ¯” `storage` è¦ä¾¿å®œå¤ªå¤šï¼Œå› ä¸º `view` å‡½æ•°ä¸ä¼šäº§ç”Ÿä»»ä½•èŠ±é”€ã€‚ ï¼ˆgaså¯æ˜¯çœŸé‡‘ç™½é“¶å•Šï¼ï¼‰ã€‚

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« è®¨è®º`for`å¾ªç¯ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹çœ‹å¦‚ä½•å¦‚ä½•åœ¨å†…å­˜ä¸­å£°æ˜æ•°ç»„ã€‚

##### åœ¨å†…å­˜ä¸­å£°æ˜æ•°ç»„

åœ¨æ•°ç»„åé¢åŠ ä¸Š `memory`å…³é”®å­—ï¼Œ è¡¨æ˜è¿™ä¸ªæ•°ç»„æ˜¯ä»…ä»…åœ¨å†…å­˜ä¸­åˆ›å»ºï¼Œä¸éœ€è¦å†™å…¥å¤–éƒ¨å­˜å‚¨ï¼Œå¹¶ä¸”åœ¨å‡½æ•°è°ƒç”¨ç»“æŸæ—¶å®ƒå°±è§£æ•£äº†ã€‚ä¸åœ¨ç¨‹åºç»“æŸæ—¶æŠŠæ•°æ®ä¿å­˜è¿› `storage` çš„åšæ³•ç›¸æ¯”ï¼Œå†…å­˜è¿ç®—å¯ä»¥å¤§å¤§èŠ‚çœgaså¼€é”€ -- æŠŠè¿™æ•°ç»„æ”¾åœ¨`view`é‡Œç”¨ï¼Œå®Œå…¨ä¸ç”¨èŠ±é’±ã€‚

ä»¥ä¸‹æ˜¯ç”³æ˜ä¸€ä¸ªå†…å­˜æ•°ç»„çš„ä¾‹å­ï¼š

```solidity
function getArray() external pure returns(uint[]) {
  // åˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º3çš„å†…å­˜æ•°ç»„
  uint[] memory values = new uint[](3);
  // èµ‹å€¼
  values.push(1);
  values.push(2);
  values.push(3);
  // è¿”å›æ•°ç»„
  return values;
}
```

è¿™ä¸ªå°ä¾‹å­å±•ç¤ºäº†ä¸€äº›è¯­æ³•è§„åˆ™ï¼Œä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®é™…ç”¨ä¾‹ï¼Œå±•ç¤ºå®ƒå’Œ `for` å¾ªç¯ç»“åˆçš„åšæ³•ã€‚

> æ³¨æ„ï¼šå†…å­˜æ•°ç»„ **å¿…é¡»** ç”¨é•¿åº¦å‚æ•°ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º`3`ï¼‰åˆ›å»ºã€‚ç›®å‰ä¸æ”¯æŒ `array.push()`ä¹‹ç±»çš„æ–¹æ³•è°ƒæ•´æ•°ç»„å¤§å°ï¼Œåœ¨æœªæ¥çš„ç‰ˆæœ¬å¯èƒ½ä¼šæ”¯æŒé•¿åº¦ä¿®æ”¹ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬è¦è¦åˆ›å»ºä¸€ä¸ªåä¸º `getZombiesByOwner` çš„å‡½æ•°ï¼Œå®ƒä»¥`uint []`æ•°ç»„çš„å½¢å¼è¿”å›æŸä¸€ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æ‰€æœ‰åƒµå°¸ã€‚

1. å£°æ˜ä¸€ä¸ªåä¸º`result`çš„`uint [] memory'` ï¼ˆå†…å­˜å˜é‡æ•°ç»„ï¼‰
2. å°†å…¶è®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„ `uint` ç±»å‹æ•°ç»„ã€‚æ•°ç»„çš„é•¿åº¦ä¸ºè¯¥ `_owner` æ‰€æ‹¥æœ‰çš„åƒµå°¸æ•°é‡ï¼Œè¿™å¯é€šè¿‡è°ƒç”¨ `ownerZombieCount [_ owner]` æ¥è·å–ã€‚
3. å‡½æ•°ç»“æŸï¼Œè¿”å› `result` ã€‚ç›®å‰å®ƒåªæ˜¯ä¸ªç©ºæ•°åˆ—ï¼Œæˆ‘ä»¬åˆ°ä¸‹ä¸€ç« å»å®ç°å®ƒã€‚

``` solidity
function getZombiesByOwner(address _owner) external view returns(uint[]) {
    uint[] memory result = new uint[](ownerZombieCount[_owner]);
    return result;
  }
```



#### ç¬¬12ç«  For å¾ªç¯

åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æåˆ°è¿‡ï¼Œå‡½æ•°ä¸­ä½¿ç”¨çš„æ•°ç»„æ˜¯è¿è¡Œæ—¶åœ¨å†…å­˜ä¸­é€šè¿‡ `for` å¾ªç¯å®æ—¶æ„å»ºï¼Œè€Œä¸æ˜¯é¢„å…ˆå»ºç«‹åœ¨å­˜å‚¨ä¸­çš„ã€‚

ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ

ä¸ºäº†å®ç° `getZombiesByOwner` å‡½æ•°ï¼Œä¸€ç§â€œæ— è„‘å¼â€çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ `ZombieFactory` ä¸­å­˜å…¥â€ä¸»äººâ€œå’Œâ€åƒµå°¸å†›å›¢â€œçš„æ˜ å°„ã€‚

```solidity
mapping (address => uint[]) public ownerToZombies
```

ç„¶åæˆ‘ä»¬æ¯æ¬¡åˆ›å»ºæ–°åƒµå°¸æ—¶ï¼Œæ‰§è¡Œ `ownerToZombies [owner] .pushï¼ˆzombieIdï¼‰` å°†å…¶æ·»åŠ åˆ°ä¸»äººçš„åƒµå°¸æ•°ç»„ä¸­ã€‚è€Œ `getZombiesByOwner` å‡½æ•°ä¹Ÿéå¸¸ç®€å•ï¼š

```solidity
function getZombiesByOwner(address _owner) external view returns (uint[]) {
  return ownerToZombies[_owner];
}
```

##### è¿™ä¸ªåšæ³•æœ‰é—®é¢˜

åšæ³•å€’æ˜¯ç®€å•ã€‚å¯æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥æŠŠä¸€å¤´åƒµå°¸è½¬ç§»åˆ°å¦ä¸€ä¸ªä¸»äººåä¸‹ï¼ˆæˆ‘ä»¬ä¸€å®šä¼šåœ¨åé¢çš„è¯¾ç¨‹ä¸­å®ç°çš„ï¼‰ï¼Œåˆä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

è¿™ä¸ªâ€œæ¢ä¸»â€å‡½æ•°è¦åšåˆ°ï¼š

1.å°†åƒµå°¸pushåˆ°æ–°ä¸»äººçš„ `ownerToZombies` æ•°ç»„ä¸­ï¼Œ 2.ä»æ—§ä¸»çš„ `ownerToZombies` æ•°ç»„ä¸­ç§»é™¤åƒµå°¸ï¼Œ 3.å°†æ—§ä¸»åƒµå°¸æ•°ç»„ä¸­â€œæ¢ä¸»åƒµå°¸â€ä¹‹åçš„çš„æ¯å¤´åƒµå°¸éƒ½å¾€å‰æŒªä¸€ä½ï¼ŒæŠŠæŒªèµ°â€œæ¢ä¸»åƒµå°¸â€åç•™ä¸‹çš„â€œç©ºæ§½â€å¡«ä¸Šï¼Œ 4.å°†æ•°ç»„é•¿åº¦å‡1ã€‚

ä½†æ˜¯ç¬¬ä¸‰æ­¥å®åœ¨æ˜¯å¤ªè´µäº†ï¼å› ä¸ºæ¯æŒªåŠ¨ä¸€å¤´åƒµå°¸ï¼Œæˆ‘ä»¬éƒ½è¦æ‰§è¡Œä¸€æ¬¡å†™æ“ä½œã€‚å¦‚æœä¸€ä¸ªä¸»äººæœ‰20å¤´åƒµå°¸ï¼Œè€Œç¬¬ä¸€å¤´è¢«æŒªèµ°äº†ï¼Œé‚£ä¸ºäº†ä¿æŒæ•°ç»„çš„é¡ºåºï¼Œæˆ‘ä»¬å¾—åš19ä¸ªå†™æ“ä½œã€‚

ç”±äºå†™å…¥å­˜å‚¨æ˜¯ Solidity ä¸­æœ€è´¹ gas çš„æ“ä½œä¹‹ä¸€ï¼Œä½¿å¾—æ¢ä¸»å‡½æ•°çš„æ¯æ¬¡è°ƒç”¨éƒ½éå¸¸æ˜‚è´µã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™èŠ±è´¹çš„ gas éƒ½ä¸åŒï¼å…·ä½“è¿˜å–å†³äºç”¨æˆ·åœ¨åŸä¸»å†›å›¢ä¸­çš„åƒµå°¸å¤´æ•°ï¼Œä»¥åŠç§»èµ°çš„åƒµå°¸æ‰€åœ¨çš„ä½ç½®ã€‚ä»¥è‡³äºç”¨æˆ·éƒ½ä¸çŸ¥é“åº”è¯¥æ”¯ä»˜å¤šå°‘ gasã€‚

> æ³¨æ„ï¼šå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæ•°ç»„ä¸­æœ€åä¸€ä¸ªåƒµå°¸å¾€å‰æŒªæ¥å¡«è¡¥ç©ºæ§½ï¼Œå¹¶å°†æ•°ç»„é•¿åº¦å‡å°‘ä¸€ã€‚ä½†è¿™æ ·æ¯åšä¸€ç¬”äº¤æ˜“ï¼Œéƒ½ä¼šæ”¹å˜åƒµå°¸å†›å›¢çš„ç§©åºã€‚

ç”±äºä»å¤–éƒ¨è°ƒç”¨ä¸€ä¸ª `view` å‡½æ•°æ˜¯å…è´¹çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ `getZombiesByOwner` å‡½æ•°ä¸­ç”¨ä¸€ä¸ªforå¾ªç¯éå†æ•´ä¸ªåƒµå°¸æ•°ç»„ï¼ŒæŠŠå±äºæŸä¸ªä¸»äººçš„åƒµå°¸æŒ‘å‡ºæ¥æ„å»ºå‡ºåƒµå°¸æ•°ç»„ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„ `transfer` å‡½æ•°å°†ä¼šä¾¿å®œå¾—å¤šï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦æŒªåŠ¨å­˜å‚¨é‡Œçš„åƒµå°¸æ•°ç»„é‡æ–°æ’åºï¼Œæ€»ä½“ä¸Šè¿™ä¸ªæ–¹æ³•ä¼šæ›´ä¾¿å®œï¼Œè™½ç„¶æœ‰ç‚¹åç›´è§‰ã€‚

##### ä½¿ç”¨ `for` å¾ªç¯

`for`å¾ªç¯çš„è¯­æ³•åœ¨ Solidity å’Œ JavaScript ä¸­ç±»ä¼¼ã€‚

æ¥çœ‹ä¸€ä¸ªåˆ›å»ºå¶æ•°æ•°ç»„çš„ä¾‹å­ï¼š

```solidity
function getEvens() pure external returns(uint[]) {
  uint[] memory evens = new uint[](5);
  // åœ¨æ–°æ•°ç»„ä¸­è®°å½•åºåˆ—å·
  uint counter = 0;
  // åœ¨å¾ªç¯ä»1è¿­ä»£åˆ°10ï¼š
  for (uint i = 1; i <= 10; i++) {
    // å¦‚æœ `i` æ˜¯å¶æ•°...
    if (i % 2 == 0) {
      // æŠŠå®ƒåŠ å…¥å¶æ•°æ•°ç»„
      evens[counter] = i;
      //ç´¢å¼•åŠ ä¸€ï¼Œ æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºçš„â€˜evenâ€™
      counter++;
    }
  }
  return evens;
}
```

è¿™ä¸ªå‡½æ•°å°†è¿”å›ä¸€ä¸ªå½¢ä¸º `[2,4,6,8,10]` çš„æ•°ç»„ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å›åˆ° `getZombiesByOwner` å‡½æ•°ï¼Œ é€šè¿‡ä¸€æ¡ `for` å¾ªç¯æ¥éå† DApp ä¸­æ‰€æœ‰çš„åƒµå°¸ï¼Œ å°†ç»™å®šçš„â€˜ç”¨æˆ·id'ä¸æ¯å¤´åƒµå°¸çš„â€˜ä¸»äººâ€™è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶åœ¨å‡½æ•°è¿”å›ä¹‹å‰å°†å®ƒä»¬æ¨é€åˆ°æˆ‘ä»¬çš„`result` æ•°ç»„ä¸­ã€‚

1.å£°æ˜ä¸€ä¸ªå˜é‡ `counter`ï¼Œå±æ€§ä¸º `uint`ï¼Œè®¾å…¶å€¼ä¸º `0` ã€‚æˆ‘ä»¬ç”¨è¿™ä¸ªå˜é‡ä½œä¸º `result` æ•°ç»„çš„ç´¢å¼•ã€‚

2.å£°æ˜ä¸€ä¸ª `for` å¾ªç¯ï¼Œ ä» `uint i = 0` åˆ° `i <zombies.length`ã€‚å®ƒå°†éå†æ•°ç»„ä¸­çš„æ¯ä¸€å¤´åƒµå°¸ã€‚

3.åœ¨æ¯ä¸€è½® `for` å¾ªç¯ä¸­ï¼Œç”¨ä¸€ä¸ª `if` è¯­å¥æ¥æ£€æŸ¥ `zombieToOwner [i]` æ˜¯å¦ç­‰äº `_owner`ã€‚è¿™ä¼šæ¯”è¾ƒä¸¤ä¸ªåœ°å€æ˜¯å¦åŒ¹é…ã€‚

4.åœ¨ `if` è¯­å¥ä¸­ï¼š

1. é€šè¿‡å°† `result [counter]` è®¾ç½®ä¸º `i`ï¼Œå°†åƒµå°¸IDæ·»åŠ åˆ° `result` æ•°ç»„ä¸­ã€‚
2. å°†counteråŠ 1ï¼ˆå‚è§ä¸Šé¢çš„forå¾ªç¯ç¤ºä¾‹ï¼‰ã€‚

å°±æ˜¯è¿™æ · - è¿™ä¸ªå‡½æ•°èƒ½è¿”å› `_owner` æ‰€æ‹¥æœ‰çš„åƒµå°¸æ•°ç»„ï¼Œä¸èŠ±ä¸€åˆ†é’± gasã€‚

``` solidity
function getZombiesByOwner(address _owner)
    external
    view
    returns (uint256[] memory)
{
    uint256[] memory result = new uint256[](ownerZombieCount[_owner]);
    uint256 counter = 0;
    for (uint256 i = 0; i < zombies.length; i++) {
        if (zombieToOwner[i] == _owner) {
            result[counter] = i;
            counter++;
        }
    }
    return result;
}
```



#### ç¬¬13ç«  æ”¾åœ¨ä¸€èµ·

æ­å–œæ‚¨å•Šï¼Œå±…ç„¶æŠŠç¬¬ä¸‰è¯¾ä¹Ÿå­¦å®Œäº†ï¼

##### è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼š

- æ·»åŠ äº†ä¸€ç§æ–°æ–¹æ³•æ¥ä¿®æ”¹CryptoKittiesåˆçº¦
- å­¦ä¼šä½¿ç”¨ `onlyOwner` è¿›è¡Œè°ƒç”¨æƒé™é™åˆ¶
- äº†è§£äº† gas å’Œ gas çš„ä¼˜åŒ–
- ä¸ºåƒµå°¸æ·»åŠ äº† â€œçº§åˆ«â€ å’Œ â€œå†·å´å‘¨æœŸâ€å±æ€§
- å½“åƒµå°¸è¾¾åˆ°ä¸€å®šçº§åˆ«æ—¶ï¼Œå…è®¸ä¿®æ”¹åƒµå°¸çš„åå­—å’Œ DNA
- æœ€åï¼Œå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œç”¨ä»¥è¿”å›æŸä¸ªç©å®¶çš„åƒµå°¸å†›å›¢

##### é¢†å¥–æ—¶é—´

ä½œä¸ºå®Œæˆç¬¬ä¸‰è¯¾çš„å¥–åŠ±ï¼Œæ‚¨çš„ä¸¤ä¸ªåƒµå°¸éƒ½å·²ç»å‡çº§äº†ï¼

ç°åœ¨ NoNameï¼ˆä½ åœ¨ç¬¬2è¯¾åˆ›å»ºçš„å°çŒ«åƒµå°¸ï¼‰å·²ç»å‡çº§åˆ°ç¬¬2çº§ï¼Œä½ å¯ä»¥è°ƒç”¨ `changeName` ç»™å®ƒå–ä¸ªåå­—ã€‚ ç»ˆäºä¸å†æ˜¯æ— åä¹‹è¾ˆäº†ï¼

å»ç»™æ‚¨çš„ NoName å–ä¸ªåå­—å§ï¼Œç­‰ä½ åšå®Œä¸‹ä¸€ç« ï¼Œæœ¬è¯¾ç¨‹å°±ç»“æŸäº†ã€‚

<img src="https://markdown-res.oss-cn-hangzhou.aliyuncs.com/mdImgs/2022/05/07/20220507134656.png" align="center" style="width:500px" />

##### æ­å–œ! ä½ å®Œæˆäº† CryptoZombies çš„ç¬¬ä¸‰è¯¾

**æˆå°±è§£é”äº†:**

- GG å‡çº§åˆ°äº†ç¬¬ 3 çº§!
- TT å‡çº§åˆ°äº†ç¬¬ 2 çº§!

##### å‘ä½ çš„æœ‹å‹ä»¬ç‚«è€€ä½ çš„åƒµå°¸å§

æŠŠè¿™ä¸ªç½‘å€å‘é€ç»™ä½ çš„æœ‹å‹ï¼Œä»–ä»¬å°±èƒ½å›´è§‚ä½ çš„åƒµå°¸å¤§å†›äº†:

https://share.cryptozombies.io/zh/lesson/3/share/GG?id=Y3p8MjEwMTY2



### 1.4 åƒµå°¸ä½œæˆ˜ç³»ç»Ÿ

è¿™ä¸€åˆ»ç»ˆäºæ¥äº†, äººç±»â€¦â€¦

æ˜¯æ—¶å€™è®©ä½ çš„åƒµå°¸æˆ˜æ–—äº†ï¼

ä¸è¿‡åƒµå°¸å¤§æˆ˜å¹¶ä¸é€‚åˆèƒ†å°çš„äººâ€¦â€¦

åœ¨è¿™ä¸€è¯¾, æˆ‘ä»¬å°†ç»¼åˆåˆ©ç”¨åœ¨å‰é¢è¯¾ç¨‹ä¸­å­¦åˆ°çš„è®¸å¤šçŸ¥è¯†ï¼Œåˆ›å»ºä¸€ä¸ªåƒµå°¸ä½œæˆ˜ç³»ç»Ÿã€‚ æˆ‘ä»¬ä¹Ÿå°†å­¦ä¹  `payable` å‡½æ•°ï¼Œå­¦ä¹ å¦‚ä½•å¼€å‘å¯ä»¥æ¥æ”¶å…¶ä»–ç©å®¶ä»˜æ¬¾çš„DAppã€‚



#### ç¬¬1ç«  å¯æ”¯ä»˜

æˆªè‡³ç›®å‰ï¼Œæˆ‘ä»¬åªæ¥è§¦åˆ°å¾ˆå°‘çš„ ***å‡½æ•°ä¿®é¥°ç¬¦***ã€‚ è¦è®°ä½æ‰€æœ‰çš„ä¸œè¥¿å¾ˆéš¾ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸ªæ¦‚è§ˆï¼š

1. æˆ‘ä»¬æœ‰å†³å®šå‡½æ•°ä½•æ—¶å’Œè¢«è°è°ƒç”¨çš„å¯è§æ€§ä¿®é¥°ç¬¦: `private` æ„å‘³ç€å®ƒåªèƒ½è¢«åˆçº¦å†…éƒ¨è°ƒç”¨ï¼› `internal` å°±åƒ `private` ä½†æ˜¯ä¹Ÿèƒ½è¢«ç»§æ‰¿çš„åˆçº¦è°ƒç”¨ï¼› `external` åªèƒ½ä»åˆçº¦å¤–éƒ¨è°ƒç”¨ï¼›æœ€å `public` å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä¸ç®¡æ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ã€‚
2. æˆ‘ä»¬ä¹Ÿæœ‰çŠ¶æ€ä¿®é¥°ç¬¦ï¼Œ å‘Šè¯‰æˆ‘ä»¬å‡½æ•°å¦‚ä½•å’ŒåŒºå—é“¾äº¤äº’: `view` å‘Šè¯‰æˆ‘ä»¬è¿è¡Œè¿™ä¸ªå‡½æ•°ä¸ä¼šæ›´æ”¹å’Œä¿å­˜ä»»ä½•æ•°æ®ï¼› `pure` å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå‡½æ•°ä¸ä½†ä¸ä¼šå¾€åŒºå—é“¾å†™æ•°æ®ï¼Œå®ƒç”šè‡³ä¸ä»åŒºå—é“¾è¯»å–æ•°æ®ã€‚è¿™ä¸¤ç§åœ¨è¢«ä»åˆçº¦å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™éƒ½ä¸èŠ±è´¹ä»»ä½•gasï¼ˆä½†æ˜¯å®ƒä»¬åœ¨è¢«å†…éƒ¨å…¶ä»–å‡½æ•°è°ƒç”¨çš„æ—¶å€™å°†ä¼šè€—è´¹gasï¼‰ã€‚
3. ç„¶åæˆ‘ä»¬æœ‰äº†è‡ªå®šä¹‰çš„ `modifiers`ï¼Œä¾‹å¦‚åœ¨ç¬¬ä¸‰è¯¾å­¦ä¹ çš„: `onlyOwner` å’Œ `aboveLevel`ã€‚ å¯¹äºè¿™äº›ä¿®é¥°ç¬¦æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å…¶å¯¹å‡½æ•°çš„çº¦æŸé€»è¾‘ã€‚

è¿™äº›ä¿®é¥°ç¬¦å¯ä»¥åŒæ—¶ä½œç”¨äºä¸€ä¸ªå‡½æ•°å®šä¹‰ä¸Šï¼š

```solidity
function test() external view onlyOwner anotherModifier { /* ... */ }
```

åœ¨è¿™ä¸€ç« ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸ªæ–°çš„ä¿®é¥°ç¬¦ `payable`.

##### `payable` ä¿®é¥°ç¬¦

`payable` æ–¹æ³•æ˜¯è®© Solidity å’Œä»¥å¤ªåŠå˜å¾—å¦‚æ­¤é…·çš„ä¸€éƒ¨åˆ† â€”â€” å®ƒä»¬æ˜¯ä¸€ç§å¯ä»¥æ¥æ”¶ä»¥å¤ªçš„ç‰¹æ®Šå‡½æ•°ã€‚

å…ˆæ”¾ä¸€ä¸‹ã€‚å½“ä½ åœ¨è°ƒç”¨ä¸€ä¸ªæ™®é€šç½‘ç«™æœåŠ¡å™¨ä¸Šçš„APIå‡½æ•°çš„æ—¶å€™ï¼Œä½ æ— æ³•ç”¨ä½ çš„å‡½æ•°ä¼ é€ç¾å…ƒâ€”â€”ä½ ä¹Ÿä¸èƒ½ä¼ é€æ¯”ç‰¹å¸ã€‚

ä½†æ˜¯åœ¨ä»¥å¤ªåŠä¸­ï¼Œ å› ä¸ºé’± (_ä»¥å¤ª_), æ•°æ® (*äº‹åŠ¡è´Ÿè½½*)ï¼Œ ä»¥åŠåˆçº¦ä»£ç æœ¬èº«éƒ½å­˜åœ¨äºä»¥å¤ªåŠã€‚ä½ å¯ä»¥åœ¨åŒæ—¶è°ƒç”¨å‡½æ•° **å¹¶**ä»˜é’±ç»™å¦å¤–ä¸€ä¸ªåˆçº¦ã€‚

è¿™å°±å…è®¸å‡ºç°å¾ˆå¤šæœ‰è¶£çš„é€»è¾‘ï¼Œ æ¯”å¦‚å‘ä¸€ä¸ªåˆçº¦è¦æ±‚æ”¯ä»˜ä¸€å®šçš„é’±æ¥è¿è¡Œä¸€ä¸ªå‡½æ•°ã€‚

##### æ¥çœ‹ä¸ªä¾‹å­

```solidity
contract OnlineStore {
  function buySomething() external payable {
    // æ£€æŸ¥ä»¥ç¡®å®š0.001ä»¥å¤ªå‘é€å‡ºå»æ¥è¿è¡Œå‡½æ•°:
    require(msg.value == 0.001 ether);
    // å¦‚æœä¸ºçœŸï¼Œä¸€äº›ç”¨æ¥å‘å‡½æ•°è°ƒç”¨è€…å‘é€æ•°å­—å†…å®¹çš„é€»è¾‘
    transferThing(msg.sender);
  }
}
```

åœ¨è¿™é‡Œï¼Œ`msg.value` æ˜¯ä¸€ç§å¯ä»¥æŸ¥çœ‹å‘åˆçº¦å‘é€äº†å¤šå°‘ä»¥å¤ªçš„æ–¹æ³•ï¼Œå¦å¤– `ether` æ˜¯ä¸€ä¸ªå…§å»ºå•å…ƒã€‚

è¿™é‡Œå‘ç”Ÿçš„äº‹æ˜¯ï¼Œä¸€äº›äººä¼šä» web3.js è°ƒç”¨è¿™ä¸ªå‡½æ•° (ä»DAppçš„å‰ç«¯)ï¼Œ åƒè¿™æ · :

```solidity
// å‡è®¾ `OnlineStore` åœ¨ä»¥å¤ªåŠä¸ŠæŒ‡å‘ä½ çš„åˆçº¦:
OnlineStore.buySomething().send(from: web3.eth.defaultAccount, value: web3.utils.toWei(0.001))
```

æ³¨æ„è¿™ä¸ª `value` å­—æ®µï¼Œ JavaScript è°ƒç”¨æ¥æŒ‡å®šå‘é€å¤šå°‘(0.001)`ä»¥å¤ª`ã€‚å¦‚æœæŠŠäº‹åŠ¡æƒ³è±¡æˆä¸€ä¸ªä¿¡å°ï¼Œä½ å‘é€åˆ°å‡½æ•°çš„å‚æ•°å°±æ˜¯ä¿¡çš„å†…å®¹ã€‚ æ·»åŠ ä¸€ä¸ª `value` å¾ˆåƒåœ¨ä¿¡å°é‡Œé¢æ”¾é’± â€”â€” ä¿¡ä»¶å†…å®¹å’Œé’±åŒæ—¶å‘é€ç»™äº†æ¥æ”¶è€…ã€‚

> æ³¨æ„ï¼š å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æ ‡è®°ä¸º`payable`ï¼Œ è€Œä½ å°è¯•åˆ©ç”¨ä¸Šé¢çš„æ–¹æ³•å‘é€ä»¥å¤ªï¼Œå‡½æ•°å°†æ‹’ç»ä½ çš„äº‹åŠ¡ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥åœ¨åƒµå°¸æ¸¸æˆé‡Œé¢åˆ›å»ºä¸€ä¸ª`payable` å‡½æ•°ã€‚

å‡å®šåœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œç©å®¶å¯ä»¥é€šè¿‡æ”¯ä»˜ETHæ¥å‡çº§ä»–ä»¬çš„åƒµå°¸ã€‚ETHå°†å­˜å‚¨åœ¨ä½ æ‹¥æœ‰çš„åˆçº¦ä¸­ â€”â€” ä¸€ä¸ªç®€å•æ˜äº†çš„ä¾‹å­ï¼Œå‘ä½ å±•ç¤ºä½ å¯ä»¥é€šè¿‡è‡ªå·±çš„æ¸¸æˆèµšé’±ã€‚

1. å®šä¹‰ä¸€ä¸ª `uint` ï¼Œå‘½åä¸º `levelUpFee`, å°†å€¼è®¾å®šä¸º `0.001 ether`ã€‚
2. å®šä¹‰ä¸€ä¸ªåä¸º `levelUp` çš„å‡½æ•°ã€‚ å®ƒå°†æ¥æ”¶ä¸€ä¸ª `uint` å‚æ•° `_zombieId`ã€‚ å‡½æ•°åº”è¯¥ä¿®é¥°ä¸º `external` ä»¥åŠ `payable`ã€‚
3. è¿™ä¸ªå‡½æ•°é¦–å…ˆåº”è¯¥ `require` ç¡®ä¿ `msg.value` ç­‰äº `levelUpFee`ã€‚
4. ç„¶åå®ƒåº”è¯¥å¢åŠ åƒµå°¸çš„ `level`: `zombies[_zombieId].level++`ã€‚

``` solidity
// å‡çº§æ‰€éœ€æ”¯ä»˜è´¹ç”¨
uint levelUpFee = 0.001 ether;
// ... other code ...
// æ”¯ä»˜ethï¼Œå‡çº§åƒµå°¸ 
function levelUp(uint _zombieId) external payable {
    require(msg.value == levelUpFee);
    zombies[_zombieId].level++;
}
```



#### ç¬¬2ç«  æç°

åœ¨ä¸Šä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å‘åˆçº¦å‘é€ä»¥å¤ªï¼Œé‚£ä¹ˆåœ¨å‘é€ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨ä½ å‘é€ä»¥å¤ªä¹‹åï¼Œå®ƒå°†è¢«å­˜å‚¨è¿›ä»¥åˆçº¦çš„ä»¥å¤ªåŠè´¦æˆ·ä¸­ï¼Œ å¹¶å†»ç»“åœ¨å“ªé‡Œ â€”â€” é™¤éä½ æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥ä»åˆçº¦ä¸­æŠŠä»¥å¤ªæç°ã€‚

ä½ å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°æ¥ä»åˆçº¦ä¸­æç°ä»¥å¤ªï¼Œç±»ä¼¼è¿™æ ·ï¼š

```solidity
contract GetPaid is Ownable {
  function withdraw() external onlyOwner {
    owner.transfer(this.balance);
  }
}
```

æ³¨æ„æˆ‘ä»¬ä½¿ç”¨ `Ownable` åˆçº¦ä¸­çš„ `owner` å’Œ `onlyOwner`ï¼Œå‡å®šå®ƒå·²ç»è¢«å¼•å…¥äº†ã€‚

ä½ å¯ä»¥é€šè¿‡ `transfer` å‡½æ•°å‘ä¸€ä¸ªåœ°å€å‘é€ä»¥å¤ªï¼Œ ç„¶å `this.balance` å°†è¿”å›å½“å‰åˆçº¦å­˜å‚¨äº†å¤šå°‘ä»¥å¤ªã€‚ æ‰€ä»¥å¦‚æœ100ä¸ªç”¨æˆ·æ¯äººå‘æˆ‘ä»¬æ”¯ä»˜1ä»¥å¤ªï¼Œ `this.balance` å°†æ˜¯100ä»¥å¤ªã€‚

ä½ å¯ä»¥é€šè¿‡ `transfer` å‘ä»»ä½•ä»¥å¤ªåŠåœ°å€ä»˜é’±ã€‚ æ¯”å¦‚ï¼Œä½ å¯ä»¥æœ‰ä¸€ä¸ªå‡½æ•°åœ¨ `msg.sender` è¶…é¢ä»˜æ¬¾çš„æ—¶å€™ç»™ä»–ä»¬é€€é’±ï¼š

```solidity
uint itemFee = 0.001 ether;
msg.sender.transfer(msg.value - itemFee);
```

æˆ–è€…åœ¨ä¸€ä¸ªæœ‰å–å®¶å’Œå–å®¶çš„åˆçº¦ä¸­ï¼Œ ä½ å¯ä»¥æŠŠå–å®¶çš„åœ°å€å­˜å‚¨èµ·æ¥ï¼Œ å½“æœ‰äººä¹°äº†å®ƒçš„ä¸œè¥¿çš„æ—¶å€™ï¼ŒæŠŠä¹°å®¶æ”¯ä»˜çš„é’±å‘é€ç»™å®ƒ `seller.transfer(msg.value)`ã€‚

æœ‰å¾ˆå¤šä¾‹å­æ¥å±•ç¤ºä»€ä¹ˆè®©ä»¥å¤ªåŠç¼–ç¨‹å¦‚æ­¤ä¹‹é…· â€”â€” ä½ å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªä¸è¢«ä»»ä½•äººæ§åˆ¶çš„å»ä¸­å¿ƒåŒ–å¸‚åœºã€‚

##### å®æˆ˜æ¼”ä¹ 

1. åœ¨æˆ‘ä»¬çš„åˆçº¦é‡Œåˆ›å»ºä¸€ä¸ª `withdraw` å‡½æ•°ï¼Œå®ƒåº”è¯¥å‡ ä¹å’Œä¸Šé¢çš„`GetPaid`ä¸€æ ·ã€‚

2. ä»¥å¤ªçš„ä»·æ ¼åœ¨è¿‡å»å‡ å¹´å†…ç¿»äº†åå‡ å€ï¼Œåœ¨æˆ‘ä»¬å†™è¿™ä¸ªæ•™ç¨‹çš„æ—¶å€™ 0.01 ä»¥å¤ªç›¸å½“äº1ç¾å…ƒï¼Œå¦‚æœå®ƒå†ç¿»åå€ 0.001 ä»¥å¤ªå°†æ˜¯10ç¾å…ƒï¼Œé‚£æˆ‘ä»¬çš„æ¸¸æˆå°±å¤ªè´µäº†ã€‚

   æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å†åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå…è®¸æˆ‘ä»¬ä»¥åˆçº¦æ‹¥æœ‰è€…çš„èº«ä»½æ¥è®¾ç½® `levelUpFee`ã€‚

   a. åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œåä¸º `setLevelUpFee`ï¼Œ å…¶æ¥æ”¶ä¸€ä¸ªå‚æ•° `uint _fee`ï¼Œæ˜¯ `external` å¹¶ä½¿ç”¨ä¿®é¥°ç¬¦ `onlyOwner`ã€‚

   b. è¿™ä¸ªå‡½æ•°åº”è¯¥è®¾ç½® `levelUpFee` ç­‰äº `_fee`ã€‚

``` solidity
// ä»åˆçº¦ä¸­æç°ä»¥å¤ª
function withdraw() external onlyOwner {
    payable(owner).transfer(address(this).balance);
}
// è®¾ç½®æ”¯ä»˜è´¹ç”¨ 
function setLevelUpfee(uint _fee) external onlyOwner {
    levelUpFee = _fee;
}
```



#### ç¬¬3ç«  åƒµå°¸æˆ˜æ–—

åœ¨æˆ‘ä»¬å­¦ä¹ äº†å¯æ”¯ä»˜å‡½æ•°å’Œåˆçº¦ä½™é¢ä¹‹åï¼Œæ˜¯æ—¶å€™ä¸ºåƒµå°¸æˆ˜æ–—æ·»åŠ åŠŸèƒ½äº†ã€‚

éµå¾ªä¸Šä¸€ç« çš„æ ¼å¼ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªæ”»å‡»åŠŸèƒ½åˆçº¦ï¼Œå¹¶å°†ä»£ç æ”¾è¿›æ–°çš„æ–‡ä»¶ä¸­ï¼Œå¼•å…¥ä¸Šä¸€ä¸ªåˆçº¦ã€‚

##### å®æˆ˜æ¼”ä¹ 

å†æ¥æ–°å»ºä¸€ä¸ªåˆçº¦å§ã€‚ç†Ÿèƒ½ç”Ÿå·§ã€‚

å¦‚æœä½ ä¸è®°å¾—æ€ä¹ˆåšäº†, æŸ¥çœ‹ä¸€ä¸‹ `zombiehelper.sol` â€” ä¸è¿‡æœ€å¥½å…ˆè¯•ç€åšä¸€ä¸‹ï¼Œæ£€æŸ¥ä¸€ä¸‹ä½ æŒæ¡çš„æƒ…å†µã€‚

1. åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰ Solidity çš„ç‰ˆæœ¬ `^0.4.19`.
2. `import` è‡ª `zombiehelper.sol` .
3. å£°æ˜ä¸€ä¸ªæ–°çš„ `contract`ï¼Œå‘½åä¸º `ZombieBattle`ï¼Œ ç»§æ‰¿è‡ª`ZombieHelper`ã€‚å‡½æ•°ä½“å°±å…ˆç©ºç€å§ã€‚

``` solidity
// SPDX-License-Identifier: MIT
pragma solidity >=0.4.19;

import "./zombiehelper.sol";

contract ZombieBattle is ZombieHelper {
}
```



#### ç¬¬4ç«  éšæœºæ•°

ä½ å¤ªæ£’äº†ï¼æ¥ä¸‹æ¥æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹æˆ˜æ–—é€»è¾‘ã€‚

ä¼˜ç§€çš„æ¸¸æˆéƒ½éœ€è¦ä¸€äº›éšæœºå…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ Solidity é‡Œå¦‚ä½•ç”Ÿæˆéšæœºæ•°å‘¢ï¼Ÿ

çœŸæ­£çš„ç­”æ¡ˆæ˜¯ä½ ä¸èƒ½ï¼Œæˆ–è€…æœ€èµ·ç ï¼Œä½ æ— æ³•å®‰å…¨åœ°åšåˆ°è¿™ä¸€ç‚¹ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ä¸ºä»€ä¹ˆ

##### ç”¨ `keccak256` æ¥åˆ¶é€ éšæœºæ•°ã€‚

Solidity ä¸­æœ€å¥½çš„éšæœºæ•°ç”Ÿæˆå™¨æ˜¯ `keccak256` å“ˆå¸Œå‡½æ•°.

æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥ç”Ÿæˆä¸€äº›éšæœºæ•°

```solidity
// ç”Ÿæˆä¸€ä¸ª0åˆ°100çš„éšæœºæ•°:
uint randNonce = 0;
uint random = uint(keccak256(now, msg.sender, randNonce)) % 100;
randNonce++;
uint random2 = uint(keccak256(now, msg.sender, randNonce)) % 100;
```

è¿™ä¸ªæ–¹æ³•é¦–å…ˆæ‹¿åˆ° `now` çš„æ—¶é—´æˆ³ã€ `msg.sender`ã€ ä»¥åŠä¸€ä¸ªè‡ªå¢æ•° `nonce` ï¼ˆä¸€ä¸ªä»…ä¼šè¢«ä½¿ç”¨ä¸€æ¬¡çš„æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå¯¹ç›¸åŒçš„è¾“å…¥å€¼è°ƒç”¨ä¸€æ¬¡ä»¥ä¸Šå“ˆå¸Œå‡½æ•°äº†ï¼‰ã€‚

ç„¶ååˆ©ç”¨ `keccak` æŠŠè¾“å…¥çš„å€¼è½¬å˜ä¸ºä¸€ä¸ªå“ˆå¸Œå€¼, å†å°†å“ˆå¸Œå€¼è½¬æ¢ä¸º `uint`, ç„¶ååˆ©ç”¨ `% 100` æ¥å–æœ€åä¸¤ä½, å°±ç”Ÿæˆäº†ä¸€ä¸ª0åˆ°100ä¹‹é—´éšæœºæ•°äº†ã€‚

##### è¿™ä¸ªæ–¹æ³•å¾ˆå®¹æ˜“è¢«ä¸è¯šå®çš„èŠ‚ç‚¹æ”»å‡»

åœ¨ä»¥å¤ªåŠä¸Š, å½“ä½ åœ¨å’Œä¸€ä¸ªåˆçº¦ä¸Šè°ƒç”¨å‡½æ•°çš„æ—¶å€™, ä½ ä¼šæŠŠå®ƒå¹¿æ’­ç»™ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…åœ¨ç½‘ç»œä¸Šçš„ ***transaction*** èŠ‚ç‚¹ä»¬ã€‚ ç½‘ç»œä¸Šçš„èŠ‚ç‚¹å°†æ”¶é›†å¾ˆå¤šäº‹åŠ¡, è¯•ç€æˆä¸ºç¬¬ä¸€ä¸ªè§£å†³è®¡ç®—å¯†é›†å‹æ•°å­¦é—®é¢˜çš„äººï¼Œä½œä¸ºâ€œå·¥ä½œè¯æ˜â€ï¼Œç„¶åå°†â€œå·¥ä½œè¯æ˜â€(Proof of Work, PoW)å’Œäº‹åŠ¡ä¸€èµ·ä½œä¸ºä¸€ä¸ª ***block*** å‘å¸ƒåœ¨ç½‘ç»œä¸Šã€‚

ä¸€æ—¦ä¸€ä¸ªèŠ‚ç‚¹è§£å†³äº†ä¸€ä¸ªPoW, å…¶ä»–èŠ‚ç‚¹å°±ä¼šåœæ­¢å°è¯•è§£å†³è¿™ä¸ª PoW, å¹¶éªŒè¯å…¶ä»–èŠ‚ç‚¹çš„äº‹åŠ¡åˆ—è¡¨æ˜¯æœ‰æ•ˆçš„ï¼Œç„¶åæ¥å—è¿™ä¸ªèŠ‚ç‚¹è½¬è€Œå°è¯•è§£å†³ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

**è¿™å°±è®©æˆ‘ä»¬çš„éšæœºæ•°å‡½æ•°å˜å¾—å¯åˆ©ç”¨äº†**

æˆ‘ä»¬å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç¡¬å¸ç¿»è½¬åˆçº¦â€”â€”æ­£é¢ä½ èµ¢åŒå€é’±ï¼Œåé¢ä½ è¾“æ‰æ‰€æœ‰çš„é’±ã€‚å‡å¦‚å®ƒä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•æ¥å†³å®šæ˜¯æ­£é¢è¿˜æ˜¯åé¢ (`random >= 50` ç®—æ­£é¢, `random < 50` ç®—åé¢)ã€‚

å¦‚æœæˆ‘æ­£è¿è¡Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘å¯ä»¥ **åªå¯¹æˆ‘è‡ªå·±çš„èŠ‚ç‚¹** å‘å¸ƒä¸€ä¸ªäº‹åŠ¡ï¼Œä¸”ä¸åˆ†äº«å®ƒã€‚ æˆ‘å¯ä»¥è¿è¡Œç¡¬å¸ç¿»è½¬æ–¹æ³•æ¥å·çª¥æˆ‘çš„è¾“èµ¢ â€” å¦‚æœæˆ‘è¾“äº†ï¼Œæˆ‘å°±ä¸æŠŠè¿™ä¸ªäº‹åŠ¡åŒ…å«è¿›æˆ‘è¦è§£å†³çš„ä¸‹ä¸€ä¸ªåŒºå—ä¸­å»ã€‚æˆ‘å¯ä»¥ä¸€ç›´è¿è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œç›´åˆ°æˆ‘èµ¢å¾—äº†ç¡¬å¸ç¿»è½¬å¹¶è§£å†³äº†ä¸‹ä¸€ä¸ªåŒºå—ï¼Œç„¶åè·åˆ©ã€‚

##### æ‰€ä»¥æˆ‘ä»¬è¯¥å¦‚ä½•åœ¨ä»¥å¤ªåŠä¸Šå®‰å…¨åœ°ç”Ÿæˆéšæœºæ•°å‘¢

å› ä¸ºåŒºå—é“¾çš„å…¨éƒ¨å†…å®¹å¯¹æ‰€æœ‰å‚ä¸è€…æ¥è¯´æ˜¯é€æ˜çš„ï¼Œ è¿™å°±è®©è¿™ä¸ªé—®é¢˜å˜å¾—å¾ˆéš¾ï¼Œå®ƒçš„è§£å†³æ–¹æ³•ä¸åœ¨æœ¬è¯¾ç¨‹è®¨è®ºèŒƒå›´ï¼Œä½ å¯ä»¥é˜…è¯» [è¿™ä¸ª StackOverflow ä¸Šçš„è®¨è®º](https://ethereum.stackexchange.com/questions/191/how-can-i-securely-generate-a-random-number-in-my-smart-contract) æ¥è·å¾—ä¸€äº›ä¸»æ„ã€‚ ä¸€ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ ***oracle\*** æ¥è®¿é—®ä»¥å¤ªåŠåŒºå—é“¾ä¹‹å¤–çš„éšæœºæ•°å‡½æ•°ã€‚

å½“ç„¶ï¼Œ å› ä¸ºç½‘ç»œä¸Šæˆåƒä¸Šä¸‡çš„ä»¥å¤ªåŠèŠ‚ç‚¹éƒ½åœ¨ç«äº‰è§£å†³ä¸‹ä¸€ä¸ªåŒºå—ï¼Œæˆ‘èƒ½æˆåŠŸè§£å†³ä¸‹ä¸€ä¸ªåŒºå—çš„å‡ ç‡éå¸¸ä¹‹ä½ã€‚ è¿™å°†èŠ±è´¹æˆ‘ä»¬å·¨å¤§çš„è®¡ç®—èµ„æºæ¥å¼€å‘è¿™ä¸ªè·åˆ©æ–¹æ³• â€” ä½†æ˜¯å¦‚æœå¥–åŠ±å¼‚å¸¸åœ°é«˜(æ¯”å¦‚æˆ‘å¯ä»¥åœ¨ç¡¬å¸ç¿»è½¬å‡½æ•°ä¸­èµ¢å¾— 1ä¸ªäº¿)ï¼Œ é‚£å°±å¾ˆå€¼å¾—å»æ”»å‡»äº†ã€‚

æ‰€ä»¥å°½ç®¡è¿™ä¸ªæ–¹æ³•åœ¨ä»¥å¤ªåŠä¸Šä¸å®‰å…¨ï¼Œåœ¨å®é™…ä¸­ï¼Œé™¤éæˆ‘ä»¬çš„éšæœºå‡½æ•°æœ‰ä¸€å¤§ç¬”é’±åœ¨ä¸Šé¢ï¼Œä½ æ¸¸æˆçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºå»æ”»å‡»çš„ã€‚

å› ä¸ºåœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨ç¼–å†™ä¸€ä¸ªç®€å•çš„æ¸¸æˆæ¥åšæ¼”ç¤ºï¼Œä¹Ÿæ²¡æœ‰çœŸæ­£çš„é’±åœ¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šæ¥å—è¿™ä¸ªä¸è¶³ä¹‹å¤„ï¼Œä½¿ç”¨è¿™ä¸ªç®€å•çš„éšæœºæ•°ç”Ÿæˆå‡½æ•°ã€‚ä½†æ˜¯è¦è°¨è®°å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå‡½æ•°ï¼Œå¥½æ¥è®¡ç®—æˆ˜æ–—çš„ç»“æœã€‚è™½ç„¶è¿™ä¸ªå‡½æ•°ä¸€ç‚¹å„¿ä¹Ÿä¸å®‰å…¨ã€‚

1. ç»™æˆ‘ä»¬åˆçº¦ä¸€ä¸ªåä¸º `randNonce` çš„ `uint`ï¼Œå°†å…¶å€¼è®¾ç½®ä¸º `0`ã€‚
2. å»ºç«‹ä¸€ä¸ªå‡½æ•°ï¼Œå‘½åä¸º `randMod` (random-modulus)ã€‚å®ƒå°†ä½œä¸º`internal` å‡½æ•°ï¼Œä¼ å…¥ä¸€ä¸ªåä¸º `_modulus`çš„ `uint`ï¼Œå¹¶ `returns` ä¸€ä¸ª `uint`ã€‚
3. è¿™ä¸ªå‡½æ•°é¦–å…ˆå°†ä¸º `randNonce`åŠ ä¸€ï¼Œ (ä½¿ç”¨ `randNonce++` è¯­å¥)ã€‚
4. æœ€åï¼Œå®ƒåº”è¯¥ (åœ¨ä¸€è¡Œä»£ç ä¸­) è®¡ç®— `now`, `msg.sender`, ä»¥åŠ `randNonce` çš„ `keccak256` å“ˆå¸Œå€¼å¹¶è½¬æ¢ä¸º `uint`â€”â€” æœ€å `return` `% _modulus` çš„å€¼ã€‚ ï¼ˆå¤©! å¬èµ·æ¥å¤ªæ‹—å£äº†ã€‚å¦‚æœä½ æœ‰ç‚¹ç†è§£ä¸è¿‡æ¥ï¼Œçœ‹ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢è®¡ç®—éšæœºæ•°çš„ä¾‹å­ï¼Œå®ƒä»¬çš„é€»è¾‘éå¸¸ç›¸ä¼¼ï¼‰

``` solidity
contract ZombieBattle is ZombieHelper {

    uint randNonce = 0;

    function randMod(uint _modulus) internal returns(uint) {
        randNonce++;
        // æ ¹æ® Solidity ç‰ˆæœ¬ï¼Œåšç›¸åº”æ›´æ–°
        return uint(keccak256(abi.encode(block.timestamp, msg.sender, randNonce))) % _modulus;
    }
}
```



#### ç¬¬5ç«  åƒµå°¸å¯¹æˆ˜

æˆ‘ä»¬çš„åˆçº¦å·²ç»æœ‰äº†ä¸€äº›éšæœºæ€§çš„æ¥æºï¼Œå¯ä»¥ç”¨è¿›æˆ‘ä»¬çš„åƒµå°¸æˆ˜æ–—ä¸­å»è®¡ç®—ç»“æœã€‚

æˆ‘ä»¬çš„åƒµå°¸æˆ˜æ–—çœ‹èµ·æ¥å°†æ˜¯è¿™ä¸ªæµç¨‹ï¼š

- ä½ é€‰æ‹©ä¸€ä¸ªè‡ªå·±çš„åƒµå°¸ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¯¹æ‰‹çš„åƒµå°¸å»æ”»å‡»ã€‚
- å¦‚æœä½ æ˜¯æ”»å‡»æ–¹ï¼Œä½ å°†æœ‰70%çš„å‡ ç‡è·èƒœï¼Œé˜²å®ˆæ–¹å°†æœ‰30%çš„å‡ ç‡è·èƒœã€‚
- æ‰€æœ‰çš„åƒµå°¸ï¼ˆæ”»å®ˆåŒæ–¹ï¼‰éƒ½å°†æœ‰ä¸€ä¸ª `winCount` å’Œä¸€ä¸ª `lossCount`ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½å°†æ ¹æ®æˆ˜æ–—ç»“æœå¢é•¿ã€‚
- è‹¥æ”»å‡»æ–¹è·èƒœï¼Œè¿™ä¸ªåƒµå°¸å°†å‡çº§å¹¶äº§ç”Ÿä¸€ä¸ªæ–°åƒµå°¸ã€‚
- å¦‚æœæ”»å‡»æ–¹å¤±è´¥ï¼Œé™¤äº†å¤±è´¥æ¬¡æ•°å°†åŠ ä¸€å¤–ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚
- æ— è®ºè¾“èµ¢ï¼Œå½“å‰åƒµå°¸çš„å†·å´æ—¶é—´éƒ½å°†è¢«æ¿€æ´»ã€‚

è¿™æœ‰ä¸€å¤§å †çš„é€»è¾‘éœ€è¦å¤„ç†ï¼Œæˆ‘ä»¬å°†æŠŠè¿™äº›æ­¥éª¤åˆ†è§£åˆ°æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­å»ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. ç»™æˆ‘ä»¬åˆçº¦ä¸€ä¸ª `uint` ç±»å‹çš„å˜é‡ï¼Œå‘½åä¸º `attackVictoryProbability`, å°†å…¶å€¼è®¾å®šä¸º `70`ã€‚
2. åˆ›å»ºä¸€ä¸ªåä¸º `attack`çš„å‡½æ•°ã€‚å®ƒå°†ä¼ å…¥ä¸¤ä¸ªå‚æ•°: `_zombieId` (`uint` ç±»å‹) ä»¥åŠ `_targetId` (ä¹Ÿæ˜¯ `uint`)ã€‚å®ƒå°†æ˜¯ä¸€ä¸ª `external` å‡½æ•°ã€‚

å‡½æ•°ä½“å…ˆç•™ç©ºå§ã€‚

``` solidity
contract ZombieBattle is ZombieHelper {

    uint randNonce = 0;
    uint attackVictoryProbability = 70;

    function randMod(uint _modulus) internal returns(uint) {
        randNonce++;
        // æ ¹æ® Solidity ç‰ˆæœ¬ï¼Œåšç›¸åº”æ›´æ–°
        return uint(keccak256(abi.encode(block.timestamp, msg.sender, randNonce))) % _modulus;
    }

    function attack(uint _zombieId, uint _targetId) external {
        
    }
}
```



#### ç¬¬6ç«  é‡æ„é€šç”¨é€»è¾‘

ä¸ç®¡è°è°ƒç”¨æˆ‘ä»¬çš„ attack å‡½æ•° -- æˆ‘ä»¬æƒ³ç¡®ä¿ç”¨æˆ·çš„ç¡®æ‹¥æœ‰ä»–ä»¬ç”¨æ¥æ”»å‡»çš„åƒµå°¸ã€‚å¦‚æœä½ èƒ½ç”¨å…¶ä»–äººçš„åƒµå°¸æ¥æ”»å‡»å°†æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å®‰å…¨é—®é¢˜ã€‚

ä½ èƒ½æƒ³ä¸€ä¸‹æˆ‘ä»¬å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ£€æŸ¥æ­¥éª¤æ¥çœ‹çœ‹è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„äººå°±æ˜¯ä»–ä»¬ä¼ å…¥çš„ _zombieID de æ‹¥æœ‰è€…ä¹ˆï¼Ÿ

æƒ³ä¸€æƒ³ï¼Œçœ‹çœ‹ä½ èƒ½ä¸èƒ½è‡ªå·±æ‰¾åˆ°ä¸€äº›ç­”æ¡ˆã€‚

èŠ±ç‚¹æ—¶é—´â€¦â€¦ å‚è€ƒæˆ‘ä»¬å‰é¢è¯¾ç¨‹çš„ä»£ç æ¥è·å¾—çµæ„Ÿã€‚

ç­”æ¡ˆåœ¨ä¸‹é¢ï¼Œåœ¨ä½ æœ‰ä¸€äº›æƒ³æ³•ä¹‹å‰ä¸è¦ç»§ç»­é˜…è¯»ã€‚

##### ç­”æ¡ˆ

æˆ‘ä»¬åœ¨å‰é¢çš„è¯¾ç¨‹é‡Œé¢å·²ç»åšè¿‡å¾ˆå¤šæ¬¡è¿™æ ·çš„æ£€æŸ¥äº†ã€‚ åœ¨ `changeName()`, `changeDna()`, å’Œ `feedAndMultiply()`é‡Œï¼Œæˆ‘ä»¬åšè¿‡è¿™æ ·çš„æ£€æŸ¥ï¼š

```solidity
require(msg.sender == zombieToOwner[_zombieId]);
```

è¿™å’Œæˆ‘ä»¬ `attack` å‡½æ•°å°†è¦ç”¨åˆ°çš„æ£€æŸ¥é€»è¾‘æ˜¯ç›¸åŒçš„ã€‚ æ­£å› æˆ‘ä»¬è¦å¤šæ¬¡è°ƒç”¨è¿™ä¸ªæ£€æŸ¥é€»è¾‘ï¼Œè®©æˆ‘ä»¬æŠŠå®ƒç§»åˆ°å®ƒè‡ªå·±çš„ `modifier` ä¸­æ¥æ¸…ç†ä»£ç å¹¶é¿å…é‡å¤ç¼–ç ã€‚

##### å®æˆ˜æ¼”ä¹ 

æˆ‘ä»¬å›åˆ°äº† `zombiefeeding.sol`ï¼Œ å› ä¸ºè¿™æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨æ£€æŸ¥é€»è¾‘çš„åœ°æ–¹ã€‚è®©æˆ‘ä»¬æŠŠå®ƒé‡æ„è¿›å®ƒè‡ªå·±çš„ `modifier`ã€‚

1. åˆ›å»ºä¸€ä¸ª `modifier`ï¼Œ å‘½åä¸º `ownerOf`ã€‚å®ƒå°†ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œ `_zombieId` (ä¸€ä¸ª `uint`)ã€‚

   å®ƒçš„å‡½æ•°ä½“åº”è¯¥ `require` `msg.sender` ç­‰äº `zombieToOwner[_zombieId]`ï¼Œ ç„¶åç»§ç»­è¿™ä¸ªå‡½æ•°å‰©ä¸‹çš„å†…å®¹ã€‚ å¦‚æœä½ å¿˜è®°äº†ä¿®é¥°ç¬¦çš„å†™æ³•ï¼Œå¯ä»¥å‚è€ƒ `zombiehelper.sol`ã€‚

2. å°†è¿™ä¸ªå‡½æ•°çš„ `feedAndMultiply` å®šä¹‰ä¿®æ”¹ä¸ºå…¶ä½¿ç”¨ä¿®é¥°ç¬¦ `ownerOf`ã€‚

3. ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ `modifier`äº†ï¼Œä½ å¯ä»¥åˆ é™¤è¿™è¡Œäº†ï¼š `require(msg.sender == zombieToOwner[_zombieId]);`

åœ¨ ZombieFeeding ä¸­ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

``` solidity
contract ZombieFeeding is ZombieFactory {

    KittyInterface kittyContract;

    // æ ¡éªŒåƒµå°¸æ‹¥æœ‰è€…
    modifier ownerOf(uint _zombieId) {
        require(msg.sender == zombieToOwner[_zombieId]);
        _;
    }
    
    // ... other code ...
    
    function feedAndMultiply(uint256 _zombieId, uint256 _targetDna, string memory _species) internal ownerOf(_zombieId) {
        Zombie storage myZombie = zombies[_zombieId];
        require(_isReady(myZombie));
        _targetDna = _targetDna % dnaModulus;
        uint256 newDna = (myZombie.dna + _targetDna) / 2;
        // è¿™é‡Œå¢åŠ ä¸€ä¸ª if è¯­å¥
        if(keccak256(abi.encode(_species)) == keccak256(abi.encode("kitty"))){
            newDna = newDna - newDna % 100 + 99;
        }
        _createZombie("NoName", newDna);
        _triggerCooldown(myZombie);
    }
}
```



#### ç¬¬7ç«  æ›´å¤šé‡æ„

åœ¨ `zombiehelper.sol`é‡Œæœ‰å‡ å¤„åœ°æ–¹ï¼Œéœ€è¦æˆ‘ä»¬å®ç°æˆ‘ä»¬æ–°çš„ `modifier`â€”â€” `ownerOf`ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. ä¿®æ”¹ `changeName()` ä½¿å…¶ä½¿ç”¨ `ownerOf`
2. ä¿®æ”¹ `changeDna()` ä½¿å…¶ä½¿ç”¨ `ownerOf`

``` solidity
// ä¿®æ”¹åƒµå°¸åå­—
function changeName(uint256 _zombieId, string calldata _newName)
    external
    aboveLevel(2, _zombieId)
    ownerOf(_zombieId)
{
    zombies[_zombieId].name = _newName;
}

// å®šåˆ¶ DNA
function changeDna(uint256 _zombieId, uint256 _newDna)
    external
    aboveLevel(20, _zombieId)
    ownerOf(_zombieId)
{
    zombies[_zombieId].dna = _newDna;
}
```



#### ç¬¬8ç«  å›åˆ°æ”»å‡»

é‡æ„å®Œæˆäº†ï¼Œå›åˆ° `zombieattack.sol`ã€‚

ç»§ç»­æ¥å®Œå–„æˆ‘ä»¬çš„ `attack` å‡½æ•°ï¼Œ ç°åœ¨æˆ‘ä»¬æœ‰äº† `ownerOf` ä¿®é¥°ç¬¦æ¥ç”¨äº†ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. å°† `ownerOf` ä¿®é¥°ç¬¦æ·»åŠ åˆ° `attack` æ¥ç¡®ä¿è°ƒç”¨è€…æ‹¥æœ‰`_zombieId`.

2. æˆ‘ä»¬çš„å‡½æ•°æ‰€éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è·å¾—ä¸€ä¸ªåŒæ–¹åƒµå°¸çš„ `storage` æŒ‡é’ˆï¼Œ è¿™æ ·æˆ‘ä»¬æ‰èƒ½å¾ˆæ–¹ä¾¿å’Œå®ƒä»¬äº¤äº’ï¼š

   a. å®šä¹‰ä¸€ä¸ª `Zombie storage` å‘½åä¸º `myZombie`ï¼Œä½¿å…¶å€¼ç­‰äº `zombies[_zombieId]`ã€‚

   b. å®šä¹‰ä¸€ä¸ª `Zombie storage` å‘½åä¸º `enemyZombie`ï¼Œ ä½¿å…¶å€¼ç­‰äº `zombies[_targetId]`ã€‚

3. æˆ‘ä»¬å°†ç”¨ä¸€ä¸ª0åˆ°100çš„éšæœºæ•°æ¥ç¡®å®šæˆ‘ä»¬çš„æˆ˜æ–—ç»“æœã€‚ å®šä¹‰ä¸€ä¸ª `uint`ï¼Œå‘½åä¸º `rand`ï¼Œ è®¾å®šå…¶å€¼ç­‰äº `randMod` å‡½æ•°çš„è¿”å›å€¼ï¼Œæ­¤å‡½æ•°ä¼ å…¥ `100`ä½œä¸ºå‚æ•°ã€‚

``` solidity
function attack(uint _zombieId, uint _targetId) external ownerOf(_zombieId) {
    // æˆ‘æ–¹åƒµå°¸
    Zombie storage myZombie = zombies[_zombieId];
    // æ”»å‡»ç›®æ ‡åƒµå°¸
    Zombie storage enemyZombie = zombies[_targetId];
    // éšæœºæ•°ç¡®å®šæˆ˜æ–—ç»“æœ
    uint rand = randMod(100);
}
```



#### ç¬¬9ç«  åƒµå°¸çš„è¾“èµ¢

å¯¹æˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆæ¥è¯´ï¼Œæˆ‘ä»¬å°†è¦è¿½è¸ªæˆ‘ä»¬çš„åƒµå°¸è¾“èµ¢äº†å¤šå°‘åœºã€‚æœ‰äº†è¿™ä¸ªæˆ‘ä»¬å¯ä»¥åœ¨æ¸¸æˆé‡Œç»´æŠ¤ä¸€ä¸ª "åƒµå°¸æ’è¡Œæ¦œ"ã€‚

æœ‰å¤šç§æ–¹æ³•åœ¨æˆ‘ä»¬çš„DAppé‡Œé¢ä¿å­˜ä¸€ä¸ªæ•°å€¼ â€” ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ˜ å°„ï¼Œä½œä¸ºä¸€ä¸ªâ€œæ’è¡Œæ¦œâ€ç»“æ„ä½“ï¼Œæˆ–è€…ä¿å­˜åœ¨ `Zombie` ç»“æ„ä½“å†…ã€‚

æ¯ä¸ªæ–¹æ³•éƒ½æœ‰å…¶ä¼˜ç¼ºç‚¹ï¼Œå–å†³äºæˆ‘ä»¬æ‰“ç®—å¦‚ä½•å’Œè¿™äº›æ•°æ®æ‰“äº¤é“ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œç®€å•èµ·è§æˆ‘ä»¬å°†è¿™ä¸ªçŠ¶æ€ä¿å­˜åœ¨ `Zombie` ç»“æ„ä½“ä¸­ï¼Œå°†å…¶å‘½åä¸º `winCount` å’Œ `lossCount`ã€‚

æˆ‘ä»¬è·³å› `zombiefactory.sol`, å°†è¿™äº›å±æ€§æ·»åŠ è¿› `Zombie` ç»“æ„ä½“.

##### å®æˆ˜æ¼”ä¹ 

1. ä¿®æ”¹ `Zombie` ç»“æ„ä½“ï¼Œæ·»åŠ ä¸¤ä¸ªå±æ€§:

   a. `winCount`, ä¸€ä¸ª `uint16`

   b. `lossCount`, ä¹Ÿæ˜¯ä¸€ä¸ª `uint16`

   > æ³¨æ„ï¼š è®°ä½, å› ä¸ºæˆ‘ä»¬èƒ½åœ¨ç»“æ„ä½“ä¸­åŒ…è£…`uint`, æˆ‘ä»¬æ‰“ç®—ç”¨é€‚åˆæˆ‘ä»¬çš„æœ€å°çš„ `uint`ã€‚ ä¸€ä¸ª `uint8` å¤ªå°äº†ï¼Œ å› ä¸º 2^8 = 256 â€”â€” å¦‚æœæˆ‘ä»¬çš„åƒµå°¸æ¯å¤©éƒ½ä½œæˆ˜ï¼Œä¸åˆ°ä¸€å¹´å°±æº¢å‡ºäº†ã€‚ä½†æ˜¯ 2^16 = 65536 ï¼ˆ`uint16`ï¼‰â€”â€” é™¤éä¸€ä¸ªåƒµå°¸è¿ç»­179å¹´æ¯å¤©ä½œæˆ˜ï¼Œå¦åˆ™æˆ‘ä»¬å°±æ˜¯å®‰å…¨çš„ã€‚

2. ç°åœ¨æˆ‘ä»¬çš„ `Zombie` ç»“æ„ä½“æœ‰äº†æ–°çš„å±æ€§ï¼Œ æˆ‘ä»¬éœ€è¦ä¿®æ”¹ `_createZombie()` ä¸­çš„å‡½æ•°å®šä¹‰ã€‚

   ä¿®æ”¹åƒµå°¸ç”Ÿæˆå®šä¹‰ï¼Œè®©æ¯ä¸ªæ–°åƒµå°¸éƒ½æœ‰ `0` èµ¢å’Œ `0` è¾“ã€‚

``` solidity
struct Zombie {
    string name;
    uint dna;
    uint32 level;
    // å†·å´å®šæ—¶å™¨ï¼Œé™åˆ¶åƒµå°¸çŒé£Ÿçš„é¢‘ç‡
    uint32 readyTime;
    uint16 winCount;
    uint16 lossCount;
}

function _createZombie(string memory _name, uint _dna) internal {
    zombies.push(Zombie(_name, _dna, 1, uint32(block.timestamp + cooldownTime), 0, 0));
    uint id = zombies.length -1;
    zombieToOwner[id] = msg.sender;
    ownerZombieCount[msg.sender]++;
    emit NewZombie(id, _name, _dna);
}
```



#### ç¬¬10ç«  åƒµå°¸èƒœåˆ©äº† ğŸ˜„

æœ‰äº† `winCount` å’Œ `lossCount`ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®åƒµå°¸å“ªä¸ªåƒµå°¸èµ¢äº†æˆ˜æ–—æ¥æ›´æ–°å®ƒä»¬äº†ã€‚

åœ¨ç¬¬å…­ç« æˆ‘ä»¬è®¡ç®—å‡ºæ¥ä¸€ä¸ª0åˆ°100çš„éšæœºæ•°ã€‚ç°åœ¨è®©æˆ‘ä»¬ç”¨é‚£ä¸ªæ•°æ¥å†³å®šé‚£è°èµ¢äº†æˆ˜æ–—ï¼Œå¹¶ä»¥æ­¤æ›´æ–°æˆ‘ä»¬çš„çŠ¶æ€ã€‚

##### å®æˆ˜æ¼”ä¹ 

1. åˆ›å»ºä¸€ä¸ª `if` è¯­å¥æ¥æ£€æŸ¥ `rand` æ˜¯ä¸æ˜¯ ***å°äºæˆ–è€…ç­‰äº\*** `attackVictoryProbability`ã€‚

2. å¦‚æœä»¥ä¸Šæ¡ä»¶ä¸º `true`ï¼Œ æˆ‘ä»¬çš„åƒµå°¸å°±èµ¢äº†ï¼æ‰€ä»¥ï¼š

   a. å¢åŠ  `myZombie` çš„ `winCount`ã€‚

   b. å¢åŠ  `myZombie` çš„ `level`ã€‚ (å‡çº§äº†å•¦!!!!!!!)

   c. å¢åŠ  `enemyZombie` çš„ `lossCount`. (è¾“å®¶!!!!!! ğŸ˜« ğŸ˜« ğŸ˜«)

   d. è¿è¡Œ `feedAndMultiply` å‡½æ•°ã€‚ åœ¨ `zombiefeeding.sol` é‡ŒæŸ¥çœ‹è°ƒç”¨å®ƒçš„è¯­å¥ã€‚ å¯¹äºç¬¬ä¸‰ä¸ªå‚æ•° (`_species`)ï¼Œä¼ å…¥å­—ç¬¦ä¸² "zombie". ï¼ˆç°åœ¨å®ƒå®é™…ä¸Šä»€ä¹ˆéƒ½ä¸åšï¼Œä¸è¿‡åœ¨ç¨åï¼Œ å¦‚æœæˆ‘ä»¬æ„¿æ„ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„æ–¹æ³•ï¼Œç”¨æ¥åˆ¶é€ åƒµå°¸å˜çš„åƒµå°¸ï¼‰ã€‚

``` solidity
function attack(uint _zombieId, uint _targetId) external ownerOf(_zombieId) {
  Zombie storage myZombie = zombies[_zombieId];
  Zombie storage enemyZombie = zombies[_targetId];
  uint rand = randMod(100);
  // åœ¨è¿™é‡Œå¼€å§‹
  if(rand <= attackVictoryProbability) {
    myZombie.winCount++;
    myZombie.level++;
    enemyZombie.lossCount++;
    feedAndMultiply(_zombieId, enemyZombie.dna, "zombie");
  }
}
```

